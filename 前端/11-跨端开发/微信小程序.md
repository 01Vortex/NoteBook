# 微信小程序完整学习笔记

> 微信小程序是一种不需要下载安装即可使用的应用，实现了"触手可及"的梦想
> 本笔记基于微信小程序原生开发，涵盖从入门到进阶的完整知识体系

---

## 目录

1. [基础概念](#1-基础概念)
2. [开发环境搭建](#2-开发环境搭建)
3. [项目结构](#3-项目结构)
4. [配置文件详解](#4-配置文件详解)
5. [WXML 模板语法](#5-wxml-模板语法)
6. [WXSS 样式](#6-wxss-样式)
7. [WXS 脚本](#7-wxs-脚本)
8. [组件系统](#8-组件系统)
9. [页面生命周期](#9-页面生命周期)
10. [路由与导航](#10-路由与导航)
11. [数据请求](#11-数据请求)
12. [数据存储](#12-数据存储)
13. [事件系统](#13-事件系统)
14. [自定义组件](#14-自定义组件)
15. [分包加载](#15-分包加载)
16. [开放能力](#16-开放能力)
17. [性能优化](#17-性能优化)
18. [常见错误与解决方案](#18-常见错误与解决方案)

---

## 1. 基础概念

### 1.1 什么是微信小程序？

微信小程序是微信推出的一种轻量级应用形态，具有以下特点：

- **无需安装**：用户扫一扫或搜一下即可打开应用
- **触手可及**：用完即走，不占用手机内存
- **体验流畅**：接近原生 App 的用户体验
- **生态丰富**：依托微信 10 亿+ 用户，获客成本低

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    微信小程序架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────┐         ┌─────────────────┐          │
│   │    视图层        │         │    逻辑层        │          │
│   │   (Webview)     │ ←─────→ │   (JsCore)      │          │
│   │                 │  Native │                 │          │
│   │  WXML + WXSS    │         │   JavaScript    │          │
│   └─────────────────┘         └─────────────────┘          │
│            │                           │                    │
│            └───────────┬───────────────┘                    │
│                        │                                    │
│                        ▼                                    │
│              ┌─────────────────┐                           │
│              │   Native 系统层  │                           │
│              │  (微信客户端)    │                           │
│              └─────────────────┘                           │
│                                                             │
│  特点：                                                      │
│  • 双线程模型：视图层和逻辑层分离                             │
│  • 通过 Native 层进行通信                                    │
│  • 视图层可以有多个 Webview                                  │
│  • 逻辑层只有一个 JsCore 线程                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 与 H5、原生 App 的对比

| 特性 | 微信小程序 | H5 网页 | 原生 App |
|------|-----------|---------|----------|
| 开发成本 | 中 | 低 | 高 |
| 用户体验 | 好 | 一般 | 最好 |
| 安装下载 | 无需 | 无需 | 需要 |
| 系统权限 | 部分 | 有限 | 完整 |
| 更新方式 | 自动 | 自动 | 手动 |
| 入口 | 微信内 | 浏览器 | 桌面图标 |
| 包大小限制 | 有（20MB） | 无 | 无 |

### 1.4 小程序的运行环境

| 运行环境 | 逻辑层 | 渲染层 |
|---------|--------|--------|
| iOS | JavaScriptCore | WKWebView |
| Android | V8 | Chromium 定制内核 |
| 开发者工具 | NWJS | Chrome WebView |

---

## 2. 开发环境搭建

### 2.1 注册小程序账号

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击"立即注册" → 选择"小程序"
3. 填写邮箱、密码等信息完成注册
4. 登录后在"开发" → "开发设置"中获取 AppID

### 2.2 安装开发者工具

1. 下载 [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 安装并使用微信扫码登录
3. 创建新项目，填入 AppID

### 2.3 创建第一个项目

```
项目配置：
├── 项目名称：my-miniprogram
├── 目录：选择一个空文件夹
├── AppID：填入你的 AppID（或使用测试号）
├── 开发模式：小程序
└── 后端服务：不使用云服务
```

### 2.4 开发者工具界面

```
┌─────────────────────────────────────────────────────────────┐
│  菜单栏  │  工具栏（编译、预览、真机调试、上传等）            │
├─────────┼───────────────────────────────────────────────────┤
│         │                                                   │
│  模拟器  │                    编辑器                         │
│         │                                                   │
│ (预览区) │              (代码编辑区)                         │
│         │                                                   │
├─────────┼───────────────────────────────────────────────────┤
│         │                                                   │
│  调试器  │              Console / Network / Storage 等       │
│         │                                                   │
└─────────┴───────────────────────────────────────────────────┘
```

---

## 3. 项目结构

### 3.1 基础目录结构

```
my-miniprogram/
├── pages/                      # 页面目录
│   ├── index/                  # 首页
│   │   ├── index.js            # 页面逻辑
│   │   ├── index.json          # 页面配置
│   │   ├── index.wxml          # 页面结构
│   │   └── index.wxss          # 页面样式
│   └── logs/                   # 日志页
│       ├── logs.js
│       ├── logs.json
│       ├── logs.wxml
│       └── logs.wxss
├── components/                 # 自定义组件目录
│   └── my-component/
│       ├── my-component.js
│       ├── my-component.json
│       ├── my-component.wxml
│       └── my-component.wxss
├── utils/                      # 工具函数目录
│   └── util.js
├── images/                     # 图片资源目录
├── app.js                      # 小程序入口文件
├── app.json                    # 小程序全局配置
├── app.wxss                    # 小程序全局样式
├── project.config.json         # 项目配置文件
└── sitemap.json                # 搜索配置
```

### 3.2 文件类型说明

| 文件类型 | 必需 | 作用 |
|---------|------|------|
| `.js` | 是 | 页面/组件的逻辑代码 |
| `.wxml` | 是 | 页面/组件的结构模板 |
| `.wxss` | 否 | 页面/组件的样式 |
| `.json` | 否 | 页面/组件的配置 |

### 3.3 页面文件示例

```javascript
// pages/index/index.js
Page({
  // 页面的初始数据
  data: {
    message: 'Hello World',
    list: [],
    loading: false
  },

  // 生命周期函数--监听页面加载
  onLoad(options) {
    console.log('页面加载，参数：', options)
    this.loadData()
  },

  // 生命周期函数--监听页面显示
  onShow() {
    console.log('页面显示')
  },

  // 自定义方法
  loadData() {
    this.setData({ loading: true })
    // 加载数据...
  },

  // 事件处理函数
  handleTap(e) {
    console.log('点击事件', e)
  }
})
```

```html
<!-- pages/index/index.wxml -->
<view class="container">
  <text class="title">{{ message }}</text>
  
  <view wx:if="{{ loading }}">
    <text>加载中...</text>
  </view>
  
  <view wx:else>
    <view wx:for="{{ list }}" wx:key="id" class="item">
      <text>{{ item.name }}</text>
    </view>
  </view>
  
  <button bindtap="handleTap">点击我</button>
</view>
```

```css
/* pages/index/index.wxss */
.container {
  padding: 20rpx;
}

.title {
  font-size: 36rpx;
  color: #333;
  font-weight: bold;
}

.item {
  padding: 20rpx;
  border-bottom: 1rpx solid #eee;
}
```

```json
// pages/index/index.json
{
  "navigationBarTitleText": "首页",
  "enablePullDownRefresh": true,
  "usingComponents": {
    "my-component": "/components/my-component/my-component"
  }
}
```

---

## 4. 配置文件详解

### 4.1 app.json 全局配置

```json
{
  // 页面路径列表（第一个为首页）
  "pages": [
    "pages/index/index",
    "pages/logs/logs",
    "pages/user/user"
  ],
  
  // 全局窗口配置
  "window": {
    "navigationBarBackgroundColor": "#ffffff",
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "我的小程序",
    "backgroundColor": "#eeeeee",
    "backgroundTextStyle": "dark",
    "enablePullDownRefresh": false,
    "onReachBottomDistance": 50
  },
  
  // tabBar 配置
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#07c160",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "position": "bottom",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/tab/home.png",
        "selectedIconPath": "images/tab/home-active.png"
      },
      {
        "pagePath": "pages/user/user",
        "text": "我的",
        "iconPath": "images/tab/user.png",
        "selectedIconPath": "images/tab/user-active.png"
      }
    ]
  },
  
  // 网络超时配置
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000,
    "uploadFile": 10000,
    "connectSocket": 10000
  },
  
  // 调试模式
  "debug": false,
  
  // 分包配置
  "subpackages": [
    {
      "root": "packageA",
      "pages": [
        "pages/detail/detail"
      ]
    }
  ],
  
  // 分包预下载
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["packageA"]
    }
  },
  
  // 权限配置
  "permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于小程序位置接口的效果展示"
    }
  },
  
  // 使用的插件
  "plugins": {},
  
  // 全局自定义组件
  "usingComponents": {
    "van-button": "@vant/weapp/button/index"
  },
  
  // 样式版本
  "style": "v2",
  
  // 指定使用的基础库版本
  "libVersion": "2.25.0",
  
  // 单页模式
  "singlePage": {},
  
  // 懒加载
  "lazyCodeLoading": "requiredComponents"
}
```

### 4.2 页面配置（page.json）

```json
{
  // 导航栏标题
  "navigationBarTitleText": "页面标题",
  
  // 导航栏背景色
  "navigationBarBackgroundColor": "#ffffff",
  
  // 导航栏标题颜色（仅支持 black/white）
  "navigationBarTextStyle": "black",
  
  // 自定义导航栏
  "navigationStyle": "custom",
  
  // 窗口背景色
  "backgroundColor": "#eeeeee",
  
  // 下拉 loading 样式（仅支持 dark/light）
  "backgroundTextStyle": "dark",
  
  // 是否开启下拉刷新
  "enablePullDownRefresh": true,
  
  // 触底距离
  "onReachBottomDistance": 50,
  
  // 禁止页面滚动
  "disableScroll": false,
  
  // 页面使用的组件
  "usingComponents": {
    "my-component": "/components/my-component/my-component"
  },
  
  // 初始渲染缓存
  "initialRenderingCache": "static"
}
```

### 4.3 project.config.json 项目配置

```json
{
  "description": "项目配置文件",
  "packOptions": {
    "ignore": [
      { "type": "file", "value": ".eslintrc.js" },
      { "type": "folder", "value": "node_modules" }
    ]
  },
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": true,
    "coverView": true,
    "nodeModules": true,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": true,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    }
  },
  "compileType": "miniprogram",
  "libVersion": "2.25.0",
  "appid": "wx1234567890",
  "projectname": "my-miniprogram",
  "condition": {}
}
```

---

## 5. WXML 模板语法

### 5.1 数据绑定

```html
<!-- 基础绑定 -->
<view>{{ message }}</view>

<!-- 属性绑定 -->
<view id="item-{{ id }}">内容</view>
<view class="{{ isActive ? 'active' : '' }}">内容</view>
<view style="color: {{ color }};">内容</view>
<view hidden="{{ isHidden }}">内容</view>

<!-- 布尔值属性 -->
<checkbox checked="{{ isChecked }}"></checkbox>

<!-- 表达式 -->
<view>{{ a + b }}</view>
<view>{{ flag ? '是' : '否' }}</view>
<view>{{ list.length }}</view>
<view>{{ obj.name }}</view>

<!-- 字符串拼接 -->
<view>Hello, {{ name }}!</view>

<!-- 数组下标 -->
<view>{{ list[0] }}</view>

<!-- 对象属性 -->
<view>{{ user.name }}</view>
```

```javascript
// 对应的 JS 数据
Page({
  data: {
    message: 'Hello',
    id: 1,
    isActive: true,
    color: 'red',
    isHidden: false,
    isChecked: true,
    a: 1,
    b: 2,
    flag: true,
    list: ['item1', 'item2'],
    obj: { name: '张三' },
    name: 'World',
    user: { name: '李四' }
  }
})
```

### 5.2 条件渲染

```html
<!-- wx:if 条件渲染 -->
<view wx:if="{{ score >= 90 }}">优秀</view>
<view wx:elif="{{ score >= 60 }}">及格</view>
<view wx:else>不及格</view>

<!-- block 包装元素（不会渲染） -->
<block wx:if="{{ isShow }}">
  <view>内容1</view>
  <view>内容2</view>
</block>

<!-- hidden 属性（始终渲染，只是隐藏） -->
<view hidden="{{ isHidden }}">内容</view>

<!--
  wx:if vs hidden 的区别：
  - wx:if：条件为 false 时不渲染，切换开销大
  - hidden：始终渲染，只是显示/隐藏，初始开销大
  
  使用建议：
  - 频繁切换用 hidden
  - 条件很少改变用 wx:if
-->
```

### 5.3 列表渲染

```html
<!-- 基础列表渲染 -->
<view wx:for="{{ list }}" wx:key="id">
  {{ index }}: {{ item.name }}
</view>

<!-- 自定义变量名 -->
<view wx:for="{{ list }}" wx:for-index="idx" wx:for-item="obj" wx:key="id">
  {{ idx }}: {{ obj.name }}
</view>

<!-- 嵌套循环 -->
<view wx:for="{{ matrix }}" wx:for-item="row" wx:key="rowIndex">
  <view wx:for="{{ row }}" wx:for-item="col" wx:key="colIndex">
    {{ col }}
  </view>
</view>

<!-- 使用 block 包装 -->
<block wx:for="{{ list }}" wx:key="id">
  <view>{{ item.title }}</view>
  <view>{{ item.content }}</view>
</block>

<!-- wx:key 的使用 -->
<!-- 1. 使用唯一字段名 -->
<view wx:for="{{ list }}" wx:key="id">{{ item.name }}</view>

<!-- 2. 使用 *this（当 item 本身是唯一字符串或数字） -->
<view wx:for="{{ ['a', 'b', 'c'] }}" wx:key="*this">{{ item }}</view>

<!-- 3. 使用 index（不推荐，可能导致性能问题） -->
<view wx:for="{{ list }}" wx:key="index">{{ item.name }}</view>
```

### 5.4 模板

```html
<!-- 定义模板 -->
<template name="userCard">
  <view class="user-card">
    <image src="{{ avatar }}"></image>
    <text>{{ name }}</text>
    <text>{{ age }}岁</text>
  </view>
</template>

<!-- 使用模板 -->
<template is="userCard" data="{{ ...user }}"></template>

<!-- 动态模板名 -->
<template is="{{ templateName }}" data="{{ ...data }}"></template>

<!-- 模板文件导入 -->
<!-- templates/user.wxml -->
<template name="userItem">
  <view>{{ name }}</view>
</template>

<!-- 在页面中导入 -->
<import src="/templates/user.wxml" />
<template is="userItem" data="{{ name: '张三' }}"></template>

<!-- include 引入（引入除 template 和 wxs 外的所有代码） -->
<include src="/templates/header.wxml" />
<view>页面内容</view>
<include src="/templates/footer.wxml" />
```

### 5.5 引用

```html
<!-- import 引入模板 -->
<import src="item.wxml"/>
<template is="item" data="{{text: 'forbar'}}"/>

<!-- include 引入代码片段 -->
<include src="header.wxml"/>
<view>body</view>
<include src="footer.wxml"/>

<!--
  import vs include 的区别：
  - import：只能引入 template 定义的模板
  - include：引入除 template 和 wxs 外的所有代码
-->
```


---

## 6. WXSS 样式

### 6.1 尺寸单位

```css
/* rpx - 响应式像素 */
/* 规定屏幕宽度为 750rpx */
/* iPhone 6: 1rpx = 0.5px, 1px = 2rpx */

.container {
  /* 推荐使用 rpx */
  width: 750rpx;      /* 满屏宽度 */
  padding: 20rpx;
  font-size: 28rpx;   /* 约 14px */
  
  /* 也可以使用 px */
  border: 1px solid #eee;
  
  /* 百分比 */
  width: 100%;
  
  /* vh/vw（部分支持） */
  height: 100vh;
}

/* 常用尺寸对照（基于 750rpx 设计稿）
 * 12px = 24rpx
 * 14px = 28rpx
 * 16px = 32rpx
 * 18px = 36rpx
 * 20px = 40rpx
 */
```

### 6.2 样式导入

```css
/* 使用 @import 导入外部样式 */
@import "common.wxss";
@import "/styles/variables.wxss";

.container {
  padding: 20rpx;
}
```

### 6.3 选择器支持

```css
/* 支持的选择器 */
.class { }           /* 类选择器 */
#id { }              /* ID 选择器 */
element { }          /* 元素选择器 */
element, element { } /* 并集选择器 */
::after { }          /* 伪元素 */
::before { }         /* 伪元素 */

/* 不支持的选择器 */
/* * { }             通配符选择器 */
/* element > element 子选择器（部分支持） */
/* element + element 相邻选择器 */
/* [attribute]       属性选择器 */
```

### 6.4 全局样式与局部样式

```css
/* app.wxss - 全局样式 */
page {
  background-color: #f5f5f5;
  font-size: 28rpx;
  color: #333;
}

.container {
  padding: 20rpx;
}

/* 页面 wxss - 局部样式（会覆盖全局样式） */
.container {
  padding: 30rpx;  /* 覆盖全局样式 */
}
```

### 6.5 Flex 布局

```css
/* 水平排列 */
.row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

/* 垂直排列 */
.column {
  display: flex;
  flex-direction: column;
}

/* 居中 */
.center {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* 换行 */
.wrap {
  display: flex;
  flex-wrap: wrap;
}

/* 子元素等分 */
.flex-item {
  flex: 1;
}

/* 固定宽度 */
.fixed-item {
  flex: none;
  width: 200rpx;
}
```

### 6.6 常用样式技巧

```css
/* 1. 文本省略 */
.ellipsis {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* 多行省略 */
.ellipsis-2 {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
}

/* 2. 1px 边框（解决高清屏问题） */
.border-bottom {
  position: relative;
}
.border-bottom::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 1px;
  background-color: #eee;
  transform: scaleY(0.5);
}

/* 3. 安全区域适配 */
.safe-area-bottom {
  padding-bottom: constant(safe-area-inset-bottom);
  padding-bottom: env(safe-area-inset-bottom);
}

/* 4. 禁止文本选中 */
.no-select {
  user-select: none;
  -webkit-user-select: none;
}

/* 5. 点击态 */
.clickable {
  position: relative;
}
.clickable::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.1);
  opacity: 0;
}
.clickable:active::after {
  opacity: 1;
}
```

---

## 7. WXS 脚本

### 7.1 什么是 WXS？

WXS（WeiXin Script）是小程序的一套脚本语言，用于在 WXML 中进行数据处理。它的特点是：

- 运行在视图层，不会阻塞逻辑层
- 语法类似 JavaScript，但有一些限制
- 适合做数据格式化、过滤等操作

### 7.2 基础语法

```html
<!-- 内联 WXS -->
<wxs module="utils">
  // 格式化价格
  function formatPrice(price) {
    return '¥' + (price / 100).toFixed(2)
  }
  
  // 格式化时间
  function formatTime(timestamp) {
    var date = getDate(timestamp)
    var year = date.getFullYear()
    var month = date.getMonth() + 1
    var day = date.getDate()
    return year + '-' + padZero(month) + '-' + padZero(day)
  }
  
  function padZero(num) {
    return num < 10 ? '0' + num : '' + num
  }
  
  // 导出
  module.exports = {
    formatPrice: formatPrice,
    formatTime: formatTime
  }
</wxs>

<!-- 使用 WXS -->
<view>{{ utils.formatPrice(price) }}</view>
<view>{{ utils.formatTime(timestamp) }}</view>
```

### 7.3 外部 WXS 文件

```javascript
// utils/format.wxs
function formatPrice(price) {
  return '¥' + (price / 100).toFixed(2)
}

function formatNumber(num) {
  if (num >= 10000) {
    return (num / 10000).toFixed(1) + 'w'
  }
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'k'
  }
  return num + ''
}

function truncate(str, length) {
  if (!str) return ''
  if (str.length <= length) return str
  return str.substring(0, length) + '...'
}

module.exports = {
  formatPrice: formatPrice,
  formatNumber: formatNumber,
  truncate: truncate
}
```

```html
<!-- 引入外部 WXS -->
<wxs src="../../utils/format.wxs" module="format" />

<view>{{ format.formatPrice(9900) }}</view>
<view>{{ format.formatNumber(12345) }}</view>
<view>{{ format.truncate(title, 10) }}</view>
```

### 7.4 WXS 的限制

```javascript
// WXS 不支持的特性：
// 1. 不能使用 ES6+ 语法（let, const, 箭头函数等）
// 2. 不能调用小程序 API
// 3. 不能调用 Page/Component 中的方法
// 4. 只能使用 getDate(), getRegExp() 创建对象

// ❌ 错误写法
const a = 1
let b = 2
const fn = () => {}

// ✅ 正确写法
var a = 1
var b = 2
function fn() {}

// 创建日期对象
var date = getDate()  // 当前时间
var date2 = getDate(1609459200000)  // 指定时间戳

// 创建正则对象
var reg = getRegExp('\\d+', 'g')
```

### 7.5 WXS 响应事件

```html
<!-- WXS 可以响应事件，实现高性能交互 -->
<wxs module="bindHandler">
  function bindTouchMove(event, ownerInstance) {
    // event: 事件对象
    // ownerInstance: 组件实例
    
    var touch = event.touches[0]
    var x = touch.pageX
    var y = touch.pageY
    
    // 修改组件样式
    ownerInstance.selectComponent('.box').setStyle({
      left: x + 'px',
      top: y + 'px'
    })
    
    return false  // 阻止事件冒泡
  }
  
  module.exports = {
    bindTouchMove: bindTouchMove
  }
</wxs>

<view 
  class="container"
  bindtouchmove="{{ bindHandler.bindTouchMove }}"
>
  <view class="box"></view>
</view>
```

---

## 8. 组件系统

### 8.1 内置组件分类

```
视图容器：view, scroll-view, swiper, movable-view, cover-view
基础内容：icon, text, rich-text, progress
表单组件：button, checkbox, form, input, label, picker, radio, slider, switch, textarea
导航组件：navigator
媒体组件：audio, camera, image, live-player, live-pusher, video
地图组件：map
画布组件：canvas
开放能力：open-data, web-view, ad
```

### 8.2 常用组件示例

```html
<!-- view 视图容器 -->
<view class="container" hover-class="hover" hover-stay-time="100">
  内容
</view>

<!-- scroll-view 可滚动视图 -->
<scroll-view 
  scroll-y
  style="height: 500rpx;"
  scroll-top="{{ scrollTop }}"
  bindscroll="onScroll"
  bindscrolltolower="onReachBottom"
  refresher-enabled
  refresher-triggered="{{ isRefreshing }}"
  bindrefresherrefresh="onRefresh"
>
  <view wx:for="{{ list }}" wx:key="id">{{ item.name }}</view>
</scroll-view>

<!-- swiper 轮播图 -->
<swiper 
  indicator-dots
  autoplay
  interval="3000"
  circular
  bindchange="onSwiperChange"
>
  <swiper-item wx:for="{{ banners }}" wx:key="id">
    <image src="{{ item.image }}" mode="aspectFill"></image>
  </swiper-item>
</swiper>

<!-- image 图片 -->
<image 
  src="{{ imageUrl }}"
  mode="aspectFill"
  lazy-load
  show-menu-by-longpress
  binderror="onImageError"
  bindload="onImageLoad"
></image>

<!-- input 输入框 -->
<input 
  type="text"
  value="{{ inputValue }}"
  placeholder="请输入"
  maxlength="20"
  focus="{{ isFocus }}"
  bindinput="onInput"
  bindfocus="onFocus"
  bindblur="onBlur"
  bindconfirm="onConfirm"
/>

<!-- textarea 多行输入 -->
<textarea 
  value="{{ content }}"
  placeholder="请输入内容"
  maxlength="500"
  auto-height
  show-confirm-bar="{{ false }}"
  bindinput="onTextareaInput"
></textarea>

<!-- button 按钮 -->
<button type="primary" size="default" bindtap="onTap">主要按钮</button>
<button type="default" plain>次要按钮</button>
<button type="warn" disabled="{{ isDisabled }}">警告按钮</button>
<button loading="{{ isLoading }}">加载中</button>
<button open-type="share">分享</button>
<button open-type="getUserInfo" bindgetuserinfo="onGetUserInfo">获取用户信息</button>
<button open-type="getPhoneNumber" bindgetphonenumber="onGetPhoneNumber">获取手机号</button>

<!-- picker 选择器 -->
<picker 
  mode="selector"
  range="{{ cityList }}"
  value="{{ cityIndex }}"
  bindchange="onCityChange"
>
  <view>当前选择：{{ cityList[cityIndex] }}</view>
</picker>

<picker 
  mode="date"
  value="{{ date }}"
  start="2020-01-01"
  end="2030-12-31"
  bindchange="onDateChange"
>
  <view>日期：{{ date }}</view>
</picker>

<picker 
  mode="time"
  value="{{ time }}"
  bindchange="onTimeChange"
>
  <view>时间：{{ time }}</view>
</picker>

<!-- navigator 导航 -->
<navigator url="/pages/detail/detail?id=123" open-type="navigate">
  跳转详情
</navigator>
<navigator url="/pages/index/index" open-type="switchTab">
  切换 Tab
</navigator>
<navigator open-type="navigateBack" delta="1">
  返回
</navigator>
```

### 8.3 image 的 mode 属性

```html
<!--
  缩放模式：
  - scaleToFill: 不保持比例缩放，填满容器（默认，可能变形）
  - aspectFit: 保持比例缩放，完整显示（可能有空白）
  - aspectFill: 保持比例缩放，填满容器（可能裁剪）
  - widthFix: 宽度不变，高度自动变化
  - heightFix: 高度不变，宽度自动变化
  
  裁剪模式：
  - top, bottom, left, right, center
  - top left, top right, bottom left, bottom right
-->

<image src="{{ url }}" mode="aspectFill"></image>
<image src="{{ url }}" mode="widthFix"></image>
```

### 8.4 表单组件

```html
<form bindsubmit="onSubmit" bindreset="onReset">
  <!-- 输入框 -->
  <view class="form-item">
    <text>用户名</text>
    <input name="username" placeholder="请输入用户名" />
  </view>
  
  <!-- 单选 -->
  <view class="form-item">
    <text>性别</text>
    <radio-group name="gender">
      <label><radio value="male" checked />男</label>
      <label><radio value="female" />女</label>
    </radio-group>
  </view>
  
  <!-- 多选 -->
  <view class="form-item">
    <text>爱好</text>
    <checkbox-group name="hobbies">
      <label><checkbox value="reading" />阅读</label>
      <label><checkbox value="sports" />运动</label>
      <label><checkbox value="music" />音乐</label>
    </checkbox-group>
  </view>
  
  <!-- 开关 -->
  <view class="form-item">
    <text>接收通知</text>
    <switch name="notify" checked />
  </view>
  
  <!-- 滑块 -->
  <view class="form-item">
    <text>音量</text>
    <slider name="volume" value="50" min="0" max="100" show-value />
  </view>
  
  <!-- 按钮 -->
  <button form-type="submit" type="primary">提交</button>
  <button form-type="reset">重置</button>
</form>
```

```javascript
Page({
  onSubmit(e) {
    console.log('表单数据:', e.detail.value)
    // { username: '', gender: 'male', hobbies: ['reading'], notify: true, volume: 50 }
  },
  
  onReset() {
    console.log('表单已重置')
  }
})
```


---

## 9. 页面生命周期

### 9.1 App 生命周期

```javascript
// app.js
App({
  // 小程序初始化完成时触发（全局只触发一次）
  onLaunch(options) {
    console.log('App Launch')
    console.log('启动参数:', options)
    // options.scene: 场景值
    // options.query: 启动参数
    // options.path: 启动路径
    
    // 常见操作：
    // 1. 获取用户登录状态
    // 2. 获取系统信息
    // 3. 初始化全局数据
  },
  
  // 小程序启动或从后台进入前台时触发
  onShow(options) {
    console.log('App Show')
    console.log('场景值:', options.scene)
    
    // 常见操作：
    // 1. 刷新数据
    // 2. 恢复音视频播放
  },
  
  // 小程序从前台进入后台时触发
  onHide() {
    console.log('App Hide')
    
    // 常见操作：
    // 1. 暂停音视频
    // 2. 保存草稿
  },
  
  // 小程序发生脚本错误或 API 调用失败时触发
  onError(error) {
    console.error('App Error:', error)
    
    // 上报错误到服务器
  },
  
  // 小程序要打开的页面不存在时触发
  onPageNotFound(options) {
    console.log('Page Not Found:', options.path)
    
    // 重定向到首页
    wx.switchTab({ url: '/pages/index/index' })
  },
  
  // 未处理的 Promise 拒绝事件
  onUnhandledRejection(options) {
    console.error('Unhandled Rejection:', options.reason)
  },
  
  // 全局数据
  globalData: {
    userInfo: null,
    systemInfo: null
  }
})
```

### 9.2 Page 生命周期

```javascript
// pages/index/index.js
Page({
  data: {
    message: 'Hello'
  },
  
  // 页面加载时触发（只触发一次）
  onLoad(options) {
    console.log('页面加载，参数:', options)
    // options: 页面路由参数
    
    // 常见操作：
    // 1. 获取路由参数
    // 2. 初始化页面数据
    // 3. 发起网络请求
  },
  
  // 页面显示时触发（每次显示都会触发）
  onShow() {
    console.log('页面显示')
    
    // 常见操作：
    // 1. 刷新数据
    // 2. 恢复定时器
  },
  
  // 页面初次渲染完成时触发（只触发一次）
  onReady() {
    console.log('页面渲染完成')
    
    // 常见操作：
    // 1. 获取节点信息
    // 2. 操作 canvas
    // 3. 创建动画
  },
  
  // 页面隐藏时触发
  onHide() {
    console.log('页面隐藏')
    
    // 常见操作：
    // 1. 清除定时器
    // 2. 暂停音视频
  },
  
  // 页面卸载时触发
  onUnload() {
    console.log('页面卸载')
    
    // 常见操作：
    // 1. 清除定时器
    // 2. 取消网络请求
    // 3. 清理资源
  },
  
  // 下拉刷新
  onPullDownRefresh() {
    console.log('下拉刷新')
    
    // 刷新数据后停止下拉刷新
    this.loadData().then(() => {
      wx.stopPullDownRefresh()
    })
  },
  
  // 上拉触底
  onReachBottom() {
    console.log('触底加载')
    
    // 加载更多数据
    this.loadMore()
  },
  
  // 页面滚动
  onPageScroll(options) {
    console.log('滚动位置:', options.scrollTop)
  },
  
  // 用户点击右上角分享
  onShareAppMessage(options) {
    // options.from: 'button' 或 'menu'
    // options.target: 如果 from 是 button，则为触发分享的按钮
    
    return {
      title: '分享标题',
      path: '/pages/index/index?id=123',
      imageUrl: '/images/share.png'
    }
  },
  
  // 用户点击右上角分享到朋友圈
  onShareTimeline() {
    return {
      title: '分享标题',
      query: 'id=123',
      imageUrl: '/images/share.png'
    }
  },
  
  // 用户点击右上角收藏
  onAddToFavorites(options) {
    return {
      title: '收藏标题',
      imageUrl: '/images/favorite.png',
      query: 'id=123'
    }
  },
  
  // 页面尺寸变化时触发
  onResize(options) {
    console.log('页面尺寸变化:', options.size)
  },
  
  // 点击 tabBar 时触发
  onTabItemTap(options) {
    console.log('点击 tabBar:', options)
    // options.index: tabBar 索引
    // options.pagePath: 页面路径
    // options.text: tabBar 文字
  }
})
```

### 9.3 生命周期执行顺序

```
小程序启动：
App.onLaunch → App.onShow → Page.onLoad → Page.onShow → Page.onReady

页面跳转（A → B）：
Page A.onHide → Page B.onLoad → Page B.onShow → Page B.onReady

页面返回（B → A）：
Page B.onUnload → Page A.onShow

切换到后台：
Page.onHide → App.onHide

切换到前台：
App.onShow → Page.onShow

关闭小程序：
Page.onUnload → App.onHide
```

### 9.4 生命周期图示

```
┌─────────────────────────────────────────────────────────────┐
│                    页面生命周期                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌──────────┐                                            │
│    │  onLoad  │ ← 页面加载（获取参数、初始化数据）            │
│    └────┬─────┘                                            │
│         │                                                   │
│         ▼                                                   │
│    ┌──────────┐                                            │
│    │  onShow  │ ← 页面显示（每次显示都触发）                 │
│    └────┬─────┘                                            │
│         │                                                   │
│         ▼                                                   │
│    ┌──────────┐                                            │
│    │ onReady  │ ← 页面渲染完成（可操作 DOM）                 │
│    └────┬─────┘                                            │
│         │                                                   │
│         ▼                                                   │
│    ┌──────────┐     ┌──────────┐                          │
│    │  onHide  │ ←→  │  onShow  │  ← 页面切换               │
│    └────┬─────┘     └──────────┘                          │
│         │                                                   │
│         ▼                                                   │
│    ┌──────────┐                                            │
│    │ onUnload │ ← 页面卸载（清理资源）                       │
│    └──────────┘                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. 路由与导航

### 10.1 路由跳转方式

```javascript
// 1. navigateTo - 保留当前页面，跳转到新页面（可返回）
wx.navigateTo({
  url: '/pages/detail/detail?id=123&name=test',
  success: (res) => {
    // 通过 eventChannel 向被打开页面传送数据
    res.eventChannel.emit('acceptData', { data: 'test' })
  },
  fail: (err) => {
    console.error('跳转失败:', err)
  }
})

// 2. redirectTo - 关闭当前页面，跳转到新页面（不可返回）
wx.redirectTo({
  url: '/pages/result/result'
})

// 3. switchTab - 跳转到 tabBar 页面（关闭其他非 tabBar 页面）
wx.switchTab({
  url: '/pages/index/index'
})

// 4. reLaunch - 关闭所有页面，打开新页面
wx.reLaunch({
  url: '/pages/index/index'
})

// 5. navigateBack - 返回上一页或多级页面
wx.navigateBack({
  delta: 1  // 返回的页面数，默认 1
})
```

### 10.2 接收路由参数

```javascript
// pages/detail/detail.js
Page({
  data: {
    id: '',
    name: ''
  },
  
  onLoad(options) {
    // 方式1：通过 options 获取参数
    console.log('id:', options.id)
    console.log('name:', options.name)
    
    this.setData({
      id: options.id,
      name: options.name
    })
    
    // 方式2：通过 eventChannel 接收数据
    const eventChannel = this.getOpenerEventChannel()
    eventChannel.on('acceptData', (data) => {
      console.log('接收到的数据:', data)
    })
  }
})
```

### 10.3 页面间通信

```javascript
// 方式1：使用 eventChannel（推荐）
// 页面 A
wx.navigateTo({
  url: '/pages/b/b',
  events: {
    // 监听被打开页面发送的事件
    someEvent: (data) => {
      console.log('收到页面 B 的数据:', data)
    }
  },
  success: (res) => {
    // 向被打开页面发送数据
    res.eventChannel.emit('acceptData', { data: 'from A' })
  }
})

// 页面 B
Page({
  onLoad() {
    const eventChannel = this.getOpenerEventChannel()
    
    // 接收页面 A 的数据
    eventChannel.on('acceptData', (data) => {
      console.log('收到页面 A 的数据:', data)
    })
    
    // 向页面 A 发送数据
    eventChannel.emit('someEvent', { data: 'from B' })
  }
})

// 方式2：使用全局数据
// app.js
App({
  globalData: {
    sharedData: null
  }
})

// 页面 A
const app = getApp()
app.globalData.sharedData = { key: 'value' }

// 页面 B
const app = getApp()
console.log(app.globalData.sharedData)

// 方式3：使用本地存储
// 页面 A
wx.setStorageSync('sharedData', { key: 'value' })

// 页面 B
const data = wx.getStorageSync('sharedData')

// 方式4：获取页面栈
const pages = getCurrentPages()
const prevPage = pages[pages.length - 2]  // 上一个页面
prevPage.setData({ key: 'value' })  // 修改上一页数据
```

### 10.4 navigator 组件

```html
<!-- 基础跳转 -->
<navigator url="/pages/detail/detail?id=123">
  跳转详情
</navigator>

<!-- 不同跳转类型 -->
<navigator url="/pages/detail/detail" open-type="navigate">
  navigate（默认）
</navigator>

<navigator url="/pages/detail/detail" open-type="redirect">
  redirect
</navigator>

<navigator url="/pages/index/index" open-type="switchTab">
  switchTab
</navigator>

<navigator url="/pages/index/index" open-type="reLaunch">
  reLaunch
</navigator>

<navigator open-type="navigateBack" delta="1">
  返回
</navigator>

<!-- 悬浮效果 -->
<navigator 
  url="/pages/detail/detail"
  hover-class="navigator-hover"
  hover-stay-time="100"
>
  带悬浮效果
</navigator>
```

---

## 11. 数据请求

### 11.1 基础请求

```javascript
// 基础用法
wx.request({
  url: 'https://api.example.com/users',
  method: 'GET',
  data: {
    page: 1,
    pageSize: 10
  },
  header: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token'
  },
  success: (res) => {
    console.log('请求成功:', res.data)
    console.log('状态码:', res.statusCode)
  },
  fail: (err) => {
    console.error('请求失败:', err)
  },
  complete: () => {
    console.log('请求完成')
  }
})

// POST 请求
wx.request({
  url: 'https://api.example.com/login',
  method: 'POST',
  data: {
    username: 'admin',
    password: '123456'
  },
  header: {
    'Content-Type': 'application/json'
  },
  success: (res) => {
    if (res.statusCode === 200) {
      console.log('登录成功:', res.data)
    }
  }
})
```

### 11.2 Promise 封装

```javascript
// utils/request.js
const BASE_URL = 'https://api.example.com'

// 请求封装
const request = (options) => {
  return new Promise((resolve, reject) => {
    // 显示加载
    if (options.loading !== false) {
      wx.showLoading({ title: '加载中...' })
    }
    
    // 获取 token
    const token = wx.getStorageSync('token')
    
    wx.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      success: (res) => {
        if (res.statusCode === 200) {
          // 业务状态码判断
          if (res.data.code === 0) {
            resolve(res.data.data)
          } else if (res.data.code === 401) {
            // token 过期
            wx.removeStorageSync('token')
            wx.reLaunch({ url: '/pages/login/login' })
            reject(new Error('登录已过期'))
          } else {
            wx.showToast({
              title: res.data.message || '请求失败',
              icon: 'none'
            })
            reject(new Error(res.data.message))
          }
        } else {
          reject(new Error(`请求失败: ${res.statusCode}`))
        }
      },
      fail: (err) => {
        wx.showToast({
          title: '网络请求失败',
          icon: 'none'
        })
        reject(err)
      },
      complete: () => {
        if (options.loading !== false) {
          wx.hideLoading()
        }
      }
    })
  })
}

// 快捷方法
const get = (url, data, options = {}) => {
  return request({ url, method: 'GET', data, ...options })
}

const post = (url, data, options = {}) => {
  return request({ url, method: 'POST', data, ...options })
}

const put = (url, data, options = {}) => {
  return request({ url, method: 'PUT', data, ...options })
}

const del = (url, data, options = {}) => {
  return request({ url, method: 'DELETE', data, ...options })
}

module.exports = {
  request,
  get,
  post,
  put,
  del
}
```

### 11.3 API 模块化

```javascript
// api/user.js
const { get, post } = require('../utils/request')

// 用户登录
const login = (data) => {
  return post('/user/login', data)
}

// 获取用户信息
const getUserInfo = () => {
  return get('/user/info')
}

// 更新用户信息
const updateUserInfo = (data) => {
  return post('/user/update', data)
}

module.exports = {
  login,
  getUserInfo,
  updateUserInfo
}
```

```javascript
// 在页面中使用
const userApi = require('../../api/user')

Page({
  data: {
    userInfo: null
  },
  
  async onLoad() {
    try {
      const userInfo = await userApi.getUserInfo()
      this.setData({ userInfo })
    } catch (error) {
      console.error('获取用户信息失败:', error)
    }
  }
})
```

### 11.4 文件上传

```javascript
// 选择并上传图片
const uploadImage = () => {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      const tempFilePath = res.tempFilePaths[0]
      
      wx.uploadFile({
        url: 'https://api.example.com/upload',
        filePath: tempFilePath,
        name: 'file',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        formData: {
          type: 'image'
        },
        success: (res) => {
          const data = JSON.parse(res.data)
          console.log('上传成功:', data.url)
        },
        fail: (err) => {
          console.error('上传失败:', err)
        }
      })
    }
  })
}

// 上传进度监听
const uploadTask = wx.uploadFile({
  url: 'https://api.example.com/upload',
  filePath: tempFilePath,
  name: 'file',
  success: (res) => {
    console.log('上传成功')
  }
})

uploadTask.onProgressUpdate((res) => {
  console.log('上传进度:', res.progress)
  console.log('已上传:', res.totalBytesSent)
  console.log('总大小:', res.totalBytesExpectedToSend)
})
```

### 11.5 文件下载

```javascript
// 下载文件
wx.downloadFile({
  url: 'https://example.com/file.pdf',
  success: (res) => {
    if (res.statusCode === 200) {
      // 保存到本地
      wx.saveFile({
        tempFilePath: res.tempFilePath,
        success: (saveRes) => {
          console.log('保存成功:', saveRes.savedFilePath)
        }
      })
      
      // 或打开文件
      wx.openDocument({
        filePath: res.tempFilePath,
        success: () => {
          console.log('打开成功')
        }
      })
    }
  }
})
```


---

## 12. 数据存储

### 12.1 本地存储

```javascript
// 同步存储
wx.setStorageSync('key', 'value')
wx.setStorageSync('user', { name: '张三', age: 18 })

// 同步读取
const value = wx.getStorageSync('key')
const user = wx.getStorageSync('user')

// 同步删除
wx.removeStorageSync('key')

// 清空所有存储
wx.clearStorageSync()

// 获取存储信息
const info = wx.getStorageInfoSync()
console.log('当前存储的 key:', info.keys)
console.log('当前占用空间:', info.currentSize, 'KB')
console.log('限制空间:', info.limitSize, 'KB')

// 异步存储
wx.setStorage({
  key: 'user',
  data: { name: '张三' },
  success: () => console.log('存储成功'),
  fail: (err) => console.error('存储失败', err)
})

// 异步读取
wx.getStorage({
  key: 'user',
  success: (res) => console.log('数据:', res.data),
  fail: (err) => console.error('读取失败', err)
})
```

### 12.2 存储工具封装

```javascript
// utils/storage.js
const STORAGE_PREFIX = 'myapp_'

const storage = {
  // 设置（支持过期时间）
  set(key, value, expire) {
    const data = {
      value,
      expire: expire ? Date.now() + expire * 1000 : null
    }
    wx.setStorageSync(STORAGE_PREFIX + key, data)
  },
  
  // 获取
  get(key, defaultValue = null) {
    try {
      const data = wx.getStorageSync(STORAGE_PREFIX + key)
      if (!data) return defaultValue
      
      // 检查是否过期
      if (data.expire && Date.now() > data.expire) {
        this.remove(key)
        return defaultValue
      }
      
      return data.value
    } catch (e) {
      return defaultValue
    }
  },
  
  // 删除
  remove(key) {
    wx.removeStorageSync(STORAGE_PREFIX + key)
  },
  
  // 清空
  clear() {
    const info = wx.getStorageInfoSync()
    info.keys.forEach(key => {
      if (key.startsWith(STORAGE_PREFIX)) {
        wx.removeStorageSync(key)
      }
    })
  },
  
  // 检查是否存在
  has(key) {
    return !!wx.getStorageSync(STORAGE_PREFIX + key)
  }
}

module.exports = storage
```

### 12.3 缓存策略

```javascript
// utils/cache.js
const cache = {
  // 带缓存的请求
  async fetchWithCache(key, fetchFn, expire = 300) {
    // 先尝试从缓存获取
    const cached = this.get(key)
    if (cached) {
      return cached
    }
    
    // 缓存不存在或已过期，发起请求
    const data = await fetchFn()
    
    // 存入缓存
    this.set(key, data, expire)
    
    return data
  },
  
  set(key, value, expire) {
    const data = {
      value,
      expire: Date.now() + expire * 1000
    }
    wx.setStorageSync(`cache_${key}`, data)
  },
  
  get(key) {
    try {
      const data = wx.getStorageSync(`cache_${key}`)
      if (!data) return null
      
      if (Date.now() > data.expire) {
        wx.removeStorageSync(`cache_${key}`)
        return null
      }
      
      return data.value
    } catch (e) {
      return null
    }
  },
  
  remove(key) {
    wx.removeStorageSync(`cache_${key}`)
  },
  
  // 清除所有缓存
  clearAll() {
    const info = wx.getStorageInfoSync()
    info.keys.forEach(key => {
      if (key.startsWith('cache_')) {
        wx.removeStorageSync(key)
      }
    })
  }
}

module.exports = cache
```

---

## 13. 事件系统

### 13.1 事件绑定

```html
<!-- 冒泡事件 -->
<view bindtap="handleTap">点击</view>
<view bind:tap="handleTap">点击（新语法）</view>

<!-- 非冒泡事件（阻止冒泡） -->
<view catchtap="handleTap">点击不冒泡</view>
<view catch:tap="handleTap">点击不冒泡（新语法）</view>

<!-- 互斥事件（阻止同节点其他事件） -->
<view mut-bind:tap="handleTap">互斥事件</view>

<!-- 捕获阶段事件 -->
<view capture-bind:tap="handleCapture">捕获</view>
<view capture-catch:tap="handleCapture">捕获并阻止</view>
```

### 13.2 事件类型

```html
<!-- 触摸事件 -->
<view 
  bindtouchstart="onTouchStart"
  bindtouchmove="onTouchMove"
  bindtouchend="onTouchEnd"
  bindtouchcancel="onTouchCancel"
>
  触摸区域
</view>

<!-- 点击事件 -->
<view bindtap="onTap">点击</view>
<view bindlongpress="onLongPress">长按</view>
<view bindlongtap="onLongTap">长按（已废弃，用 longpress）</view>

<!-- 表单事件 -->
<input bindinput="onInput" bindfocus="onFocus" bindblur="onBlur" />
<form bindsubmit="onSubmit" bindreset="onReset"></form>

<!-- 滚动事件 -->
<scroll-view bindscroll="onScroll" bindscrolltolower="onReachBottom"></scroll-view>

<!-- 动画事件 -->
<view bindtransitionend="onTransitionEnd" bindanimationend="onAnimationEnd"></view>
```

### 13.3 事件对象

```javascript
Page({
  handleTap(e) {
    console.log('事件类型:', e.type)
    console.log('时间戳:', e.timeStamp)
    console.log('触发事件的组件:', e.target)
    console.log('当前组件:', e.currentTarget)
    console.log('额外信息:', e.detail)
    
    // target vs currentTarget
    // target: 触发事件的源组件
    // currentTarget: 事件绑定的当前组件
    
    // 获取自定义数据
    const { id, name } = e.currentTarget.dataset
    console.log('data-id:', id)
    console.log('data-name:', name)
  },
  
  handleTouch(e) {
    // 触摸点信息
    const touch = e.touches[0]
    console.log('触摸点 X:', touch.clientX)
    console.log('触摸点 Y:', touch.clientY)
    console.log('页面 X:', touch.pageX)
    console.log('页面 Y:', touch.pageY)
  }
})
```

```html
<!-- 传递自定义数据 -->
<view 
  data-id="{{ item.id }}"
  data-name="{{ item.name }}"
  data-info="{{ item }}"
  bindtap="handleTap"
>
  {{ item.name }}
</view>
```

### 13.4 事件传参

```html
<!-- 方式1：使用 data-* 属性 -->
<view data-id="{{ item.id }}" bindtap="handleTap">
  {{ item.name }}
</view>

<!-- 方式2：使用 mark 标记（可以跨组件传递） -->
<view mark:id="{{ item.id }}" bindtap="handleTap">
  {{ item.name }}
</view>
```

```javascript
Page({
  // 使用 data-*
  handleTap(e) {
    const id = e.currentTarget.dataset.id
    console.log('id:', id)
  },
  
  // 使用 mark
  handleTapWithMark(e) {
    const id = e.mark.id
    console.log('id:', id)
  }
})
```

### 13.5 自定义事件

```javascript
// 组件内触发事件
Component({
  methods: {
    handleTap() {
      // 触发自定义事件
      this.triggerEvent('myevent', {
        value: 'hello'
      }, {
        bubbles: true,      // 是否冒泡
        composed: true,     // 是否可以穿越组件边界
        capturePhase: false // 是否有捕获阶段
      })
    }
  }
})
```

```html
<!-- 父组件监听 -->
<my-component bind:myevent="onMyEvent"></my-component>
```

```javascript
// 父组件处理
Page({
  onMyEvent(e) {
    console.log('收到事件:', e.detail.value)
  }
})
```

---

## 14. 自定义组件

### 14.1 组件创建

```
components/
└── my-button/
    ├── my-button.js
    ├── my-button.json
    ├── my-button.wxml
    └── my-button.wxss
```

```json
// my-button.json
{
  "component": true,
  "usingComponents": {}
}
```

```javascript
// my-button.js
Component({
  // 组件的属性列表（外部传入）
  properties: {
    // 简写
    text: String,
    
    // 完整写法
    type: {
      type: String,
      value: 'default',
      observer(newVal, oldVal) {
        console.log('type 变化:', oldVal, '->', newVal)
      }
    },
    
    disabled: {
      type: Boolean,
      value: false
    },
    
    // 数组类型
    list: {
      type: Array,
      value: []
    },
    
    // 对象类型
    config: {
      type: Object,
      value: {}
    }
  },
  
  // 组件的内部数据
  data: {
    innerText: '内部数据'
  },
  
  // 数据监听器
  observers: {
    // 监听单个属性
    'type': function(type) {
      console.log('type 变化:', type)
    },
    
    // 监听多个属性
    'type, disabled': function(type, disabled) {
      console.log('type 或 disabled 变化')
    },
    
    // 监听对象属性
    'config.name': function(name) {
      console.log('config.name 变化:', name)
    },
    
    // 监听所有属性
    '**': function() {
      console.log('有属性变化')
    }
  },
  
  // 组件生命周期
  lifetimes: {
    created() {
      // 组件实例刚创建，不能调用 setData
      console.log('组件创建')
    },
    attached() {
      // 组件进入页面节点树
      console.log('组件挂载')
    },
    ready() {
      // 组件渲染完成
      console.log('组件就绪')
    },
    moved() {
      // 组件被移动到另一个位置
      console.log('组件移动')
    },
    detached() {
      // 组件从页面节点树移除
      console.log('组件卸载')
    },
    error(err) {
      // 组件方法抛出错误
      console.error('组件错误:', err)
    }
  },
  
  // 组件所在页面的生命周期
  pageLifetimes: {
    show() {
      console.log('页面显示')
    },
    hide() {
      console.log('页面隐藏')
    },
    resize(size) {
      console.log('页面尺寸变化:', size)
    }
  },
  
  // 组件的方法
  methods: {
    handleTap() {
      // 触发自定义事件
      this.triggerEvent('tap', {
        value: this.data.text
      })
    },
    
    // 公开方法（可被父组件调用）
    doSomething() {
      console.log('执行操作')
    }
  }
})
```

```html
<!-- my-button.wxml -->
<button 
  class="my-button {{ type }} {{ disabled ? 'disabled' : '' }}"
  disabled="{{ disabled }}"
  bindtap="handleTap"
>
  <slot></slot>
  {{ text }}
</button>
```

```css
/* my-button.wxss */
.my-button {
  padding: 20rpx 40rpx;
  border-radius: 8rpx;
  font-size: 28rpx;
}

.my-button.primary {
  background-color: #07c160;
  color: #fff;
}

.my-button.default {
  background-color: #fff;
  color: #333;
  border: 1rpx solid #ddd;
}

.my-button.disabled {
  opacity: 0.5;
}
```

### 14.2 组件使用

```json
// 页面 json 配置
{
  "usingComponents": {
    "my-button": "/components/my-button/my-button"
  }
}
```

```html
<!-- 页面中使用 -->
<my-button type="primary" text="主要按钮" bind:tap="onButtonTap">
  <text>插槽内容</text>
</my-button>

<my-button type="default" disabled="{{ true }}">
  禁用按钮
</my-button>
```

### 14.3 插槽 Slot

```html
<!-- 组件 wxml - 默认插槽 -->
<view class="container">
  <slot></slot>
</view>

<!-- 组件 wxml - 具名插槽 -->
<view class="container">
  <slot name="header"></slot>
  <view class="content">
    <slot></slot>
  </view>
  <slot name="footer"></slot>
</view>
```

```javascript
// 组件 js - 启用多插槽
Component({
  options: {
    multipleSlots: true
  }
})
```

```html
<!-- 使用具名插槽 -->
<my-component>
  <view slot="header">头部</view>
  <view>默认内容</view>
  <view slot="footer">底部</view>
</my-component>
```

### 14.4 组件通信

```javascript
// 父组件调用子组件方法
Page({
  onReady() {
    // 获取组件实例
    const child = this.selectComponent('#myComponent')
    // 调用组件方法
    child.doSomething()
  }
})
```

```html
<my-component id="myComponent"></my-component>
```

```javascript
// 子组件获取父组件
Component({
  relations: {
    '../parent/parent': {
      type: 'parent',
      linked(target) {
        console.log('关联到父组件:', target)
      }
    }
  }
})
```

### 14.5 组件样式隔离

```javascript
Component({
  options: {
    // 样式隔离选项
    styleIsolation: 'isolated',  // 默认，完全隔离
    // styleIsolation: 'apply-shared',  // 页面样式影响组件
    // styleIsolation: 'shared',  // 样式互相影响
    
    // 允许外部类
    externalClasses: ['my-class'],
    
    // 虚拟化组件节点
    virtualHost: true
  }
})
```

```html
<!-- 使用外部类 -->
<my-component my-class="custom-class"></my-component>
```

### 14.6 Behaviors（类似 Mixins）

```javascript
// behaviors/my-behavior.js
module.exports = Behavior({
  properties: {
    myBehaviorProperty: {
      type: String,
      value: ''
    }
  },
  
  data: {
    myBehaviorData: {}
  },
  
  methods: {
    myBehaviorMethod() {
      console.log('behavior 方法')
    }
  },
  
  lifetimes: {
    attached() {
      console.log('behavior attached')
    }
  }
})
```

```javascript
// 组件中使用
const myBehavior = require('../../behaviors/my-behavior')

Component({
  behaviors: [myBehavior],
  
  properties: {
    // 组件自己的属性
  },
  
  methods: {
    // 组件自己的方法
  }
})
```


---

## 15. 分包加载

### 15.1 为什么需要分包？

小程序有包大小限制：
- 整个小程序所有分包大小不超过 20MB
- 单个分包/主包大小不能超过 2MB

分包可以：
- 减少首次加载时间
- 按需加载功能模块
- 优化用户体验

### 15.2 分包配置

```json
// app.json
{
  "pages": [
    "pages/index/index",
    "pages/user/user"
  ],
  "subpackages": [
    {
      "root": "packageA",
      "name": "pack-a",
      "pages": [
        "pages/detail/detail",
        "pages/list/list"
      ]
    },
    {
      "root": "packageB",
      "name": "pack-b",
      "pages": [
        "pages/order/order",
        "pages/pay/pay"
      ],
      "independent": true  // 独立分包
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["packageA"]
    },
    "pages/user/user": {
      "network": "wifi",
      "packages": ["packageB"]
    }
  }
}
```

### 15.3 目录结构

```
my-miniprogram/
├── app.js
├── app.json
├── app.wxss
├── pages/                    # 主包页面
│   ├── index/
│   └── user/
├── packageA/                 # 分包 A
│   └── pages/
│       ├── detail/
│       └── list/
└── packageB/                 # 分包 B（独立分包）
    └── pages/
        ├── order/
        └── pay/
```

### 15.4 分包跳转

```javascript
// 跳转到分包页面
wx.navigateTo({
  url: '/packageA/pages/detail/detail?id=123'
})

// 分包内跳转
wx.navigateTo({
  url: '../list/list'  // 相对路径
})
```

### 15.5 独立分包

独立分包可以独立于主包和其他分包运行，适合功能相对独立的页面（如活动页）：

```json
{
  "subpackages": [
    {
      "root": "packageIndependent",
      "pages": ["pages/activity/activity"],
      "independent": true
    }
  ]
}
```

独立分包的限制：
- 不能依赖主包和其他分包的内容
- 不能使用 app.wxss 中的样式
- 不能使用 app.js 中的全局数据

### 15.6 分包预下载

```json
{
  "preloadRule": {
    "pages/index/index": {
      "network": "all",      // all: 所有网络, wifi: 仅 wifi
      "packages": ["packageA", "packageB"]
    }
  }
}
```

### 15.7 分包异步化

```javascript
// 跨分包引用组件
{
  "usingComponents": {
    "comp-from-packageA": {
      "path": "/packageA/components/comp",
      "async": true  // 异步加载
    }
  }
}
```

```html
<!-- 使用占位组件 -->
<comp-from-packageA placeholder="loading-comp">
  内容
</comp-from-packageA>
```

---

## 16. 开放能力

### 16.1 用户信息

```javascript
// 获取用户信息（需要用户授权）
// 注意：2021年4月后，getUserInfo 接口调整，需要使用 getUserProfile

// 方式1：getUserProfile（推荐）
wx.getUserProfile({
  desc: '用于完善用户资料',
  success: (res) => {
    console.log('用户信息:', res.userInfo)
    // { nickName, avatarUrl, gender, country, province, city }
  },
  fail: (err) => {
    console.log('用户拒绝授权')
  }
})

// 方式2：使用 open-data 展示（无需授权）
// <open-data type="userAvatarUrl"></open-data>
// <open-data type="userNickName"></open-data>

// 方式3：头像昵称填写能力（2022年后推荐）
// <button open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
//   选择头像
// </button>
// <input type="nickname" placeholder="请输入昵称" />
```

### 16.2 登录

```javascript
// 小程序登录流程
// 1. 调用 wx.login 获取 code
// 2. 将 code 发送到后端
// 3. 后端用 code 换取 openid 和 session_key
// 4. 后端返回自定义登录态（token）

const login = async () => {
  try {
    // 1. 获取 code
    const { code } = await wx.login()
    
    // 2. 发送 code 到后端
    const res = await wx.request({
      url: 'https://api.example.com/login',
      method: 'POST',
      data: { code }
    })
    
    // 3. 保存 token
    wx.setStorageSync('token', res.data.token)
    
    return res.data
  } catch (error) {
    console.error('登录失败:', error)
    throw error
  }
}

// 检查登录状态
const checkSession = () => {
  return new Promise((resolve, reject) => {
    wx.checkSession({
      success: () => resolve(true),
      fail: () => resolve(false)
    })
  })
}
```

### 16.3 手机号获取

```html
<!-- 获取手机号按钮 -->
<button 
  open-type="getPhoneNumber" 
  bindgetphonenumber="onGetPhoneNumber"
>
  获取手机号
</button>
```

```javascript
Page({
  onGetPhoneNumber(e) {
    if (e.detail.errMsg === 'getPhoneNumber:ok') {
      // 获取加密数据
      const { encryptedData, iv, code } = e.detail
      
      // 发送到后端解密
      wx.request({
        url: 'https://api.example.com/decrypt-phone',
        method: 'POST',
        data: {
          encryptedData,
          iv,
          code  // 新版本使用 code 直接换取手机号
        },
        success: (res) => {
          console.log('手机号:', res.data.phoneNumber)
        }
      })
    } else {
      console.log('用户拒绝授权')
    }
  }
})
```

### 16.4 支付

```javascript
// 微信支付流程
const pay = async (orderId) => {
  try {
    // 1. 后端创建订单，返回支付参数
    const payParams = await request({
      url: '/order/pay',
      method: 'POST',
      data: { orderId }
    })
    
    // 2. 调用微信支付
    await wx.requestPayment({
      timeStamp: payParams.timeStamp,
      nonceStr: payParams.nonceStr,
      package: payParams.package,
      signType: payParams.signType,
      paySign: payParams.paySign
    })
    
    console.log('支付成功')
    return true
  } catch (error) {
    if (error.errMsg === 'requestPayment:fail cancel') {
      console.log('用户取消支付')
    } else {
      console.error('支付失败:', error)
    }
    return false
  }
}
```

### 16.5 分享

```javascript
Page({
  // 分享给好友
  onShareAppMessage(options) {
    // options.from: 'button' 或 'menu'
    // options.target: 触发分享的按钮（如果 from 是 button）
    
    return {
      title: '分享标题',
      path: '/pages/index/index?id=123',
      imageUrl: '/images/share.png'
    }
  },
  
  // 分享到朋友圈
  onShareTimeline() {
    return {
      title: '分享标题',
      query: 'id=123',
      imageUrl: '/images/share.png'
    }
  }
})
```

```html
<!-- 分享按钮 -->
<button open-type="share">分享给好友</button>
```

### 16.6 位置

```javascript
// 获取当前位置
wx.getLocation({
  type: 'gcj02',  // wgs84 或 gcj02
  success: (res) => {
    console.log('纬度:', res.latitude)
    console.log('经度:', res.longitude)
    console.log('速度:', res.speed)
    console.log('精确度:', res.accuracy)
  },
  fail: (err) => {
    if (err.errMsg.includes('auth deny')) {
      // 引导用户开启权限
      wx.showModal({
        title: '提示',
        content: '请授权位置权限',
        success: (res) => {
          if (res.confirm) {
            wx.openSetting()
          }
        }
      })
    }
  }
})

// 选择位置
wx.chooseLocation({
  success: (res) => {
    console.log('位置名称:', res.name)
    console.log('详细地址:', res.address)
    console.log('纬度:', res.latitude)
    console.log('经度:', res.longitude)
  }
})

// 打开地图
wx.openLocation({
  latitude: 39.9,
  longitude: 116.4,
  name: '目的地',
  address: '详细地址',
  scale: 18
})
```

### 16.7 扫码

```javascript
wx.scanCode({
  onlyFromCamera: false,  // 是否只能从相机扫码
  scanType: ['qrCode', 'barCode'],  // 扫码类型
  success: (res) => {
    console.log('扫码结果:', res.result)
    console.log('码类型:', res.scanType)
  }
})
```

### 16.8 订阅消息

```javascript
// 请求订阅消息授权
wx.requestSubscribeMessage({
  tmplIds: ['template_id_1', 'template_id_2'],
  success: (res) => {
    // res['template_id_1'] = 'accept' | 'reject' | 'ban'
    if (res['template_id_1'] === 'accept') {
      console.log('用户同意订阅')
    }
  }
})

// 后端发送订阅消息
// POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send
```

### 16.9 小程序码

```javascript
// 后端生成小程序码
// 接口：POST https://api.weixin.qq.com/wxa/getwxacodeunlimit

// 前端展示
// <image src="{{ qrcodeUrl }}" mode="aspectFit"></image>

// 扫码进入后获取参数
Page({
  onLoad(options) {
    // 通过 scene 获取参数（需要 decodeURIComponent）
    const scene = decodeURIComponent(options.scene)
    console.log('scene:', scene)
  }
})
```

---

## 17. 性能优化

### 17.1 启动优化

```javascript
// 1. 分包加载
// 将非首页功能放入分包

// 2. 异步数据预拉取
// app.json 配置
{
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["packageA"]
    }
  }
}

// 3. 骨架屏
// 使用开发者工具生成骨架屏
// 页面 json 配置
{
  "initialRenderingCache": "static"
}

// 4. 延迟加载非关键数据
Page({
  onLoad() {
    // 先加载关键数据
    this.loadCriticalData()
    
    // 延迟加载非关键数据
    setTimeout(() => {
      this.loadNonCriticalData()
    }, 1000)
  }
})
```

### 17.2 渲染优化

```javascript
// 1. 减少 setData 调用次数
// ❌ 错误
this.setData({ a: 1 })
this.setData({ b: 2 })
this.setData({ c: 3 })

// ✅ 正确
this.setData({ a: 1, b: 2, c: 3 })

// 2. 减少 setData 数据量
// ❌ 错误
this.setData({ list: newList })  // 整个列表

// ✅ 正确
this.setData({ [`list[${index}]`]: newItem })  // 只更新一项

// 3. 避免频繁 setData
// 使用节流
let timer = null
const throttleSetData = (data) => {
  if (timer) return
  timer = setTimeout(() => {
    this.setData(data)
    timer = null
  }, 100)
}

// 4. 使用自定义组件
// 将复杂列表项封装为组件，利用组件的独立渲染
```

### 17.3 长列表优化

```html
<!-- 使用 recycle-view 虚拟列表 -->
<recycle-view 
  batch="{{batchSetRecycleData}}" 
  id="recycleId"
>
  <recycle-item wx:for="{{recycleList}}" wx:key="id">
    <view>{{item.name}}</view>
  </recycle-item>
</recycle-view>
```

```javascript
// 手动实现虚拟列表
Page({
  data: {
    list: [],
    visibleList: [],
    startIndex: 0,
    itemHeight: 100,
    containerHeight: 600
  },
  
  onScroll(e) {
    const scrollTop = e.detail.scrollTop
    const startIndex = Math.floor(scrollTop / this.data.itemHeight)
    const visibleCount = Math.ceil(this.data.containerHeight / this.data.itemHeight) + 2
    
    const visibleList = this.data.list.slice(startIndex, startIndex + visibleCount)
    
    this.setData({
      startIndex,
      visibleList
    })
  }
})
```

### 17.4 图片优化

```html
<!-- 1. 使用 lazy-load 懒加载 -->
<image src="{{ url }}" lazy-load mode="aspectFill"></image>

<!-- 2. 使用合适的图片尺寸 -->
<!-- 根据显示尺寸请求对应大小的图片 -->
<image src="{{ url }}?width=200" style="width: 200rpx;"></image>

<!-- 3. 使用 webp 格式 -->
<image src="{{ url }}.webp"></image>
```

```javascript
// 4. 图片预加载
const preloadImages = (urls) => {
  urls.forEach(url => {
    wx.getImageInfo({ src: url })
  })
}
```

### 17.5 网络优化

```javascript
// 1. 请求合并
const fetchAllData = async () => {
  const [users, orders, products] = await Promise.all([
    getUsers(),
    getOrders(),
    getProducts()
  ])
  return { users, orders, products }
}

// 2. 数据缓存
const fetchWithCache = async (key, fetchFn, expire = 300) => {
  const cached = wx.getStorageSync(key)
  if (cached && Date.now() < cached.expire) {
    return cached.data
  }
  
  const data = await fetchFn()
  wx.setStorageSync(key, {
    data,
    expire: Date.now() + expire * 1000
  })
  return data
}

// 3. 请求节流
let requestTimer = null
const throttleRequest = (fn, delay = 300) => {
  if (requestTimer) return
  requestTimer = setTimeout(() => {
    fn()
    requestTimer = null
  }, delay)
}
```

### 17.6 内存优化

```javascript
// 1. 及时清理定时器
Page({
  data: {
    timer: null
  },
  
  onLoad() {
    this.data.timer = setInterval(() => {
      // ...
    }, 1000)
  },
  
  onUnload() {
    if (this.data.timer) {
      clearInterval(this.data.timer)
      this.data.timer = null
    }
  }
})

// 2. 及时清理事件监听
Page({
  onLoad() {
    wx.onNetworkStatusChange(this.onNetworkChange)
  },
  
  onUnload() {
    wx.offNetworkStatusChange(this.onNetworkChange)
  },
  
  onNetworkChange(res) {
    console.log('网络状态:', res.isConnected)
  }
})

// 3. 避免内存泄漏
// 不要在 data 中存储大量数据
// 及时释放不需要的数据
this.setData({ largeData: null })
```


---

## 18. 常见错误与解决方案

### 18.1 页面路由错误

```javascript
// ❌ 错误：跳转 tabBar 页面使用 navigateTo
wx.navigateTo({
  url: '/pages/index/index'  // index 是 tabBar 页面
})
// 报错：can not navigateTo a tabbar page

// ✅ 正确：使用 switchTab
wx.switchTab({
  url: '/pages/index/index'
})

// ❌ 错误：路径不以 / 开头
wx.navigateTo({
  url: 'pages/detail/detail'
})

// ✅ 正确：路径以 / 开头
wx.navigateTo({
  url: '/pages/detail/detail'
})

// ❌ 错误：页面栈超过限制（最多 10 层）
// 连续多次 navigateTo 会导致页面栈溢出

// ✅ 正确：适时使用 redirectTo 或 reLaunch
wx.redirectTo({
  url: '/pages/result/result'
})
```

### 18.2 setData 相关错误

```javascript
// ❌ 错误：setData 数据过大
this.setData({
  hugeList: veryLargeArray  // 数据量太大会导致卡顿
})

// ✅ 正确：只更新需要的数据
this.setData({
  [`list[${index}]`]: newItem
})

// ❌ 错误：在 setData 中使用 undefined
this.setData({
  value: undefined  // 会报错
})

// ✅ 正确：使用 null 或删除该字段
this.setData({
  value: null
})

// ❌ 错误：setData 路径错误
this.setData({
  'obj.a.b.c': value  // 如果 obj.a.b 不存在会报错
})

// ✅ 正确：确保路径存在
if (this.data.obj && this.data.obj.a && this.data.obj.a.b) {
  this.setData({
    'obj.a.b.c': value
  })
}

// ❌ 错误：频繁调用 setData
for (let i = 0; i < 100; i++) {
  this.setData({ [`list[${i}]`]: i })
}

// ✅ 正确：合并更新
const updates = {}
for (let i = 0; i < 100; i++) {
  updates[`list[${i}]`] = i
}
this.setData(updates)
```

### 18.3 网络请求错误

```javascript
// ❌ 错误：未配置合法域名
// 在微信公众平台 → 开发 → 开发设置 → 服务器域名 中配置

// ✅ 开发时可以关闭域名校验
// 微信开发者工具 → 详情 → 本地设置 → 不校验合法域名

// ❌ 错误：请求超时未处理
wx.request({
  url: 'https://api.example.com/data',
  success: (res) => {
    // 只处理成功
  }
})

// ✅ 正确：处理所有情况
wx.request({
  url: 'https://api.example.com/data',
  timeout: 10000,
  success: (res) => {
    if (res.statusCode === 200) {
      // 处理成功
    } else {
      // 处理 HTTP 错误
    }
  },
  fail: (err) => {
    // 处理网络错误
    wx.showToast({ title: '网络错误', icon: 'none' })
  }
})

// ❌ 错误：并发请求过多
// 小程序同时最多 10 个请求

// ✅ 正确：使用请求队列
const requestQueue = []
let activeCount = 0
const MAX_CONCURRENT = 5

const addToQueue = (config) => {
  return new Promise((resolve, reject) => {
    requestQueue.push({ config, resolve, reject })
    processQueue()
  })
}

const processQueue = () => {
  while (activeCount < MAX_CONCURRENT && requestQueue.length > 0) {
    const { config, resolve, reject } = requestQueue.shift()
    activeCount++
    
    wx.request({
      ...config,
      success: resolve,
      fail: reject,
      complete: () => {
        activeCount--
        processQueue()
      }
    })
  }
}
```

### 18.4 组件相关错误

```javascript
// ❌ 错误：组件未注册
// 报错：Component is not found in path "xxx"

// ✅ 正确：在 json 中注册组件
// page.json
{
  "usingComponents": {
    "my-component": "/components/my-component/my-component"
  }
}

// ❌ 错误：组件 json 未声明
// 报错：Component is not defined

// ✅ 正确：组件 json 必须声明
// my-component.json
{
  "component": true
}

// ❌ 错误：在组件中使用页面生命周期
Component({
  onLoad() {  // 不会触发
    console.log('onLoad')
  }
})

// ✅ 正确：使用组件生命周期
Component({
  lifetimes: {
    attached() {
      console.log('组件挂载')
    }
  },
  pageLifetimes: {
    show() {
      console.log('页面显示')
    }
  }
})
```

### 18.5 样式相关错误

```css
/* ❌ 错误：使用不支持的选择器 */
* {
  margin: 0;
}

/* ✅ 正确：使用支持的选择器 */
view, text, image {
  margin: 0;
}

/* ❌ 错误：组件样式不生效 */
/* 组件默认样式隔离 */

/* ✅ 正确：使用外部类或修改样式隔离 */
/* 组件 js */
Component({
  options: {
    styleIsolation: 'apply-shared'
  },
  externalClasses: ['custom-class']
})

/* ❌ 错误：rpx 计算问题 */
.box {
  width: calc(100% - 20rpx);  /* 可能有问题 */
}

/* ✅ 正确：使用 padding 或固定单位 */
.box {
  width: 100%;
  padding: 0 20rpx;
  box-sizing: border-box;
}
```

### 18.6 授权相关错误

```javascript
// ❌ 错误：直接调用需要授权的 API
wx.getLocation({
  success: (res) => {
    console.log(res)
  }
})

// ✅ 正确：先检查授权状态
const checkAuth = async (scope) => {
  try {
    const { authSetting } = await wx.getSetting()
    
    if (authSetting[scope]) {
      // 已授权
      return true
    } else if (authSetting[scope] === false) {
      // 用户拒绝过，引导去设置页
      const { confirm } = await wx.showModal({
        title: '提示',
        content: '需要您的授权才能使用该功能'
      })
      if (confirm) {
        await wx.openSetting()
        const { authSetting: newSetting } = await wx.getSetting()
        return newSetting[scope]
      }
      return false
    } else {
      // 未请求过授权
      try {
        await wx.authorize({ scope })
        return true
      } catch (e) {
        return false
      }
    }
  } catch (e) {
    return false
  }
}

// 使用
const getLocation = async () => {
  const hasAuth = await checkAuth('scope.userLocation')
  if (hasAuth) {
    const res = await wx.getLocation({ type: 'gcj02' })
    console.log(res)
  }
}
```

### 18.7 生命周期错误

```javascript
// ❌ 错误：在 onLoad 中获取节点信息
Page({
  onLoad() {
    // 此时页面还未渲染完成
    const query = wx.createSelectorQuery()
    query.select('.box').boundingClientRect()
    query.exec((res) => {
      console.log(res[0])  // 可能为 null
    })
  }
})

// ✅ 正确：在 onReady 中获取
Page({
  onReady() {
    const query = wx.createSelectorQuery()
    query.select('.box').boundingClientRect()
    query.exec((res) => {
      console.log(res[0])  // 正确获取
    })
  }
})

// ❌ 错误：在 onUnload 后还在操作页面
Page({
  data: {
    timer: null
  },
  
  onLoad() {
    this.data.timer = setInterval(() => {
      this.setData({ count: this.data.count + 1 })  // 页面卸载后会报错
    }, 1000)
  }
})

// ✅ 正确：在 onUnload 中清理
Page({
  onUnload() {
    if (this.data.timer) {
      clearInterval(this.data.timer)
    }
  }
})
```

### 18.8 数据类型错误

```javascript
// ❌ 错误：wx:for 遍历非数组
// <view wx:for="{{ obj }}">  // obj 是对象，不是数组

// ✅ 正确：确保是数组
// <view wx:for="{{ list }}">  // list 是数组

// ❌ 错误：wx:key 使用错误
// <view wx:for="{{ list }}" wx:key="{{ item.id }}">  // 错误语法

// ✅ 正确：wx:key 直接写属性名
// <view wx:for="{{ list }}" wx:key="id">

// ❌ 错误：布尔值属性绑定
// <checkbox checked="false">  // 字符串 "false" 会被当作 true

// ✅ 正确：使用数据绑定
// <checkbox checked="{{ false }}">
// <checkbox checked="{{ isChecked }}">
```

### 18.9 小程序审核常见问题

```javascript
// 1. 用户隐私问题
// - 必须配置隐私协议
// - 收集用户信息前需要用户同意

// 2. 内容安全问题
// - 用户生成内容需要进行安全检测
const checkContent = async (content) => {
  const res = await wx.request({
    url: 'https://api.weixin.qq.com/wxa/msg_sec_check',
    method: 'POST',
    data: { content }
  })
  return res.data.errcode === 0
}

// 3. 类目问题
// - 确保小程序类目与实际功能一致
// - 特殊类目需要资质

// 4. 功能完整性
// - 不能有空白页面
// - 功能必须可用

// 5. 诱导分享
// - 不能强制分享才能使用功能
// - 不能诱导用户分享
```

### 18.10 调试技巧

```javascript
// 1. 使用 console 调试
console.log('数据:', JSON.stringify(data, null, 2))
console.table(array)
console.time('耗时')
// ... 代码
console.timeEnd('耗时')

// 2. 使用断点调试
// 在开发者工具的 Sources 面板设置断点

// 3. 使用 vConsole
// 真机调试时开启 vConsole

// 4. 网络请求调试
// 在开发者工具的 Network 面板查看请求

// 5. 性能分析
// 使用开发者工具的 Performance 面板

// 6. 代码质量检查
// 使用开发者工具的代码质量分析功能

// 7. 体验评分
// 使用开发者工具的体验评分功能
```

---

## 总结

微信小程序开发的核心要点：

1. **双线程架构**：理解视图层和逻辑层的分离
2. **WXML/WXSS**：掌握模板语法和样式规范
3. **组件系统**：熟悉内置组件和自定义组件
4. **生命周期**：理解 App、Page、Component 的生命周期
5. **数据通信**：掌握 setData、事件、全局数据等通信方式
6. **开放能力**：熟悉登录、支付、分享等开放能力
7. **性能优化**：分包加载、setData 优化、图片优化等
8. **审核规范**：了解小程序审核要求

---

> 📚 参考资源
> - [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
> - [微信开放社区](https://developers.weixin.qq.com/community/develop/mixflow)
> - [小程序 API 文档](https://developers.weixin.qq.com/miniprogram/dev/api/)
> - [WeUI 组件库](https://github.com/Tencent/weui-wxss)
> - [Vant Weapp](https://vant-contrib.gitee.io/vant-weapp/)
