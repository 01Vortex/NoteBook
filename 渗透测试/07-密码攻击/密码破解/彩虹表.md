# 彩虹表 (Rainbow Table) 完全指南

> 时间-空间权衡的密码破解艺术 - 基于 2024/2025 最新技术

---

## 目录

1. [彩虹表概述](#1-彩虹表概述)
2. [原理详解](#2-原理详解)
3. [工具介绍](#3-工具介绍)
4. [RainbowCrack 使用](#4-rainbowcrack-使用)
5. [Ophcrack 使用](#5-ophcrack-使用)
6. [在线彩虹表服务](#6-在线彩虹表服务)
7. [生成自定义彩虹表](#7-生成自定义彩虹表)
8. [实战案例](#8-实战案例)
9. [防御措施](#9-防御措施)
10. [常见错误与解决](#10-常见错误与解决)

---

## 1. 彩虹表概述

### 1.1 什么是彩虹表？

彩虹表是一种预先计算好的哈希值查找表，用于快速破解密码哈希。它是**时间-空间权衡**（Time-Memory Trade-Off）技术的典型应用。

**通俗理解**：想象你要破解一个密码的哈希值。暴力破解就像现场计算每个可能密码的哈希，非常耗时。而彩虹表就像一本提前编好的"密码字典"，你只需要查表就能找到答案，速度极快。

```
┌─────────────────────────────────────────────────────────────────────┐
│                      密码破解方法对比                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  【暴力破解】                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 密码候选 → 计算哈希 → 比对目标哈希 → 不匹配 → 下一个...      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  特点: 时间长，空间小                                               │
│  时间复杂度: O(n)，空间复杂度: O(1)                                 │
│                                                                      │
│  【完整哈希表】                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 预计算所有密码的哈希 → 存储 → 直接查表                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  特点: 时间短，空间巨大                                             │
│  时间复杂度: O(1)，空间复杂度: O(n)                                 │
│                                                                      │
│  【彩虹表】                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 预计算哈希链 → 只存储链的首尾 → 查表 + 少量计算               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  特点: 时间和空间的平衡                                             │
│  时间复杂度: O(t)，空间复杂度: O(n/t)                               │
│  其中 t 是链长度                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 彩虹表的历史

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表发展历史                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1980年 - Martin Hellman 提出时间-空间权衡概念                       │
│          │                                                          │
│          ▼                                                          │
│ 1982年 - Ronald Rivest 改进为"Distinguished Points"方法             │
│          │                                                          │
│          ▼                                                          │
│ 2003年 - Philippe Oechslin 发明彩虹表                               │
│          使用多个归约函数，解决链碰撞问题                            │
│          │                                                          │
│          ▼                                                          │
│ 2003年 - Ophcrack 发布，首个实用的彩虹表工具                        │
│          │                                                          │
│          ▼                                                          │
│ 2005年 - RainbowCrack 项目启动                                      │
│          │                                                          │
│          ▼                                                          │
│ 2010年+ - 加盐哈希普及，彩虹表效果大减                              │
│          │                                                          │
│          ▼                                                          │
│ 2020年+ - 仍对无盐哈希有效，但使用场景减少                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 彩虹表的优缺点

```
┌─────────────────────────────────────────────────────────────────────┐
│ 优点                                                                 │
├─────────────────────────────────────────────────────────────────────┤
│ ✓ 破解速度极快（秒级到分钟级）                                       │
│ ✓ 一次生成，多次使用                                                │
│ ✓ 对无盐哈希非常有效                                                │
│ ✓ 不需要强大的计算能力（查表为主）                                  │
│ ✓ 可以离线使用                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 缺点                                                                 │
├─────────────────────────────────────────────────────────────────────┤
│ ✗ 对加盐哈希无效（每个盐需要单独的表）                              │
│ ✗ 存储空间需求大（GB 到 TB 级别）                                   │
│ ✗ 生成时间长（可能需要数天到数周）                                  │
│ ✗ 只能破解预定义字符集和长度的密码                                  │
│ ✗ 现代系统大多使用加盐哈希，适用场景减少                            │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.4 适用场景

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表适用场景                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 【适合使用彩虹表】                                                   │
│ • Windows LM/NTLM 哈希（无盐）                                      │
│ • 简单的 MD5/SHA1 哈希（无盐）                                      │
│ • 旧版应用程序的密码哈希                                            │
│ • 某些数据库的密码存储（如旧版 MySQL）                              │
│ • 需要快速破解大量相同类型哈希                                      │
│                                                                      │
│ 【不适合使用彩虹表】                                                 │
│ • 加盐哈希（bcrypt, scrypt, Argon2）                                │
│ • 现代 Linux 密码（sha512crypt 带盐）                               │
│ • 现代 Web 应用密码（通常加盐）                                     │
│ • 长度超过表覆盖范围的密码                                          │
│ • 使用特殊字符集的密码                                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 原理详解

### 2.1 哈希链基础

彩虹表的核心是**哈希链**（Hash Chain）的概念。

```
┌─────────────────────────────────────────────────────────────────────┐
│ 哈希链原理                                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 哈希函数 H: 将密码转换为哈希值                                       │
│ 归约函数 R: 将哈希值转换回密码空间（不是解密！）                     │
│                                                                      │
│ 示例链（链长度 = 5）:                                                │
│                                                                      │
│ 起点      H        R        H        R        H        R       终点  │
│ "pass" ──→ 5f4d... ──→ "xyz1" ──→ a3b2... ──→ "qwer" ──→ 8c7f... ──→ "end1"│
│   │                                                              │   │
│   │                                                              │   │
│   └──────────────────── 只存储这两个 ─────────────────────────────┘   │
│                                                                      │
│ 存储: ("pass", "end1")                                              │
│ 节省: 只存储首尾，中间值可以重新计算                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 归约函数

归约函数（Reduction Function）是彩虹表的关键，它将哈希值映射回密码空间。

```python
# 归约函数示例（概念演示）
def reduction_function(hash_value, position, charset, password_length):
    """
    将哈希值转换为密码空间中的一个值
    
    参数:
    - hash_value: 哈希值（十六进制字符串）
    - position: 链中的位置（用于区分不同的归约函数）
    - charset: 字符集
    - password_length: 密码长度
    """
    # 将哈希转换为整数
    hash_int = int(hash_value, 16)
    
    # 加入位置信息，使每个位置的归约函数不同
    hash_int = (hash_int + position) % (len(charset) ** password_length)
    
    # 转换为密码
    password = ""
    for _ in range(password_length):
        password += charset[hash_int % len(charset)]
        hash_int //= len(charset)
    
    return password

# 示例
charset = "abcdefghijklmnopqrstuvwxyz0123456789"
hash_val = "5f4dcc3b5aa765d6"
print(reduction_function(hash_val, 0, charset, 6))  # 输出某个6位密码
print(reduction_function(hash_val, 1, charset, 6))  # 不同位置，不同结果
```

### 2.3 为什么叫"彩虹"表？

传统哈希链使用单一归约函数，容易产生链碰撞（merge）。彩虹表使用**多个不同的归约函数**，每个位置使用不同的函数，就像彩虹的不同颜色。

```
┌─────────────────────────────────────────────────────────────────────┐
│ 传统哈希链 vs 彩虹表                                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 【传统哈希链 - 单一归约函数】                                        │
│                                                                      │
│ 链1: P1 ─H→ h1 ─R→ P2 ─H→ h2 ─R→ P3 ─H→ h3 ─R→ P4                  │
│ 链2: Q1 ─H→ g1 ─R→ Q2 ─H→ g2 ─R→ P3 ─H→ h3 ─R→ P4  ← 碰撞！合并了  │
│                              ↑                                       │
│                         两条链在此合并，后续完全相同                  │
│                         浪费存储空间                                 │
│                                                                      │
│ 【彩虹表 - 多个归约函数 R1, R2, R3...】                              │
│                                                                      │
│ 链1: P1 ─H→ h1 ─R1→ P2 ─H→ h2 ─R2→ P3 ─H→ h3 ─R3→ P4               │
│ 链2: Q1 ─H→ g1 ─R1→ Q2 ─H→ g2 ─R2→ P3 ─H→ h3 ─R3→ P4               │
│                              ↑                                       │
│                    即使这里相同，由于 R3 ≠ R2                        │
│                    后续可能不同，减少合并                            │
│                                                                      │
│ 颜色比喻:                                                            │
│ R1=红, R2=橙, R3=黄, R4=绿, R5=蓝, R6=靛, R7=紫                     │
│ 像彩虹一样，每个位置颜色不同                                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 查找过程

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表查找算法                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 目标: 找到哈希值 H_target 对应的密码                                 │
│                                                                      │
│ 假设链长度为 k，归约函数为 R1, R2, ..., Rk                          │
│                                                                      │
│ 步骤:                                                                │
│                                                                      │
│ 1. 从最后一个归约函数开始                                            │
│    计算: Rk(H_target) → 检查是否是某条链的终点                       │
│                                                                      │
│ 2. 如果不是，尝试倒数第二个                                          │
│    计算: Rk(H(Rk-1(H_target))) → 检查终点                           │
│                                                                      │
│ 3. 继续向前，直到找到匹配的终点或尝试完所有位置                      │
│                                                                      │
│ 4. 找到终点后，从对应的起点重新计算链                                │
│    直到找到 H_target，前一个值就是密码                               │
│                                                                      │
│ 示例:                                                                │
│ 目标哈希: H_target = "abc123..."                                     │
│                                                                      │
│ 尝试1: R3(H_target) = "xyz" → 不在终点列表                          │
│ 尝试2: R3(H(R2(H_target))) = "end1" → 找到！对应起点 "pass"         │
│                                                                      │
│ 验证: "pass" ─H→ ... ─R2→ "qwer" ─H→ "abc123..." ✓                  │
│ 结果: 密码是 "qwer"                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```python
# 彩虹表查找伪代码
def rainbow_lookup(target_hash, rainbow_table, chain_length):
    """
    在彩虹表中查找目标哈希对应的密码
    """
    # 从最后一个位置开始尝试
    for i in range(chain_length - 1, -1, -1):
        # 从目标哈希开始，应用归约函数直到链尾
        current_hash = target_hash
        for j in range(i, chain_length):
            current_value = reduction(current_hash, j)
            current_hash = hash_function(current_value)
        
        endpoint = reduction(current_hash, chain_length - 1)
        
        # 检查是否在表中
        if endpoint in rainbow_table:
            startpoint = rainbow_table[endpoint]
            # 从起点重新计算，找到目标哈希前的密码
            password = verify_chain(startpoint, target_hash, i)
            if password:
                return password
    
    return None  # 未找到
```


### 2.5 参数与性能

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表关键参数                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. 链长度 (Chain Length / t)                                        │
│    • 越长 → 存储越小，查找越慢                                       │
│    • 越短 → 存储越大，查找越快                                       │
│    • 典型值: 1000 - 10000                                           │
│                                                                      │
│ 2. 链数量 (Number of Chains / m)                                    │
│    • 越多 → 覆盖率越高，存储越大                                     │
│    • 需要足够多以覆盖密码空间                                        │
│                                                                      │
│ 3. 字符集 (Charset)                                                  │
│    • 小写字母: 26 字符                                               │
│    • 小写+数字: 36 字符                                              │
│    • 大小写+数字: 62 字符                                            │
│    • 全部可打印: 95 字符                                             │
│                                                                      │
│ 4. 密码长度 (Password Length)                                        │
│    • 密码空间 = charset^length                                       │
│    • 6位小写: 26^6 ≈ 3亿                                            │
│    • 8位小写+数字: 36^8 ≈ 2.8万亿                                   │
│                                                                      │
│ 5. 成功率 (Success Rate)                                             │
│    • 取决于表的覆盖率                                                │
│    • 通常 95-99.9%                                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 存储空间估算                                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 公式: 存储 ≈ (密码空间 / 链长度) × (起点大小 + 终点大小)            │
│                                                                      │
│ 示例: 6位小写字母 MD5                                                │
│ • 密码空间: 26^6 = 308,915,776                                      │
│ • 链长度: 2400                                                       │
│ • 链数量: 308,915,776 / 2400 ≈ 128,715                              │
│ • 每条链: 6字节(起点) + 8字节(终点) = 14字节                        │
│ • 总存储: 128,715 × 14 ≈ 1.7 MB                                     │
│                                                                      │
│ 实际表大小（参考）:                                                  │
│ • LM 哈希 (1-7位): ~500 MB                                          │
│ • NTLM (1-8位混合): ~20-100 GB                                      │
│ • MD5 (1-8位字母数字): ~100+ GB                                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 工具介绍

### 3.1 主流彩虹表工具

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表工具对比                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 工具          │ 特点                        │ 适用场景              │
│ ──────────────┼─────────────────────────────┼─────────────────────  │
│ RainbowCrack  │ 功能全面，支持多种哈希      │ 通用彩虹表破解        │
│               │ 可生成和使用彩虹表          │                       │
│ ──────────────┼─────────────────────────────┼─────────────────────  │
│ Ophcrack      │ 专注 Windows 密码           │ LM/NTLM 哈希破解      │
│               │ 图形界面，易于使用          │                       │
│ ──────────────┼─────────────────────────────┼─────────────────────  │
│ rcracki_mt    │ RainbowCrack 的多线程版本   │ 高性能破解            │
│               │ 支持 .rti2 格式             │                       │
│ ──────────────┼─────────────────────────────┼─────────────────────  │
│ Cain & Abel   │ Windows 工具，集成彩虹表    │ Windows 环境          │
│               │ 已停止更新                  │                       │
│ ──────────────┼─────────────────────────────┼─────────────────────  │
│ 在线服务      │ 无需下载表，即查即用        │ 快速查询单个哈希      │
│               │ 覆盖有限                    │                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 彩虹表文件格式

```bash
# 常见彩虹表文件格式

# .rt 格式 (RainbowCrack 原始格式)
# 文件名包含参数信息
# 格式: algorithm_charset_minlen_maxlen_index_chainlen_chaincount_partindex.rt
# 示例: md5_loweralpha#1-7_0_2400x67108864_0.rt

# .rti 格式 (RainbowCrack 索引格式)
# 带索引，查找更快
# 示例: md5_loweralpha#1-7_0_2400x67108864_0.rti

# .rti2 格式 (压缩索引格式)
# 更小的存储空间
# 示例: md5_loweralpha#1-7_0_2400x67108864_0.rti2

# Ophcrack 表格式
# 专用于 LM/NTLM
# 通常打包为 .zip 或目录

# 文件名解析示例
# md5_loweralpha-numeric#1-8_0_3800x33554432_0.rt
# │   │                  │ │ │    │        │
# │   │                  │ │ │    │        └─ 分区索引
# │   │                  │ │ │    └─ 链数量 (33554432)
# │   │                  │ │ └─ 链长度 (3800)
# │   │                  │ └─ 表索引
# │   │                  └─ 密码长度范围 (1-8)
# │   └─ 字符集 (小写字母+数字)
# └─ 哈希算法 (MD5)
```

### 3.3 彩虹表下载源

```bash
# 官方和知名下载源

# 1. RainbowCrack 官方
# http://project-rainbowcrack.com/table.htm
# 提供多种哈希类型的表

# 2. Ophcrack 官方表
# https://ophcrack.sourceforge.io/tables.php
# 专门用于 Windows 密码

# 3. Free Rainbow Tables
# https://freerainbowtables.com/
# 社区维护的免费表

# 4. Hashes.org
# https://hashes.org/
# 在线查询服务

# 常用表下载
# Ophcrack XP Free (小型)
wget https://ophcrack.sourceforge.io/tables/xp_free_small.zip

# Ophcrack Vista Free
wget https://ophcrack.sourceforge.io/tables/vista_free.zip

# 注意: 大型表可能需要 BitTorrent 下载
```

---

## 4. RainbowCrack 使用

### 4.1 安装

```bash
# Kali Linux (预装或通过 apt)
sudo apt update
sudo apt install rainbowcrack

# 从源码编译
git clone https://github.com/inAudible-NG/RainbowCrack-NG.git
cd RainbowCrack-NG
make

# Windows
# 从官网下载: http://project-rainbowcrack.com/
# 解压即可使用

# 验证安装
rtgen -h
rcrack -h
```

### 4.2 核心工具

```bash
# RainbowCrack 工具集
┌──────────────┬────────────────────────────────────────────────────┐
│ 工具          │ 功能                                               │
├──────────────┼────────────────────────────────────────────────────┤
│ rtgen        │ 生成彩虹表                                         │
│ rtsort       │ 排序彩虹表（必须在使用前排序）                      │
│ rcrack       │ 使用彩虹表破解哈希                                  │
│ rt2rtc       │ 将 .rt 转换为压缩格式 .rtc                         │
│ rtc2rt       │ 将 .rtc 转换回 .rt                                 │
│ rtmerge      │ 合并多个彩虹表                                     │
└──────────────┴────────────────────────────────────────────────────┘
```

### 4.3 生成彩虹表

```bash
# rtgen 语法
rtgen <hash_algorithm> <charset> <min_len> <max_len> <table_index> <chain_len> <chain_num> <part_index>

# 参数说明
# hash_algorithm: 哈希算法 (md5, sha1, ntlm, lm 等)
# charset: 字符集
# min_len: 最小密码长度
# max_len: 最大密码长度
# table_index: 表索引 (用于生成多个表)
# chain_len: 链长度
# chain_num: 链数量
# part_index: 分区索引

# 预定义字符集
# loweralpha          = abcdefghijklmnopqrstuvwxyz
# upperalpha          = ABCDEFGHIJKLMNOPQRSTUVWXYZ
# mixalpha            = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
# loweralpha-numeric  = abcdefghijklmnopqrstuvwxyz0123456789
# upperalpha-numeric  = ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789
# mixalpha-numeric    = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789
# numeric             = 0123456789
# ascii-32-95         = 所有可打印 ASCII 字符

# 示例: 生成 MD5 小写字母 1-6 位的彩虹表
rtgen md5 loweralpha 1 6 0 2400 8000000 0

# 生成 NTLM 表
rtgen ntlm loweralpha-numeric 1 7 0 2400 16000000 0

# 生成多个分区（大表需要分区）
rtgen md5 loweralpha 1 7 0 2400 33554432 0
rtgen md5 loweralpha 1 7 0 2400 33554432 1
rtgen md5 loweralpha 1 7 0 2400 33554432 2
# ... 继续生成更多分区

# 生成后必须排序
rtsort *.rt
```

### 4.4 排序彩虹表

```bash
# 排序是必须的步骤！未排序的表无法使用

# 排序单个文件
rtsort md5_loweralpha#1-6_0_2400x8000000_0.rt

# 排序目录下所有 .rt 文件
rtsort .

# 排序后文件扩展名不变，但内容已排序
# 可以通过文件大小变化确认排序完成
```

### 4.5 使用彩虹表破解

```bash
# rcrack 语法
rcrack <rainbow_table_path> -h <hash>
rcrack <rainbow_table_path> -l <hash_file>
rcrack <rainbow_table_path> -f <pwdump_file>

# 破解单个哈希
rcrack /path/to/tables/ -h 5f4dcc3b5aa765d61d8327deb882cf99

# 破解哈希文件
echo "5f4dcc3b5aa765d61d8327deb882cf99" > hashes.txt
echo "e10adc3949ba59abbe56e057f20f883e" >> hashes.txt
rcrack /path/to/tables/ -l hashes.txt

# 破解 pwdump 格式文件
rcrack /path/to/tables/ -f pwdump.txt

# 使用多个表目录
rcrack /path/to/md5_tables/ /path/to/more_tables/ -h <hash>

# 指定线程数
rcrack /path/to/tables/ -h <hash> -t 4

# 输出示例
# statistics
# -------------------------------------------------------
# plaintext found:            1 of 1 (100.00%)
# total time:                 2.34 s
# 
# result
# -------------------------------------------------------
# 5f4dcc3b5aa765d61d8327deb882cf99  password  hex:70617373776f7264
```

### 4.6 rcracki_mt（多线程版本）

```bash
# rcracki_mt 是 rcrack 的改进版本
# 支持多线程和 .rti2 格式

# 安装
sudo apt install rcracki-mt

# 使用方法类似
rcracki_mt -h <hash> /path/to/tables/*.rti2
rcracki_mt -l hashes.txt /path/to/tables/*.rti2

# 指定线程
rcracki_mt -t 8 -h <hash> /path/to/tables/

# 显示进度
rcracki_mt -v -h <hash> /path/to/tables/
```


---

## 5. Ophcrack 使用

### 5.1 简介

Ophcrack 是专门用于破解 Windows 密码的彩虹表工具，支持 LM 和 NTLM 哈希，提供图形界面和命令行两种模式。

```
┌─────────────────────────────────────────────────────────────────────┐
│ Ophcrack 特点                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ • 专注于 Windows 密码破解                                           │
│ • 图形界面友好，适合初学者                                          │
│ • 提供 LiveCD 版本，可直接启动破解                                  │
│ • 免费表可破解大部分简单密码                                        │
│ • 支持从 SAM 文件直接提取哈希                                       │
│                                                                      │
│ 支持的哈希类型:                                                      │
│ • LM (Windows XP 及更早)                                            │
│ • NTLM (Windows Vista 及更新)                                       │
│ • NT (纯 NTLM)                                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 安装

```bash
# Kali Linux
sudo apt update
sudo apt install ophcrack ophcrack-cli

# Ubuntu/Debian
sudo apt install ophcrack

# 下载彩虹表
# 访问: https://ophcrack.sourceforge.io/tables.php

# 可用的表
# XP Free Small (380 MB) - 免费，覆盖率低
# XP Free Fast (703 MB) - 免费，速度快
# XP Special (7.5 GB) - 付费，覆盖率高
# Vista Free (461 MB) - 免费，用于 Vista/7/8/10
# Vista Special (8 GB) - 付费

# 下载免费表
wget https://ophcrack.sourceforge.io/tables/xp_free_small.zip
wget https://ophcrack.sourceforge.io/tables/vista_free.zip

# 解压
unzip xp_free_small.zip -d /usr/share/ophcrack/tables/
unzip vista_free.zip -d /usr/share/ophcrack/tables/
```

### 5.3 图形界面使用

```bash
# 启动图形界面
ophcrack

# 操作步骤:
# 1. Tables → Install 安装彩虹表
#    选择表目录，点击 Install
#
# 2. Load → 加载哈希
#    - PWDUMP file: 加载 pwdump 格式文件
#    - Single hash: 输入单个哈希
#    - Encrypted SAM: 加载 SAM 文件（需要 SYSTEM 文件）
#    - Local SAM: 从本地系统提取（需要管理员权限）
#
# 3. Crack → 开始破解
#
# 4. 查看结果
#    破解成功的密码会显示在 NT Pwd 或 LM Pwd 列
```

### 5.4 命令行使用

```bash
# ophcrack-cli 语法
ophcrack-cli [options]

# 常用选项
-g          # 禁用 GUI
-d <dir>    # 彩虹表目录
-t <tables> # 指定表类型
-f <file>   # 哈希文件 (pwdump 格式)
-n <num>    # 线程数
-o <file>   # 输出文件
-s          # 显示统计信息

# 示例: 破解 pwdump 文件
ophcrack-cli -g -d /path/to/tables -t xp_free_small -f pwdump.txt

# 使用多个表
ophcrack-cli -g -d /path/to/tables -t xp_free_small,vista_free -f pwdump.txt

# 输出到文件
ophcrack-cli -g -d /path/to/tables -t vista_free -f pwdump.txt -o results.txt

# 显示统计
ophcrack-cli -g -d /path/to/tables -t vista_free -f pwdump.txt -s
```

### 5.5 获取 Windows 哈希

```bash
# 方法 1: 使用 pwdump 工具（在 Windows 上）
# 需要管理员权限
pwdump.exe > hashes.txt

# 方法 2: 使用 mimikatz（在 Windows 上）
mimikatz.exe
sekurlsa::logonpasswords

# 方法 3: 使用 secretsdump（远程或本地）
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
impacket-secretsdump domain/user:password@target

# 方法 4: 从离线 SAM 文件提取
# 复制 SAM 和 SYSTEM 文件
# Windows: C:\Windows\System32\config\SAM
#          C:\Windows\System32\config\SYSTEM

# 使用 samdump2
samdump2 SYSTEM SAM > hashes.txt

# 使用 impacket
impacket-secretsdump -sam SAM -system SYSTEM LOCAL

# pwdump 格式说明
# username:RID:LM_hash:NTLM_hash:::
# 示例:
# Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

### 5.6 Ophcrack LiveCD

```bash
# Ophcrack LiveCD 是一个可启动的 Linux 系统
# 包含 Ophcrack 和彩虹表，可直接破解本地 Windows 密码

# 下载 LiveCD
# https://ophcrack.sourceforge.io/download.php

# 制作启动 U 盘
# Linux
sudo dd if=ophcrack-vista-livecd.iso of=/dev/sdX bs=4M status=progress

# Windows (使用 Rufus)
# 选择 ISO 文件，选择 U 盘，点击开始

# 使用步骤:
# 1. 从 U 盘启动目标计算机
# 2. 选择 Ophcrack Graphic mode
# 3. 系统自动检测 Windows 分区并提取哈希
# 4. 自动开始破解
# 5. 等待结果

# 注意:
# - LiveCD 包含的表有限，复杂密码可能无法破解
# - 可以手动添加更多表到 U 盘
```

---

## 6. 在线彩虹表服务

### 6.1 常用在线服务

```
┌─────────────────────────────────────────────────────────────────────┐
│ 在线彩虹表/哈希查询服务                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. CrackStation                                                      │
│    网址: https://crackstation.net/                                  │
│    特点: 免费，支持多种哈希，数据库大                                │
│    支持: MD5, SHA1, SHA256, SHA512, NTLM 等                         │
│                                                                      │
│ 2. Hashes.org                                                        │
│    网址: https://hashes.org/                                        │
│    特点: 社区驱动，可提交和查询                                      │
│    支持: 多种哈希类型                                                │
│                                                                      │
│ 3. HashKiller                                                        │
│    网址: https://hashkiller.io/                                     │
│    特点: 免费查询，有 API                                           │
│    支持: MD5, SHA1, NTLM 等                                         │
│                                                                      │
│ 4. CMD5                                                              │
│    网址: https://www.cmd5.com/                                      │
│    特点: 中文界面，数据库大                                          │
│    支持: MD5, SHA1 等                                               │
│                                                                      │
│ 5. OnlineHashCrack                                                   │
│    网址: https://www.onlinehashcrack.com/                           │
│    特点: 支持文件上传，付费服务                                      │
│    支持: 多种哈希和加密文件                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 使用示例

```bash
# 使用 curl 查询在线服务

# CrackStation (需要在网页上操作)
# 访问 https://crackstation.net/
# 粘贴哈希值，点击 Crack Hashes

# 使用 API（如果提供）
# HashKiller API 示例
curl "https://hashkiller.io/api/search?hash=5f4dcc3b5aa765d61d8327deb882cf99"

# 批量查询脚本
#!/bin/bash
while read hash; do
    result=$(curl -s "https://api.example.com/lookup?hash=$hash")
    echo "$hash: $result"
done < hashes.txt

# Python 脚本示例
import requests

def lookup_hash(hash_value):
    """在线查询哈希"""
    # CrackStation 不提供公开 API，这里是示例
    url = f"https://api.hashservice.com/lookup/{hash_value}"
    try:
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            return response.json().get('plaintext', 'Not found')
    except:
        pass
    return 'Error'

# 使用
hashes = [
    "5f4dcc3b5aa765d61d8327deb882cf99",
    "e10adc3949ba59abbe56e057f20f883e"
]

for h in hashes:
    print(f"{h}: {lookup_hash(h)}")
```

### 6.3 注意事项

```
┌─────────────────────────────────────────────────────────────────────┐
│ 使用在线服务的注意事项                                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ ⚠️ 隐私风险                                                          │
│ • 上传的哈希可能被记录                                               │
│ • 敏感哈希不要使用在线服务                                           │
│ • 考虑使用本地工具                                                   │
│                                                                      │
│ ⚠️ 法律风险                                                          │
│ • 确保有权破解这些哈希                                               │
│ • 某些服务可能记录 IP                                                │
│                                                                      │
│ ⚠️ 可靠性                                                            │
│ • 在线服务可能不稳定                                                 │
│ • 覆盖率有限                                                         │
│ • 可能有查询限制                                                     │
│                                                                      │
│ ✓ 适合场景                                                           │
│ • 快速验证单个哈希                                                   │
│ • CTF 比赛                                                           │
│ • 学习和测试                                                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. 生成自定义彩虹表

### 7.1 规划彩虹表

```
┌─────────────────────────────────────────────────────────────────────┐
│ 生成彩虹表前的规划                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. 确定目标                                                          │
│    • 哈希类型: MD5? SHA1? NTLM?                                     │
│    • 密码长度: 1-6? 1-8?                                            │
│    • 字符集: 纯数字? 字母数字? 包含特殊字符?                        │
│                                                                      │
│ 2. 计算密码空间                                                      │
│    • 小写字母 1-6位: 26^1 + 26^2 + ... + 26^6 ≈ 3.1亿              │
│    • 字母数字 1-8位: 36^1 + ... + 36^8 ≈ 2.9万亿                   │
│                                                                      │
│ 3. 估算存储需求                                                      │
│    • 每条链约 16 字节                                                │
│    • 链数量 = 密码空间 / 链长度                                      │
│    • 存储 = 链数量 × 16 字节                                        │
│                                                                      │
│ 4. 估算生成时间                                                      │
│    • 取决于 CPU/GPU 性能                                            │
│    • 大表可能需要数天到数周                                          │
│                                                                      │
│ 5. 选择参数                                                          │
│    • 链长度: 通常 2000-5000                                         │
│    • 表数量: 根据成功率需求                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 使用 rtgen 生成

```bash
# 示例 1: 生成小型 MD5 表（测试用）
# 小写字母 1-5 位
rtgen md5 loweralpha 1 5 0 1000 1000000 0

# 排序
rtsort md5_loweralpha#1-5_0_1000x1000000_0.rt

# 示例 2: 生成中型 NTLM 表
# 小写字母+数字 1-7 位
# 分多个部分生成
for i in {0..7}; do
    rtgen ntlm loweralpha-numeric 1 7 0 2400 16777216 $i
done

# 排序所有文件
rtsort *.rt

# 示例 3: 生成大型表（需要大量时间和空间）
# 混合字符 1-8 位
# 这需要 TB 级存储和数周时间
rtgen md5 mixalpha-numeric 1 8 0 3800 134217728 0
# ... 需要生成多个分区

# 使用 GPU 加速生成（如果支持）
# 某些版本支持 CUDA
rtgen_cuda md5 loweralpha 1 7 0 2400 67108864 0
```

### 7.3 参数优化

```bash
# 链长度选择
# 短链 (1000-2000): 查找快，存储大
# 中链 (2000-4000): 平衡
# 长链 (4000-10000): 存储小，查找慢

# 成功率与表数量
# 单表成功率约 63.2% (1 - 1/e)
# 多表可提高成功率:
# 2 表: ~86%
# 3 表: ~95%
# 4 表: ~98%
# 5 表: ~99%

# 生成多个表以提高成功率
for idx in {0..4}; do
    rtgen md5 loweralpha 1 6 $idx 2400 8000000 0
done

# 合并表（可选）
rtmerge md5_loweralpha*.rt merged_table.rt
```

### 7.4 自定义字符集

```bash
# RainbowCrack 支持自定义字符集
# 编辑 charset.txt 文件

# 创建自定义字符集文件
cat > charset.txt << EOF
# 自定义字符集
# 格式: name = [characters]

# 只有数字
numeric = [0123456789]

# 小写字母
loweralpha = [abcdefghijklmnopqrstuvwxyz]

# 常见密码字符
common = [abcdefghijklmnopqrstuvwxyz0123456789!@#$]

# 十六进制
hex = [0123456789abcdef]

# 自定义: 小写+常用特殊字符
mycharset = [abcdefghijklmnopqrstuvwxyz0123456789!@#]
EOF

# 使用自定义字符集
rtgen md5 mycharset 1 6 0 2400 8000000 0
```

### 7.5 分布式生成

```bash
# 在多台机器上并行生成

# 机器 1: 生成分区 0-9
for i in {0..9}; do
    rtgen md5 loweralpha-numeric 1 8 0 3800 33554432 $i
done

# 机器 2: 生成分区 10-19
for i in {10..19}; do
    rtgen md5 loweralpha-numeric 1 8 0 3800 33554432 $i
done

# 机器 3: 生成分区 20-29
for i in {20..29}; do
    rtgen md5 loweralpha-numeric 1 8 0 3800 33554432 $i
done

# 完成后合并所有文件
# 复制到同一目录
# 排序
rtsort *.rt
```


---

## 8. 实战案例

### 8.1 破解 Windows 本地密码

```bash
# 场景: 忘记 Windows 登录密码，需要恢复

# 方法 1: 使用 Ophcrack LiveCD
# 1. 下载 Ophcrack LiveCD
# 2. 制作启动 U 盘
# 3. 从 U 盘启动目标计算机
# 4. 自动提取并破解密码

# 方法 2: 提取 SAM 文件后破解
# 步骤 1: 使用 Linux LiveCD 启动
# 步骤 2: 挂载 Windows 分区
sudo mount /dev/sda2 /mnt/windows

# 步骤 3: 复制 SAM 和 SYSTEM 文件
cp /mnt/windows/Windows/System32/config/SAM ./
cp /mnt/windows/Windows/System32/config/SYSTEM ./

# 步骤 4: 提取哈希
impacket-secretsdump -sam SAM -system SYSTEM LOCAL > hashes.txt

# 或使用 samdump2
samdump2 SYSTEM SAM > hashes.txt

# 步骤 5: 使用彩虹表破解
# 使用 Ophcrack
ophcrack-cli -g -d /path/to/tables -t vista_free -f hashes.txt

# 或使用 RainbowCrack
# 提取 NTLM 哈希部分
cat hashes.txt | cut -d: -f4 > ntlm_hashes.txt
rcrack /path/to/ntlm_tables/ -l ntlm_hashes.txt

# 输出示例
# Administrator:500:aad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
# 破解结果: password123
```

### 8.2 破解域控制器哈希

```bash
# 场景: 渗透测试中获取了域控制器的 NTDS.dit

# 步骤 1: 提取哈希
# 使用 impacket-secretsdump
impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL -outputfile domain_hashes

# 或使用 DSInternals (PowerShell)
# Get-ADDBAccount -All -DBPath 'C:\path\to\ntds.dit' -BootKey $bootkey

# 步骤 2: 整理哈希文件
# 提取 NTLM 哈希
cat domain_hashes.ntds | grep -v '\$' | cut -d: -f4 > ntlm_hashes.txt

# 步骤 3: 使用彩虹表破解
rcrack /path/to/ntlm_tables/ -l ntlm_hashes.txt -t 8

# 步骤 4: 对于未破解的，使用 Hashcat
hashcat -m 1000 -a 0 ntlm_hashes.txt /usr/share/wordlists/rockyou.txt

# 注意: 域环境通常有密码策略
# 彩虹表可能无法覆盖复杂密码
# 建议结合字典攻击和规则攻击
```

### 8.3 破解 MD5 哈希

```bash
# 场景: 从数据库泄露中获取了 MD5 哈希

# 准备哈希文件
cat > md5_hashes.txt << EOF
5f4dcc3b5aa765d61d8327deb882cf99
e10adc3949ba59abbe56e057f20f883e
d8578edf8458ce06fbc5bb76a58c5ca4
25f9e794323b453885f5181f1b624d0b
827ccb0eea8a706c4c34a16891f84e7b
EOF

# 方法 1: 在线查询
# 访问 https://crackstation.net/
# 粘贴哈希，查看结果

# 方法 2: 使用本地彩虹表
rcrack /path/to/md5_tables/ -l md5_hashes.txt

# 方法 3: 如果没有彩虹表，使用 Hashcat
hashcat -m 0 -a 0 md5_hashes.txt /usr/share/wordlists/rockyou.txt

# 结果
# 5f4dcc3b5aa765d61d8327deb882cf99 -> password
# e10adc3949ba59abbe56e057f20f883e -> 123456
# d8578edf8458ce06fbc5bb76a58c5ca4 -> qwerty
# 25f9e794323b453885f5181f1b624d0b -> 123456789
# 827ccb0eea8a706c4c34a16891f84e7b -> 12345
```

### 8.4 破解 LM 哈希（旧系统）

```bash
# 场景: 遇到 Windows XP 或更早系统的 LM 哈希

# LM 哈希特点:
# - 最大 14 字符，分成两个 7 字符部分
# - 转换为大写
# - 无盐
# - 非常容易破解

# 示例 LM 哈希
# aad3b435b51404eeaad3b435b51404ee (空密码)
# 44efce164ab921caaad3b435b51404ee (密码 <= 7 字符)

# 使用 Ophcrack 破解
ophcrack-cli -g -d /path/to/tables -t xp_free_small -f lm_hashes.txt

# 使用 RainbowCrack
rcrack /path/to/lm_tables/ -l lm_hashes.txt

# LM 哈希的弱点利用
# 如果后半部分是 aad3b435b51404ee，说明密码 <= 7 字符
# 可以只破解前半部分

# 分离 LM 哈希的两部分
cat lm_hashes.txt | while read hash; do
    echo "${hash:0:16}"   # 前半部分
    echo "${hash:16:16}"  # 后半部分
done > lm_parts.txt

# 破解后组合结果
# 注意: LM 哈希不保留大小写，需要尝试不同组合
```

### 8.5 CTF 比赛实战

```bash
# 场景: CTF 比赛中遇到哈希破解题目

# 步骤 1: 识别哈希类型
hashid '5f4dcc3b5aa765d61d8327deb882cf99'
# 输出: [+] MD5

# 步骤 2: 尝试在线查询（最快）
# 访问 CrackStation, Hashes.org 等

# 步骤 3: 如果在线查不到，使用本地工具
# 彩虹表
rcrack /path/to/tables/ -h 5f4dcc3b5aa765d61d8327deb882cf99

# 字典攻击
hashcat -m 0 -a 0 hash.txt /usr/share/wordlists/rockyou.txt

# 步骤 4: 如果是特殊格式，分析题目提示
# 例如: 密码是 6 位数字
hashcat -m 0 -a 3 hash.txt ?d?d?d?d?d?d

# 步骤 5: 考虑编码问题
# Base64 编码的哈希
echo "NWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTk=" | base64 -d
# 输出: 5f4dcc3b5aa765d61d8327deb882cf99

# 双重哈希
# md5(md5(password))
# 需要特殊处理
```

### 8.6 批量破解脚本

```python
#!/usr/bin/env python3
"""
批量哈希破解脚本
结合在线查询和本地彩虹表
"""

import hashlib
import requests
import subprocess
import sys

def online_lookup(hash_value):
    """在线查询哈希"""
    # CrackStation API (示例，实际可能需要不同的 API)
    try:
        # 这里使用假设的 API
        response = requests.get(
            f"https://api.example.com/lookup/{hash_value}",
            timeout=5
        )
        if response.status_code == 200:
            data = response.json()
            if data.get('found'):
                return data.get('plaintext')
    except:
        pass
    return None

def rainbow_lookup(hash_value, table_path):
    """使用本地彩虹表查询"""
    try:
        result = subprocess.run(
            ['rcrack', table_path, '-h', hash_value],
            capture_output=True,
            text=True,
            timeout=60
        )
        # 解析输出
        for line in result.stdout.split('\n'):
            if hash_value in line and 'hex:' in line:
                parts = line.split()
                for i, part in enumerate(parts):
                    if part == hash_value and i + 1 < len(parts):
                        return parts[i + 1]
    except:
        pass
    return None

def crack_hashes(hash_file, table_path=None):
    """批量破解哈希"""
    results = {}
    
    with open(hash_file, 'r') as f:
        hashes = [line.strip() for line in f if line.strip()]
    
    for hash_value in hashes:
        print(f"[*] 正在破解: {hash_value}")
        
        # 1. 尝试在线查询
        plaintext = online_lookup(hash_value)
        if plaintext:
            print(f"[+] 在线找到: {plaintext}")
            results[hash_value] = plaintext
            continue
        
        # 2. 尝试本地彩虹表
        if table_path:
            plaintext = rainbow_lookup(hash_value, table_path)
            if plaintext:
                print(f"[+] 彩虹表找到: {plaintext}")
                results[hash_value] = plaintext
                continue
        
        print(f"[-] 未找到: {hash_value}")
        results[hash_value] = None
    
    return results

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"用法: {sys.argv[0]} <hash_file> [table_path]")
        sys.exit(1)
    
    hash_file = sys.argv[1]
    table_path = sys.argv[2] if len(sys.argv) > 2 else None
    
    results = crack_hashes(hash_file, table_path)
    
    print("\n=== 结果汇总 ===")
    for hash_val, plaintext in results.items():
        status = plaintext if plaintext else "未破解"
        print(f"{hash_val}: {status}")
```

---

## 9. 防御措施

### 9.1 为什么彩虹表攻击有效？

```
┌─────────────────────────────────────────────────────────────────────┐
│ 彩虹表攻击成功的条件                                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. 使用无盐哈希                                                      │
│    相同密码 → 相同哈希 → 可以预计算                                 │
│                                                                      │
│ 2. 使用快速哈希算法                                                  │
│    MD5, SHA1 等设计用于速度                                         │
│    攻击者可以快速生成彩虹表                                          │
│                                                                      │
│ 3. 密码在可预测范围内                                                │
│    短密码、常见字符集                                                │
│    彩虹表可以覆盖                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 9.2 加盐 (Salt)

**加盐**是防御彩虹表最有效的方法。

```
┌─────────────────────────────────────────────────────────────────────┐
│ 加盐原理                                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 无盐哈希:                                                            │
│ password → MD5 → 5f4dcc3b5aa765d61d8327deb882cf99                   │
│ password → MD5 → 5f4dcc3b5aa765d61d8327deb882cf99  (相同！)         │
│                                                                      │
│ 加盐哈希:                                                            │
│ password + salt1 → MD5 → a1b2c3d4e5f6...                            │
│ password + salt2 → MD5 → x9y8z7w6v5u4...  (不同！)                  │
│                                                                      │
│ 效果:                                                                │
│ • 相同密码产生不同哈希                                               │
│ • 每个盐需要单独的彩虹表                                             │
│ • 如果盐足够随机，彩虹表攻击不可行                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```python
# 正确的加盐实现
import os
import hashlib

def hash_password(password):
    """安全的密码哈希"""
    # 生成随机盐 (16 字节 = 128 位)
    salt = os.urandom(16)
    
    # 使用 PBKDF2 (推荐)
    hash_value = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt,
        100000  # 迭代次数
    )
    
    # 存储: 盐 + 哈希
    return salt + hash_value

def verify_password(password, stored_hash):
    """验证密码"""
    salt = stored_hash[:16]
    stored_value = stored_hash[16:]
    
    hash_value = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt,
        100000
    )
    
    return hash_value == stored_value

# 使用示例
stored = hash_password("mypassword")
print(verify_password("mypassword", stored))  # True
print(verify_password("wrongpassword", stored))  # False
```

### 9.3 使用慢速哈希算法

```
┌─────────────────────────────────────────────────────────────────────┐
│ 推荐的密码哈希算法 (2024/2025)                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. Argon2 (推荐首选)                                                 │
│    • 2015 年密码哈希竞赛冠军                                        │
│    • 抵抗 GPU 和 ASIC 攻击                                          │
│    • 可配置内存、时间、并行度                                        │
│                                                                      │
│ 2. bcrypt                                                            │
│    • 成熟稳定，广泛使用                                              │
│    • 内置盐                                                          │
│    • 可调整工作因子                                                  │
│                                                                      │
│ 3. scrypt                                                            │
│    • 内存密集型                                                      │
│    • 抵抗硬件攻击                                                    │
│                                                                      │
│ 4. PBKDF2                                                            │
│    • 标准化，兼容性好                                                │
│    • 需要足够的迭代次数                                              │
│                                                                      │
│ ❌ 不要使用:                                                         │
│ • 纯 MD5, SHA1, SHA256                                              │
│ • 无盐哈希                                                           │
│ • 自制哈希算法                                                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```python
# 使用 bcrypt
import bcrypt

def hash_password_bcrypt(password):
    """使用 bcrypt 哈希密码"""
    salt = bcrypt.gensalt(rounds=12)  # 工作因子 12
    return bcrypt.hashpw(password.encode('utf-8'), salt)

def verify_bcrypt(password, hashed):
    """验证 bcrypt 密码"""
    return bcrypt.checkpw(password.encode('utf-8'), hashed)

# 使用 Argon2
from argon2 import PasswordHasher

ph = PasswordHasher(
    time_cost=3,      # 迭代次数
    memory_cost=65536, # 内存使用 (KB)
    parallelism=4     # 并行度
)

def hash_password_argon2(password):
    """使用 Argon2 哈希密码"""
    return ph.hash(password)

def verify_argon2(password, hashed):
    """验证 Argon2 密码"""
    try:
        ph.verify(hashed, password)
        return True
    except:
        return False
```

### 9.4 密码策略

```
┌─────────────────────────────────────────────────────────────────────┐
│ 密码策略建议                                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. 长度要求                                                          │
│    • 最小 12 字符（推荐 16+）                                       │
│    • 长度比复杂度更重要                                              │
│                                                                      │
│ 2. 复杂度要求（可选）                                                │
│    • 大小写字母                                                      │
│    • 数字                                                            │
│    • 特殊字符                                                        │
│    • 但不要过于复杂导致用户写下密码                                  │
│                                                                      │
│ 3. 禁止常见密码                                                      │
│    • 检查密码是否在常见密码列表中                                    │
│    • 使用 Have I Been Pwned API                                     │
│                                                                      │
│ 4. 多因素认证 (MFA)                                                  │
│    • 即使密码泄露也能保护账户                                        │
│    • 推荐 TOTP 或硬件密钥                                           │
│                                                                      │
│ 5. 密码管理器                                                        │
│    • 鼓励用户使用密码管理器                                          │
│    • 每个账户使用唯一密码                                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```


---

## 10. 常见错误与解决

### 10.1 彩虹表相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: rainbow table is not sorted                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 彩虹表文件未排序，无法使用                                           │
│                                                                      │
│ 解决方案:                                                            │
│ # 排序彩虹表                                                         │
│ rtsort /path/to/table.rt                                            │
│                                                                      │
│ # 排序目录下所有表                                                   │
│ rtsort /path/to/tables/                                             │
│                                                                      │
│ # 验证排序                                                           │
│ # 排序后文件大小可能略有变化                                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: hash algorithm mismatch                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 彩虹表的哈希算法与目标哈希不匹配                                     │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 确认哈希类型                                                    │
│ hashid 'your_hash_here'                                             │
│                                                                      │
│ # 2. 使用正确的彩虹表                                                │
│ # MD5 哈希 → 使用 md5_*.rt                                          │
│ # NTLM 哈希 → 使用 ntlm_*.rt                                        │
│ # SHA1 哈希 → 使用 sha1_*.rt                                        │
│                                                                      │
│ # 3. 检查表文件名中的算法标识                                        │
│ ls *.rt | head                                                       │
│ # md5_loweralpha#1-7_0_2400x67108864_0.rt                           │
│ # ↑ 算法                                                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: plaintext not found                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 1. 密码不在彩虹表覆盖范围内                                          │
│ 2. 密码长度超出表的范围                                              │
│ 3. 密码使用了表中没有的字符                                          │
│ 4. 哈希是加盐的                                                      │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 检查表的覆盖范围                                                │
│ # 文件名: md5_loweralpha#1-7_0_...                                  │
│ # 表示: 小写字母，1-7 位                                            │
│                                                                      │
│ # 2. 使用更大的表或不同字符集的表                                    │
│                                                                      │
│ # 3. 检查是否加盐                                                    │
│ # 加盐哈希无法用彩虹表破解                                           │
│ # 需要使用 Hashcat 等工具                                           │
│                                                                      │
│ # 4. 尝试其他方法                                                    │
│ hashcat -m 0 -a 0 hash.txt wordlist.txt                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.2 工具相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: Ophcrack - No tables installed                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 未安装或未正确配置彩虹表                                             │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 下载彩虹表                                                      │
│ wget https://ophcrack.sourceforge.io/tables/vista_free.zip          │
│                                                                      │
│ # 2. 解压到正确位置                                                  │
│ unzip vista_free.zip -d /usr/share/ophcrack/tables/                 │
│                                                                      │
│ # 3. 在 Ophcrack 中安装                                             │
│ # GUI: Tables → Install → 选择目录                                  │
│ # CLI: -d /path/to/tables -t vista_free                             │
│                                                                      │
│ # 4. 验证表结构                                                      │
│ ls /usr/share/ophcrack/tables/vista_free/                           │
│ # 应该包含 .bin, .idx 等文件                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: rcrack - memory allocation failed                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 系统内存不足以加载彩虹表                                             │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 检查可用内存                                                    │
│ free -h                                                              │
│                                                                      │
│ # 2. 关闭其他程序释放内存                                            │
│                                                                      │
│ # 3. 使用较小的表                                                    │
│                                                                      │
│ # 4. 增加交换空间（临时方案）                                        │
│ sudo fallocate -l 4G /swapfile                                      │
│ sudo chmod 600 /swapfile                                            │
│ sudo mkswap /swapfile                                               │
│ sudo swapon /swapfile                                               │
│                                                                      │
│ # 5. 分批处理哈希                                                    │
│ split -l 100 hashes.txt hash_batch_                                 │
│ for f in hash_batch_*; do                                           │
│     rcrack /path/to/tables/ -l "$f"                                 │
│ done                                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: Invalid hash format                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 哈希格式不正确或包含非法字符                                         │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 检查哈希格式                                                    │
│ cat -A hashes.txt  # 显示隐藏字符                                   │
│                                                                      │
│ # 2. 移除空行和空格                                                  │
│ sed -i '/^$/d' hashes.txt                                           │
│ sed -i 's/[[:space:]]//g' hashes.txt                                │
│                                                                      │
│ # 3. 转换行尾符                                                      │
│ dos2unix hashes.txt                                                  │
│                                                                      │
│ # 4. 验证哈希长度                                                    │
│ # MD5: 32 字符                                                       │
│ # SHA1: 40 字符                                                      │
│ # NTLM: 32 字符                                                      │
│ awk 'length != 32' hashes.txt  # 找出非 32 字符的行                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.3 生成相关错误

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: rtgen - disk space insufficient                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ 磁盘空间不足以存储生成的彩虹表                                       │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 检查磁盘空间                                                    │
│ df -h                                                                │
│                                                                      │
│ # 2. 估算所需空间                                                    │
│ # 链数量 × 16 字节 ≈ 表大小                                         │
│ # 例: 67108864 链 × 16 = 1 GB                                       │
│                                                                      │
│ # 3. 清理磁盘空间                                                    │
│ sudo apt clean                                                       │
│ rm -rf /tmp/*                                                        │
│                                                                      │
│ # 4. 使用外部存储                                                    │
│ # 将表生成到外部硬盘                                                 │
│ cd /mnt/external_drive                                               │
│ rtgen md5 loweralpha 1 7 0 2400 67108864 0                          │
│                                                                      │
│ # 5. 减少表大小                                                      │
│ # 减少链数量或密码长度范围                                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────┐
│ 错误: rtgen - 生成速度太慢                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因:                                                                │
│ CPU 性能不足或参数设置不当                                           │
│                                                                      │
│ 解决方案:                                                            │
│ # 1. 使用多线程版本                                                  │
│ # 某些版本支持 -t 参数指定线程数                                    │
│                                                                      │
│ # 2. 使用 GPU 加速版本                                               │
│ # rtgen_cuda (NVIDIA GPU)                                           │
│                                                                      │
│ # 3. 分布式生成                                                      │
│ # 在多台机器上并行生成不同分区                                       │
│                                                                      │
│ # 4. 优化参数                                                        │
│ # 增加链长度可减少链数量，但会增加查找时间                           │
│                                                                      │
│ # 5. 考虑下载现成的表                                                │
│ # 对于常见配置，下载比生成更快                                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.4 常见错误速查表

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| Table not sorted | 未排序 | 运行 rtsort |
| Algorithm mismatch | 算法不匹配 | 使用正确类型的表 |
| Plaintext not found | 不在覆盖范围 | 使用更大的表或其他方法 |
| No tables installed | 未安装表 | 下载并安装彩虹表 |
| Memory allocation failed | 内存不足 | 增加内存或分批处理 |
| Invalid hash format | 格式错误 | 清理哈希文件 |
| Disk space insufficient | 磁盘不足 | 清理空间或使用外部存储 |
| Hash is salted | 加盐哈希 | 使用 Hashcat 等工具 |
| Charset not found | 字符集未定义 | 检查 charset.txt |
| Table corrupted | 表文件损坏 | 重新下载或生成 |

### 10.5 调试技巧

```bash
# 1. 验证哈希类型
hashid 'your_hash'
haiti 'your_hash'

# 2. 检查表信息
# 从文件名解析
# md5_loweralpha#1-7_0_2400x67108864_0.rt
# 算法: md5
# 字符集: loweralpha (小写字母)
# 长度: 1-7
# 链长: 2400
# 链数: 67108864

# 3. 测试小规模破解
# 先用已知密码测试
echo -n "test" | md5sum
# 098f6bcd4621d373cade4e832627b4f6

echo "098f6bcd4621d373cade4e832627b4f6" > test_hash.txt
rcrack /path/to/tables/ -l test_hash.txt

# 4. 检查表完整性
ls -la /path/to/tables/
# 确认文件大小合理

# 5. 查看详细输出
rcrack /path/to/tables/ -h hash -v

# 6. 检查系统资源
htop
free -h
df -h
```

---

## 总结

彩虹表是一种经典的密码破解技术，虽然现代系统大多使用加盐哈希使其效果大减，但在特定场景下仍然非常有效。

**核心知识点**：

1. **原理理解**
   - 时间-空间权衡
   - 哈希链和归约函数
   - 为什么叫"彩虹"表

2. **工具使用**
   - RainbowCrack: 通用彩虹表工具
   - Ophcrack: Windows 密码专用
   - 在线服务: 快速查询

3. **实战技能**
   - 生成自定义彩虹表
   - 破解各类哈希
   - 参数优化

4. **防御知识**
   - 加盐的重要性
   - 慢速哈希算法
   - 密码策略

**适用场景**：
- Windows LM/NTLM 哈希（无盐）
- 旧系统的 MD5/SHA1 哈希
- 需要快速破解大量相同类型哈希

**不适用场景**：
- 加盐哈希（bcrypt, Argon2 等）
- 现代 Linux 密码
- 复杂或超长密码

---

> 📚 参考资料
> - [RainbowCrack 官网](http://project-rainbowcrack.com/)
> - [Ophcrack 官网](https://ophcrack.sourceforge.io/)
> - [Philippe Oechslin 原始论文](https://lasec.epfl.ch/~oechslin/publications/crypto03.pdf)
> - [OWASP 密码存储指南](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
> - [Have I Been Pwned](https://haveibeenpwned.com/)
